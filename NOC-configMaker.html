<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOC CONFIG MAKER TOOL</title>
    <style>
        :root {
            --bg-color: #f4f4f4;
            --text-color: #333;
            --container-bg: white;
            --border-color: #ddd;
            --input-bg: white;
            --button-bg: #d35400;
            --button-hover: #e67e22;
            --output-bg: #f8f8f8;
            --sidebar-bg: #2c3e50;
            --sidebar-active: #e67e22;
            --sidebar-hover: #34495e;
        }
        :root[data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #eee;
            --container-bg: #2a2a2a;
            --border-color: #444;
            --input-bg: #3a3a3a;
            --button-bg: #e67e22;
            --button-hover: #d35400;
            --output-bg: #333;
            --sidebar-bg: #1a1a1a;
            --sidebar-active: #e67e22;
            --sidebar-hover: #2a2a2a;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body { 
            font-family: Arial, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            margin: 0; 
            padding: 0; 
            transition: all 0.3s ease;
        }
        .main-container {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 280px;
            background: var(--sidebar-bg);
            color: white;
            padding: 20px;
            overflow-y: auto;
            transition: all 0.3s ease;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
        }
        .sidebar-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--sidebar-active);
        }
        .sidebar-header h1 {
            font-size: 20px;
            color: var(--sidebar-active);
            margin-bottom: 5px;
            text-align: left;
        }
        .sidebar-header p {
            font-size: 12px;
            color: #bbb;
            margin-top: 8px;
        }
        .nav-tabs {
            list-style: none;
        }
        .nav-tab {
            margin-bottom: 10px;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        .nav-tab:hover {
            background: var(--sidebar-hover);
            border-left-color: var(--sidebar-active);
        }
        .nav-tab.active {
            background: var(--sidebar-active);
            border-left-color: white;
        }
        .nav-tab-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .nav-tab-desc {
            font-size: 11px;
            color: #ccc;
        }
        .nav-tab.active .nav-tab-desc {
            color: white;
        }
        .content-area {
            flex: 1;
            margin-left: 280px;
            overflow-y: auto;
            padding: 30px;
            background: var(--bg-color);
        }
        .content-pane {
            display: none;
        }
        .content-pane.active {
            display: block;
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: var(--container-bg); 
            padding: 30px; 
            border-radius: 8px; 
            box-shadow: 0 0 20px rgba(0,0,0,0.1); 
            transition: all 0.3s ease;
        }
        .testing-banner {
            background: #fff3cd;
            color: #856404;
            padding: 12px;
            text-align: center;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        [data-theme="dark"] .testing-banner {
            background: #856404;
            color: #fff3cd;
        }
        .enterprise-testing-banner {
            background: #d1ecf1;
            color: #0c5460;
            padding: 12px;
            text-align: center;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        [data-theme="dark"] .enterprise-testing-banner {
            background: #0c5460;
            color: #d1ecf1;
        }
        h1 { color: var(--button-bg); text-align: center; }
        h3 {
            color: var(--text-color);
            margin: 20px 0 15px 0;
        }
        h2 { color: var(--text-color); border-bottom: 2px solid var(--border-color); padding-bottom: 5px; }
        .section { 
            margin-bottom: 20px; 
            padding: 15px; 
            border: 1px solid var(--border-color); 
            border-radius: 5px; 
            transition: all 0.3s ease;
        }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--text-color); }
        input, select, textarea { 
            width: 100%; 
            padding: 8px; 
            margin-bottom: 10px; 
            border: 1px solid var(--border-color); 
            border-radius: 4px; 
            box-sizing: border-box; 
            background: var(--input-bg); 
            color: var(--text-color);
            transition: all 0.3s ease;
        }
        button { 
            background-color: var(--button-bg); 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 16px; 
            margin-right: 10px; margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        button:hover:not(:disabled) { background-color: var(--button-hover); }
        button:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.6; }
        #output { 
            background-color: var(--output-bg); 
            color: var(--text-color);
            padding: 15px; 
            border: 1px solid var(--border-color); 
            border-radius: 4px; 
            white-space: pre-wrap; 
            font-family: monospace; 
            min-height: 300px; width: 100%;
            transition: all 0.3s ease;
        }
        .features { display: flex; gap: 10px; flex-wrap: wrap; }
        .interface-item, .uplink-item, .switch-item, .ip-item, .vlan-item, .vpls-item, .customer-item { border: 1px solid var(--border-color); padding: 10px; border-radius: 4px; margin-bottom: 10px; }
        .interface-grid, .uplink-grid, .switch-grid, .ip-grid, .vlan-grid, .vpls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .customer-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .dhcp-section { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .device-selection-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .toggle-dark { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        select { cursor: pointer; }
        .interface-buttons, .uplink-buttons, .switch-buttons, .ip-buttons, .vlan-buttons, .vpls-buttons, .customer-buttons { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
        .remove-btn { background: #dc3545; padding: 5px 10px; font-size: 12px; }
        textarea { resize: vertical; }
        .generate-section { text-align: center; margin: 20px 0; }
        #generateBtn { 
            background: #FF9800; 
            color: white; 
            border: none; 
            padding: 15px 30px; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: bold;
            z-index: 1000;
            position: relative;
        }
        #generateBtn:hover { background: #F57C00; }
        #generateBtn:active { background: #E65100; }
        #upgradeBtn:hover:not(:disabled) { background: #F57C00; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        #upgradeBtn:active:not(:disabled) { background: #E65100; transform: translateY(0); }
        .pool-grid { display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 10px; align-items: end; }
        .mpls-section { display: none; }
        .vpls-section { display: none; }
        .dhcp-note {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
            text-align: center;
        }
        .hint {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        [data-theme="dark"] .hint {
            color: #aaa;
        }
        [data-theme="dark"] .dhcp-note {
            background: #155724;
            color: #d4edda;
        }
    </style>
</head>
<body>
    <button class="toggle-dark" id="darkToggle">Toggle Light Mode</button>
    
    <div class="main-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>NOC CONFIG MAKER TOOL</h1>
                <p>Unified MikroTik Configuration Generator</p>
            </div>
            
            <ul class="nav-tabs">
                <li class="nav-tab active" data-tab="tower">
                    <div class="nav-tab-title">üóº TOWER MIKROTIK CONFIG MAKER</div>
                    <div class="nav-tab-desc">Full BGP/OSPF/MPLS for tower sites</div>
                </li>
                <li class="nav-tab" data-tab="enterprise">
                    <div class="nav-tab-title">üè¢ Non MPLS ENTERPRISE CONFIG MAKER</div>
                    <div class="nav-tab-desc">Simplified configs for enterprise customers (no MPLS)</div>
                </li>
                <li class="nav-tab" data-tab="enterprise-mpls">
                    <div class="nav-tab-title">üè¢ MPLS ENTERPRISE CONFIG MAKER</div>
                    <div class="nav-tab-desc">Enterprise configs with MPLS/OSPF/BGP support</div>
                </li>
                <li class="nav-tab" data-tab="ccr2004">
                    <div class="nav-tab-title">üîó CCR2004 VLAN CONFIG</div>
                    <div class="nav-tab-desc">VLAN 3000/4000 configuration for CCR2004</div>
                </li>
                <li class="nav-tab" data-tab="tarana">
                    <div class="nav-tab-title">üì° TARANA SECTORS</div>
                    <div class="nav-tab-desc">ALPHA/BETA/GAMMA/DELTA sector configuration</div>
                </li>
                <li class="nav-tab" data-tab="enterprise-feeding">
                    <div class="nav-tab-title">üåê ENTERPRISE FEEDING SIDE</div>
                    <div class="nav-tab-desc">Commercial/enterprise uplink provisioning</div>
                </li>
                <li class="nav-tab" data-tab="ai-chat">
                    <div class="nav-tab-title">ü§ñ AI CHAT</div>
                    <div class="nav-tab-desc">Ask questions and get RouterOS answers</div>
                </li>
            </ul>
        </div>
        <!-- Content Area -->
        <div class="content-area">
            <!-- TOWER CONFIG TAB -->
            <div class="content-pane active" id="tower-pane">
                <div class="container">
                    <div class="testing-banner">üß™ TESTING VERSION - Tower Config (BGP/OSPF/MPLS) - Functionality in Progress (NOC Ops)</div>
                    <h1>Tower MikroTik Configuration Generator</h1>
                    <p style="text-align: center; color: var(--text-color);">Dynamic tool for tower sites: Fill site-specific details. Generates full .rsc for direct /import. BGP/OSPF/MPLS always (shared key).</p>

                    <!-- Mode Selection -->
                    <div class="section" style="background: #f8f9fa; border-left: 4px solid #FF9800; padding: 20px;">
                        <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px 20px; background: white; border: 2px solid #FF9800; border-radius: 6px; flex: 1;">
                                <input type="radio" name="configMode" value="new" checked onchange="switchMode('new')">
                                <span style="font-weight: bold;">üìù New Device</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 12px 20px; background: white; border: 2px solid #ddd; border-radius: 6px; flex: 1;">
                                <input type="radio" name="configMode" value="upgrade" onchange="switchMode('upgrade')">
                                <span style="font-weight: bold;">üîÑ Upgrade Existing</span>
                            </label>
                        </div>
                        
                        <!-- NEW MODE HINT -->
                        <div id="newModeHint" style="padding: 12px; background: #e8f5e9; border-radius: 4px; font-size: 14px;">
                            ‚úÖ <strong>New Device:</strong> Fill form below, click Generate. Nextlink defaults will be auto-loaded.
                        </div>
                        
                        <!-- UPGRADE MODE: Drag & Drop -->
                        <div id="upgradeMode" style="display: none;">
                            <div id="dropZone" style="border: 3px dashed #ccc; border-radius: 8px; padding: 40px; text-align: center; background: white; cursor: pointer; transition: all 0.3s;">
                                <div style="font-size: 48px; margin-bottom: 10px;">üìÅ</div>
                                <div style="font-size: 16px; font-weight: bold; margin-bottom: 8px;">Drag & Drop Config File</div>
                                <div style="font-size: 13px; color: #666; margin-bottom: 15px;">or click to browse (.rsc or .txt)</div>
                                <input type="file" id="fileInput" accept=".rsc,.txt" style="display: none;">
                                <button onclick="document.getElementById('fileInput').click()" style="background: #FF9800; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
                                    Browse Files
                                </button>
                                <div style="font-size: 12px; color: #999; margin-top: 10px;">From old device: /export file=backup.rsc</div>
                            </div>
                            
                            <div id="uploadedFileName" style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 4px; display: none;">
                                <strong>üìÑ Loaded:</strong> <span id="fileName"></span>
                            </div>
                            
                            <!-- Target Device Selection (only for upgrade) -->
                            <div id="upgradeTargetSelection" style="margin-top: 15px; padding: 15px; background: white; border-radius: 6px; display: none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div>
                                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">Target Device:</label>
                                        <select id="upgradeTargetDevice" style="width: 100%; padding: 8px;">
                                            <option value="ccr2004">CCR2004</option>
                                            <option value="ccr2216">CCR2216</option>
                                            <option value="ccr2116">CCR2116</option>
                                            <option value="ccr1072">CCR1072</option>
                                            <option value="rb5009">RB5009</option>
                                            <option value="ccr1036">CCR1036</option>
                                            <option value="rb2011">RB2011</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="font-weight: bold; display: block; margin-bottom: 5px;">Target RouterOS:</label>
                                        <select id="upgradeTargetVersion" style="width: 100%; padding: 8px;">
                                            <option value="7.16.2">7.16.2 (Stable)</option>
                                            <option value="7.19.4">7.19.4 (Latest)</option>
                                            <option value="7.11.2">7.11.2</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Upgrade Button -->
                                <button id="upgradeBtn" onclick="performUpgrade()" style="width: 100%; background: #FF9800; color: white; padding: 15px; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                                    üöÄ Start Upgrade
                                </button>
                            </div>
                            
                            <div id="upgradeStatus" style="margin-top: 15px; padding: 12px; border-radius: 4px; display: none;"></div>
                            
                            <!-- UPGRADE OUTPUT SECTION -->
                            <div id="upgradeOutputSection" style="margin-top: 20px; display: none;">
                                <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; border: 2px solid #4CAF50;">
                                    <h3 style="color: #4CAF50; margin-bottom: 15px;">‚úÖ Translated Configuration</h3>
                                    <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                                        <button id="upgradeCopyBtn" style="background: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
                                            üìã Copy to Clipboard
                                        </button>
                                        <button id="upgradeDownloadBtn" style="background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
                                            üíæ Download .rsc File
                                        </button>
                                    </div>
                                    <textarea id="upgradeOutput" readonly style="width: 100%; min-height: 500px; padding: 15px; border: 1px solid #555; border-radius: 4px; background: #2a2a2a; color: #e0e0e0; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.5; white-space: pre; overflow-x: auto; word-wrap: normal;" spellcheck="false"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Main Form (hidden during upgrade) -->
                    <div id="mainForm">
        <div class="section">
            <h2>Site Information</h2>
            <label for="siteName">Site Name (e.g., HALLETTSVILLE-NW-1):</label>
            <input type="text" id="siteName" placeholder="HALLETTSVILLE-NW-1">
            <label for="routerId">Router ID/Loopback IP (e.g., 10.25.0.46):</label>
            <input type="text" id="routerId" placeholder="10.25.0.46">
            <label for="systemName">System Identity (auto-fills):</label>
            <input type="text" id="systemName" placeholder="RTR-MTCCR2004-1">
            <div id="lanBridgeSection">
                <label for="lanBridgeIP">LAN Bridge IP/Net (e.g., 10.45.40.1/22):</label>
                <input type="text" id="lanBridgeIP" placeholder="10.45.40.1/22">
            </div>
            <div id="natPublicSection">
                <label for="natPublicIP">NAT Public IP (e.g., 142.147.123.163):</label>
                <input type="text" id="natPublicIP" placeholder="142.147.123.163">
            </div>
            <div class="form-group">
                <label for="siteLatitude">Site Latitude (e.g., 29.08256):</label>
                <input type="text" id="siteLatitude" placeholder="29.08256">
            </div>
            <div class="form-group">
                <label for="siteLongitude">Site Longitude (e.g., -96.72243):</label>
                <input type="text" id="siteLongitude" placeholder="-96.72243">
            </div>
        </div>

        <!-- ===== Simple AI Chat Panel ===== -->
        <div class="content-pane" id="ai-chat-pane" style="display:none;">
            <div class="container">
                <h1>AI Assistant Chat</h1>
                <div style="display:grid; grid-template-columns: 1fr; gap: 10px;">
                    <div id="chatLog" style="height: 360px; overflow:auto; background: var(--output-bg); color: var(--text-color); padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-family: monospace; white-space: pre-wrap;"></div>
                    <div style="display:flex; gap:8px;">
                        <input id="chatInput" type="text" placeholder="Ask anything about RouterOS, migrations, standards..." style="flex:1; padding:10px; border:1px solid var(--border-color); border-radius:6px; background:var(--input-bg); color:var(--text-color);">
                        <button id="chatSendBtn" style="background:#4CAF50; color:white; padding:10px 16px; border:none; border-radius:6px; cursor:pointer;">Send</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="section">
            <h2>Configuration Type & Device Selection</h2>
            <div class="form-group">
                <label for="configType">Configuration Type:</label>
                <select id="configType">
                    <option value="in-state">In-State (Full BGP/OSPF)</option>
                    <option value="out-of-state">Out-of-State (OSPF/MPLS/VPLS)</option>
                    <option value="legacy-simple">Legacy Simple Bridge/DHCP</option>
                </select>
            </div>
            <div class="device-selection-grid">
                <div>
                    <label for="currentDevice">Current Device:</label>
                    <select id="currentDevice">
                        <option value="">Select Current Device</option>
                        <option value="rb1009">RB1009 (RouterOS 6.x/7.x)</option>
                        <option value="rb2011">RB2011 (RouterOS 6.x/7.x)</option>
                        <option value="ccr1036">CCR1036 (RouterOS 6.x/7.x)</option>
                        <option value="ccr1072">CCR1072 (RouterOS 6.x/7.x)</option>
                        <option value="rb5009">RB5009 (RouterOS 7.x)</option>
                        <option value="ccr2004">CCR2004 (RouterOS 7.x)</option>
                        <option value="ccr2116">CCR2116 (RouterOS 7.x)</option>
                        <option value="ccr2216">CCR2216 (RouterOS 7.x)</option>
                    </select>
                </div>
                <div>
                    <label for="targetDevice">Target Device (Upgrade To):</label>
                    <select id="targetDevice">
                        <option value="">Select Target Device</option>
                        <option value="rb1009">RB1009</option>
                        <option value="rb2011">RB2011</option>
                        <option value="ccr1036">CCR1036</option>
                        <option value="ccr1072">CCR1072</option>
                        <option value="rb5009">RB5009</option>
                        <option value="ccr2004">CCR2004</option>
                        <option value="ccr2116">CCR2116</option>
                        <option value="ccr2216">CCR2216</option>
                    </select>
                </div>
                <div>
                    <label for="currentRouterOS">Current RouterOS Version:</label>
                    <select id="currentRouterOS">
                        <option value="">Select Version</option>
                        <option value="6.45.2">6.45.2 (Legacy Speed Syntax)</option>
                        <option value="6.49.2">6.49.2 (Legacy Speed Syntax)</option>
                        <option value="7.11.2">7.11.2 (Legacy Speed Syntax)</option>
                        <option value="7.16.2">7.16.2 (New Speed Syntax)</option>
                        <option value="7.19.4">7.19.4 (New Speed Syntax)</option>
                    </select>
                </div>
                <div>
                    <label for="targetRouterOS">Target RouterOS Version:</label>
                    <select id="targetRouterOS">
                        <option value="">Select Version</option>
                        <option value="6.45.2">6.45.2 (Legacy Speed Syntax)</option>
                        <option value="6.49.2">6.49.2 (Legacy Speed Syntax)</option>
                        <option value="7.11.2">7.11.2 (Legacy Speed Syntax)</option>
                        <option value="7.16.2">7.16.2 (New Speed Syntax)</option>
                        <option value="7.19.4">7.19.4 (New Speed Syntax)</option>
                    </select>
                </div>
            </div>
            <div style="background: #2a4a2a; padding: 10px; border-radius: 5px; margin-top: 15px;">
                <strong>Device-Specific Features:</strong>
                <ul style="margin: 5px 0; padding-left: 20px;">
                    <li><strong>RB1009:</strong> 9x Gigabit ethernet, basic routing</li>
                    <li><strong>RB2011:</strong> 10x Gigabit ethernet + 1x SFP, basic routing</li>
                    <li><strong>CCR1036:</strong> 36-core CPU, 12x Gigabit ethernet + 4x SFP</li>
                    <li><strong>CCR1072:</strong> 72-core CPU, 12x Gigabit ethernet + 4x SFP</li>
                    <li><strong>RB5009:</strong> ARM-based, 13x Gigabit ethernet + 2x 10G SFP+</li>
                    <li><strong>CCR2004:</strong> 4-core ARM, 1x Gigabit ethernet + 12x SFP+</li>
                    <li><strong>CCR2116:</strong> 16-core ARM, 12x Gigabit ethernet + 4x SFP+</li>
                    <li><strong>CCR2216:</strong> 16-core ARM, 1x Gigabit ethernet + 8x QSFP28 + 12x SFP28</li>
                </ul>
            </div>
        </div>
        <div class="section">
            <h2>Routing (OSPF/BGP - Uses Router ID)</h2>
            <label for="ospfArea">OSPF Area:</label>
            <select id="ospfArea">
                <option value="backbone-v2">backbone-v2 (BGP + OSPF)</option>
                <option value="backbone-v2-IL">backbone-v2 IL (MPLS/VPLS)</option>
                <option value="area243-v2">area243-v2 (MPLS/VPLS)</option>
                <option value="area248-v2">area248-v2 (MPLS/VPLS)</option>
                <option value="area249">area249 (MPLS/VPLS)</option>
                <option value="area250">area250 (MPLS/VPLS)</option>
                <option value="area42-v2">area42-v2 (MPLS/VPLS)</option>
                <option value="area42">area42 (MPLS/VPLS)</option>
                <option value="custom">Custom Area</option>
            </select>
            <input type="text" id="ospfAreaCustom" style="display:none;" placeholder="Enter custom area name">
            <label for="ospfAreaId">OSPF Area ID (auto-filled):</label>
            <input type="text" id="ospfAreaId" value="0.0.0.0" readonly>
            <div id="bgpSection">
                <label for="bgpPeers">BGP Peers JSON (e.g., [{"name":"CR7","remote":"10.2.0.107/32"}]):</label>
                <textarea id="bgpPeers" rows="3">[{"name":"CR7","remote":"10.2.0.107/32"},{"name":"CR8","remote":"10.2.0.108/32"}]</textarea>
                <label for="bgpAS">BGP Local AS (e.g., 26077):</label>
                <input type="text" id="bgpAS" value="26077">
            </div>
        </div>

        <div class="section">
            <h2>Optional Features</h2>
            <div class="features">
                <label><input type="checkbox" id="enableTarana"> Enable Tarana Ports</label>
                <label><input type="checkbox" id="enableSWT"> Enable SWT (VLAN 4000)</label>
                <label><input type="checkbox" id="enableVPLS"> Enable VPLS Tunnels</label>
                <label><input type="checkbox" id="enableMPLS"> Enable MPLS/LDP</label>
                <label><input type="checkbox" id="enableDHCP"> Enable DHCP Server (backbone-v2 only)</label>
            </div>
            <div id="vlanSection" class="dhcp-section" style="display:none;">
                <div>
                    <label for="vlan3000Subnet">VLAN 3000 Subnet (Tarana, CIDR e.g., 10.25.34.0/28):</label>
                    <input type="text" id="vlan3000Subnet">
                </div>
                <div>
                    <label for="vlan4000Subnet">VLAN 4000 Subnet (SWT, CIDR e.g., 10.10.9.0/22):</label>
                    <input type="text" id="vlan4000Subnet">
                </div>
            </div>
            <div id="taranaSection" class="dhcp-section" style="display:none;">
                <div style="background: #2a4a2a; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                    <h3 style="margin-top: 0; color: #4CAF50;">Tarana Sector Configuration Generator</h3>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px; align-items:start;">
                        <div>
                            <label for="tower_tarana_alpha">ALPHA Port:</label>
                            <select id="tower_tarana_alpha">
                                <option value="sfp-sfpplus6">sfp-sfpplus6</option>
                                <option value="sfp-sfpplus7">sfp-sfpplus7</option>
                                <option value="sfp-sfpplus8">sfp-sfpplus8</option>
                                <option value="sfp-sfpplus9">sfp-sfpplus9</option>
                            </select>
                            <div style="margin-top:6px; display:flex; gap:6px;">
                                <select id="tower_tarana_alpha_speed" style="width:60%;">
                                    <option value="10G-baseCR">10G-baseCR</option>
                                    <option value="10G-baseSR-LR">10G-baseSR/LR</option>
                                    <option value="1G-baseT-full">1G-baseT-full</option>
                                    <option value="auto">Auto-Negotiate</option>
                                </select>
                                <input type="number" id="tower_tarana_alpha_mtu" placeholder="MTU" min="1500" value="1500" style="width:40%;">
                            </div>
                        </div>
                        <div>
                            <label for="tower_tarana_beta">BETA Port:</label>
                            <select id="tower_tarana_beta">
                                <option value="sfp-sfpplus6">sfp-sfpplus6</option>
                                <option value="sfp-sfpplus7">sfp-sfpplus7</option>
                                <option value="sfp-sfpplus8">sfp-sfpplus8</option>
                                <option value="sfp-sfpplus9">sfp-sfpplus9</option>
                            </select>
                            <div style="margin-top:6px; display:flex; gap:6px;">
                                <select id="tower_tarana_beta_speed" style="width:60%;">
                                    <option value="10G-baseCR">10G-baseCR</option>
                                    <option value="10G-baseSR-LR">10G-baseSR/LR</option>
                                    <option value="1G-baseT-full">1G-baseT-full</option>
                                    <option value="auto">Auto-Negotiate</option>
                                </select>
                                <input type="number" id="tower_tarana_beta_mtu" placeholder="MTU" min="1500" value="1500" style="width:40%;">
                            </div>
                        </div>
                        <div>
                            <label for="tower_tarana_gamma">GAMMA Port:</label>
                            <select id="tower_tarana_gamma">
                                <option value="sfp-sfpplus6">sfp-sfpplus6</option>
                                <option value="sfp-sfpplus7">sfp-sfpplus7</option>
                                <option value="sfp-sfpplus8">sfp-sfpplus8</option>
                                <option value="sfp-sfpplus9">sfp-sfpplus9</option>
                            </select>
                            <div style="margin-top:6px; display:flex; gap:6px;">
                                <select id="tower_tarana_gamma_speed" style="width:60%;">
                                    <option value="10G-baseCR">10G-baseCR</option>
                                    <option value="10G-baseSR-LR">10G-baseSR/LR</option>
                                    <option value="1G-baseT-full">1G-baseT-full</option>
                                    <option value="auto">Auto-Negotiate</option>
                                </select>
                                <input type="number" id="tower_tarana_gamma_mtu" placeholder="MTU" min="1500" value="1500" style="width:40%;">
                            </div>
                        </div>
                        <div>
                            <label for="tower_tarana_delta">DELTA Port (optional):</label>
                            <select id="tower_tarana_delta">
                                <option value="">None</option>
                                <option value="sfp-sfpplus6">sfp-sfpplus6</option>
                                <option value="sfp-sfpplus7">sfp-sfpplus7</option>
                                <option value="sfp-sfpplus8">sfp-sfpplus8</option>
                                <option value="sfp-sfpplus9">sfp-sfpplus9</option>
                            </select>
                            <div style="margin-top:6px; display:flex; gap:6px;">
                                <select id="tower_tarana_delta_speed" style="width:60%;">
                                    <option value="10G-baseCR">10G-baseCR</option>
                                    <option value="10G-baseSR-LR">10G-baseSR/LR</option>
                                    <option value="1G-baseT-full">1G-baseT-full</option>
                                    <option value="auto">Auto-Negotiate</option>
                                </select>
                                <input type="number" id="tower_tarana_delta_mtu" placeholder="MTU" min="1500" value="1500" style="width:40%;">
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <label for="tower_unicornmgmt_subnet">UNICORNMGMT (bridge3000) Subnet (CIDR):</label>
                        <input type="text" id="tower_unicornmgmt_subnet" placeholder="e.g., 10.246.25.48/29" style="width: 50%;">
                        <div style="font-size: 12px; color: #ddd; margin-top: 6px;">Router IP = first usable in the subnet.</div>
                    </div>

                    <div style="display:flex; gap:10px; margin-top:8px;">
                        <div style="font-size:12px; color:#ddd; align-self:center;">(Tarana fragment included automatically in the full generated config when 'Enable Tarana Ports' is checked)</div>
                    </div>
                </div>

                <div style="color: var(--text-color); font-size: 14px; margin-top: 10px;">
                    <strong>Note:</strong> This generator creates the bridge, ethernet sets, VLAN interfaces (1000/2000/3000), bridge-port mappings and a management IP on UNICORNMGMT plus a basic OSPF interface-template entry.
                </div>

                <!-- preview removed: Tarana fragment generated automatically with full config -->
            </div>
        </div>
        <div class="section dhcp-section" id="dhcpSection" style="display:none;">
            <h2>DHCP Configuration (backbone-v2 BGP/OSPF Areas Only)</h2>
            <div class="dhcp-note">
                <strong>Note:</strong> DHCP is only used in backbone-v2 areas with BGP/OSPF. Other areas (MPLS/VPLS) use BNGs for subscriber management.
            </div>
            <div class="dhcp-section" style="margin-bottom: 15px;">
                <div>
                    <label for="cgnatRange">CGNAT Private Range (100.x.x.x/22, e.g., 100.64.112.0/22):</label>
                    <input type="text" id="cgnatRange" placeholder="100.64.112.0/22">
                </div>
                <div>
                    <label for="cpeRange">CPE Range (10.x.x.x/22, auto-calculated from LAN Bridge):</label>
                    <input type="text" id="cpeRange" readonly placeholder="Auto-filled from LAN Bridge IP">
                </div>
            </div>
            <div class="dhcp-section">
                <div>
                    <label for="unauthRange">Unauth Range (10.1xx.x.x/22, auto-calculated):</label>
                    <input type="text" id="unauthRange" readonly placeholder="Auto-calculated from CPE range">
                </div>
                <div>
                    <label for="vlan4000Range">VLAN 4000 Range (if SWT enabled, auto-calculated):</label>
                    <input type="text" id="vlan4000Range" readonly placeholder="Auto-calculated from VLAN 4000 subnet">
                </div>
            </div>
        </div>

        <div class="section vpls-section">
            <h2>VPLS Configuration</h2>
            <p>Configure VPLS tunnels for BNG connectivity.</p>
            <div id="vplsInstances">
                <div class="vpls-item" style="display:none;" id="vplsTemplate">
                    <div class="vpls-grid">
                        <div><label for="vpls2Name">VPLS Name:</label><input type="text" name="vplsName" id="vpls2Name"></div>
                        <div><label for="vpls2Bridge">Bridge:</label><input type="text" name="vplsBridge" id="vpls2Bridge"></div>
                        <div><label for="vpls2Peer">Peer IP:</label><input type="text" name="vplsPeer" id="vpls2Peer"></div>
                        <div><label for="vpls2StaticId">Cisco Static ID:</label><input type="number" name="vplsStaticId" id="vpls2StaticId"></div>
                    </div>
                    <button class="remove-btn" onclick="this.closest('.vpls-item').remove(); updateVplsCount();">Remove</button>
                </div>
            </div>
            <div class="vpls-buttons">
                <button id="addVplsBtn">Add VPLS Instance</button>
            </div>
        </div>

        <div class="section">
            <h2>Port Configuration</h2>
            <p>Configure individual ethernet port settings including speed, bridge assignment, and advanced parameters.</p>
            <div id="portConfigs">
                <div class="uplink-item" style="display:none;" id="portTemplate">
                    <div class="uplink-grid">
                        <div><label for="port2Name">Port Name:</label><select name="portName" id="port2Name">
                            <option value="sfp-sfpplus1">sfp-sfpplus1</option>
                            <option value="sfp-sfpplus2">sfp-sfpplus2</option>
                            <option value="sfp-sfpplus3">sfp-sfpplus3</option>
                            <option value="sfp-sfpplus4">sfp-sfpplus4</option>
                            <option value="sfp-sfpplus5">sfp-sfpplus5</option>
                            <option value="sfp-sfpplus6">sfp-sfpplus6</option>
                            <option value="sfp-sfpplus7">sfp-sfpplus7</option>
                            <option value="sfp-sfpplus8">sfp-sfpplus8</option>
                            <option value="sfp-sfpplus9">sfp-sfpplus9</option>
                            <option value="sfp-sfpplus10">sfp-sfpplus10</option>
                            <option value="sfp-sfpplus11">sfp-sfpplus11</option>
                            <option value="sfp-sfpplus12">sfp-sfpplus12</option>
                            <option value="sfp28-1">sfp28-1</option>
                            <option value="sfp28-2">sfp28-2</option>
                        </select></div>
                        <div><label for="port2Speed">Speed:</label><select name="portSpeed" id="port2Speed">
                           <option value="auto">Auto-Negotiate</option>
                           <option value="1Gbps">1Gbps</option>
                           <option value="10Gbps">10Gbps</option>
                           <option value="1G-baseT-full">1G-baseT-full</option>
                           <option value="1G-baseX">1G-baseX</option>
                           <option value="10G-baseSR-LR">10G-baseSR/LR</option>
                           <option value="10G-baseCR">10G-baseCR</option>
                        </select></div>
                        <div><label for="port2Comment">Comment:</label><input type="text" name="portComment" id="port2Comment"></div>
                        <div><label for="port2Bridge">Bridge (optional):</label><select name="portBridge" id="port2Bridge">
                            <option value="">None (Routed)</option>
                            <option value="lan-bridge">lan-bridge</option>
                            <option value="bridge1000">bridge1000</option>
                            <option value="bridge2000">bridge2000</option>
                            <option value="bridge3000">bridge3000</option>
                            <option value="bridge4000">bridge4000</option>
                            <option value="nat-public-bridge">nat-public-bridge</option>
                        </select></div>
                        <div><label for="port2Mtu">MTU (optional):</label><input type="number" name="portMtu" id="port2Mtu" placeholder="1500" min="1500" max="9000"></div>
                        <div><label for="port2L2Mtu">L2MTU (optional):</label><input type="number" name="portL2Mtu" id="port2L2Mtu" placeholder="1598" min="1500" max="9000"></div>
                    </div>
                    <button class="remove-btn">Remove</button>
                </div>
            </div>
            <div class="uplink-buttons">
                <button id="addPortBtn">Add Port Configuration</button>
                <button type="button" id="btnAutoPopulateNetonix">Auto-populate Netonix Uplinks (1,2 @ 1Gbps)</button>
            </div>
            <div style="margin-top: 15px;" class="dhcp-note">
                <strong>Note:</strong> Unused SFP ports will be automatically disabled for security.
            </div>
        </div>

        <div class="section">
            <h2>VLAN Interfaces</h2>
            <p>Create VLAN interfaces on physical interfaces.</p>
            <div class="dhcp-section" style="margin-bottom: 15px;">
                <div>
                    <label for="vlanProfile">VLAN Profile:</label>
                    <select id="vlanProfile">
                        <option value="">Custom</option>
                        <option value="nonvpls">Non-VPLS (1000‚Üílan-bridge, 2000,3000,4000)</option>
                        <option value="vpls">VPLS Standard (1000,2000,3000,4000)</option>
                    </select>
                </div>
                <div style="display: flex; align-items: end;">
                    <button type="button" id="btnPopulateVlans">Auto-populate VLANs</button>
                </div>
            </div>
            <div id="vlanInterfaces">
                <div class="vlan-item" style="display:none;" id="vlanTemplate">
                    <div class="vlan-grid">
                        <div><label for="vlan2Parent">Parent Interface:</label><select name="vlanParent" id="vlan2Parent">
                            <option value="sfp-sfpplus1">sfp-sfpplus1</option>
                            <option value="sfp-sfpplus2">sfp-sfpplus2</option>
                            <option value="sfp-sfpplus6">sfp-sfpplus6</option>
                            <option value="sfp-sfpplus8">sfp-sfpplus8</option>
                            <option value="sfp-sfpplus9">sfp-sfpplus9</option>
                            <option value="sfp-sfpplus10">sfp-sfpplus10</option>
                            <option value="bonding1">bonding1</option>
                        </select></div>
                        <div><label for="vlan2Id">VLAN ID:</label><input type="number" name="vlanId" id="vlan2Id" min="1" max="4094"></div>
                        <div><label for="vlan2Comment">Comment:</label><input type="text" name="vlanComment" id="vlan2Comment"></div>
                        <div><label for="vlan2Bridge">Bridge Assignment:</label><input type="text" name="vlanBridge" id="vlan2Bridge"></div>
                    </div>
                    <button class="remove-btn" onclick="this.closest('.vlan-item').remove(); updateVlanCount();">Remove</button>
                </div>
            </div>
            <div class="uplink-buttons">
                <button id="addVlanBtn">Add VLAN Interface</button>
            </div>
        </div>

        <div class="section mpls-section">
            <h2>MPLS/LDP Configuration</h2>
            <label for="mplsMtu">MPLS MTU (default 9000):</label>
            <input type="number" id="mplsMtu" value="9000" min="1500" max="9000">
            <label for="ldpTransport">LDP Transport Address (usually Router ID):</label>
            <input type="text" id="ldpTransport" value="10.25.0.46">
        </div>

        <div class="section">
            <h2>Backhaul Uplinks (IPs auto to ports/OSPF)</h2>
            <p id="uplinksDescription">Up to 4; generates ethernet sets, /ip address, OSPF templates (ptp type). Uses sfp4+ downwards.</p>
            <div style="background: #2a4a2a; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                <strong>Auto-Configuration:</strong> When you add uplinks here, the tool will automatically:
                <ul style="margin: 5px 0; padding-left: 20px;">
                    <li>Assign IP addresses to the ports</li>
                    <li>Configure OSPF interface templates with proper authentication</li>
                    <li>Include in MPLS LDP configuration (if MPLS enabled)</li>
                </ul>
                <strong>Note:</strong> Interface speed and comments are configured in the "Port Configuration" section below to avoid duplication.
            </div>
            <div id="uplinks">
                <div class="uplink-item" id="uplink1">
                    <div class="uplink-grid">
                        <div>
                            <label for="uplink1NewPort" id="uplink1NewPortLabel">New Port:</label>
                            <select id="uplink1NewPort">
                                <option value="sfp-sfpplus4">sfp-sfpplus4</option><option value="sfp-sfpplus5">sfp-sfpplus5</option><option value="sfp-sfpplus6">sfp-sfpplus6</option><option value="sfp-sfpplus7">sfp-sfpplus7</option>
                                <option value="sfp-sfpplus8">sfp-sfpplus8</option><option value="sfp-sfpplus9">sfp-sfpplus9</option><option value="sfp-sfpplus10">sfp-sfpplus10</option><option value="sfp-sfpplus11">sfp-sfpplus11</option>
                                <option value="sfp-sfpplus12">sfp-sfpplus12</option><option value="sfp28-1">sfp28-1</option><option value="sfp28-2">sfp28-2</option><option value="ether1">ether1 (Mgmt)</option>
                            </select>
                        </div>
                        <div>
                            <label for="uplink1Ip">Backhaul IP/Net (e.g., 10.36.1.53/30):</label>
                            <input type="text" id="uplink1Ip" placeholder="10.36.1.53/30">
                        </div>
                        <div>
                            <label for="uplink1Comment">Comment (e.g., TX-LAGRANGE-FC-1):</label>
                            <input type="text" id="uplink1Comment" placeholder="TX-LAGRANGE-FC-1">
                        </div>
                        <div>
                            <label for="uplink1Cost">OSPF Cost (default 10):</label>
                            <input type="number" id="uplink1Cost" placeholder="10" min="1">
                        </div>
                    </div>
                </div>
                <div class="uplink-item" style="display:none;" id="uplinkTemplate">
                    <div class="uplink-grid">
                        <div><label for="uplink2NewPort">New Port:</label><select id="uplink2NewPort"></select></div>
                        <div><label for="uplink2Ip">IP/Net:</label><input type="text" id="uplink2Ip"></div>
                        <div><label for="uplink2Comment">Comment:</label><input type="text" id="uplink2Comment"></div>
                        <div><label for="uplink2Cost">OSPF Cost:</label><input type="number" id="uplink2Cost" value="10" min="1"></div>
                    </div>
                    <button class="remove-btn" onclick="this.closest('.uplink-item').remove(); updateUplinkCount();">Remove</button>
                </div>
            </div>
            <div class="uplink-buttons">
                <button id="addUplinkBtn">Add Uplink</button>
            </div>
        </div>

        <div class="section">
            <h2>Static Customer Management</h2>
            <p>Add static customer IP ranges that will be automatically included in firewall address lists for proper routing and access control.</p>
            <div id="staticCustomers">
                <div class="customer-item" style="display:none;" id="customerTemplate">
                    <div class="customer-grid">
                        <div><label for="customer2Name">Customer Name:</label><input type="text" name="customerName" id="customer2Name" placeholder="Customer ABC"></div>
                        <div><label for="customer2Range">IP Range:</label><input type="text" name="customerRange" id="customer2Range" placeholder="192.168.100.0/24"></div>
                        <div><label for="customer2Comment">Comment:</label><input type="text" name="customerComment" id="customer2Comment" placeholder="Static customer network"></div>
                    </div>
                    <button class="remove-btn" onclick="this.closest('.customer-item').remove(); updateCustomerCount();">Remove</button>
                </div>
            </div>
            <div class="customer-buttons">
                <button id="addCustomerBtn">Add Static Customer</button>
            </div>
            <div style="background: #2a2a4a; padding: 10px; border-radius: 5px; margin-top: 10px;">
                <strong>Note:</strong> Static customers will be automatically added to firewall address lists for proper routing and access control.
            </div>
        </div>

        <div class="section">
            <h2>NOC Workflow Tools</h2>
            <p>Quick access tools for NOC technicians to streamline configuration and troubleshooting.</p>
            <div class="noc-tools-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <div style="background: #2a4a2a; padding: 15px; border-radius: 5px;">
                    <h3 style="margin-top: 0; color: #4CAF50;">Quick Presets</h3>
                    <button type="button" id="btnPresetBackbone" style="width: 100%; margin-bottom: 10px; padding: 8px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Backbone-v2 (BGP/OSPF)</button>
                    <button type="button" id="btnPresetMPLS" style="width: 100%; margin-bottom: 10px; padding: 8px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">MPLS/VPLS Site</button>
                    <button type="button" id="btnPresetTarana" style="width: 100%; margin-bottom: 10px; padding: 8px; background: #FF9800; color: white; border: none; border-radius: 4px; cursor: pointer;">Tarana Site</button>
                </div>
                <div style="background: #2a4a2a; padding: 15px; border-radius: 5px;">
                    <h3 style="margin-top: 0; color: #4CAF50;">Quick Actions</h3>
                    <button type="button" id="btnValidateConfig" style="width: 100%; margin-bottom: 10px; padding: 8px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Validate Configuration</button>
                    <button type="button" id="btnCheckCompliance" style="width: 100%; margin-bottom: 10px; padding: 8px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">Check RFC Compliance</button>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>NextLink RFC Compliance & Validation</h2>
            <div style="background: #2a4a2a; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                <h3 style="margin-top: 0; color: #4CAF50;">RFC Compliance Checklist</h3>
                <div style="background: #1a3a1a; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                    <strong style="color: #4CAF50;">‚úì RFC Baseline Applied:</strong> Standard firewall rules, address lists, system hardening, logging, SNMP, NTP, RADIUS, and user management configurations are automatically included in every generated configuration.
                </div>
                <div id="complianceChecklist">
                    <label><input type="checkbox" id="complianceSecurity" checked> RFC Security: Baseline firewall rules applied</label>
                    <label><input type="checkbox" id="complianceRouting"> RFC Routing: OSPF/BGP properly configured</label>
                    <label><input type="checkbox" id="complianceNAT"> RFC NAT: Source and destination rules set</label>
                    <label><input type="checkbox" id="complianceDHCP"> RFC DHCP: RADIUS integration configured</label>
                    <label><input type="checkbox" id="complianceSNMP"> RFC SNMP: Community strings and access controls set</label>
                    <label><input type="checkbox" id="complianceLogging"> RFC Logging: Remote syslog to 142.147.116.215 configured</label>
                    <label><input type="checkbox" id="complianceNTP"> RFC NTP: Time synchronization to ntp-pool.nxlink.com</label>
                    <label><input type="checkbox" id="complianceBackup"> Backup: Configuration backup recommended</label>
                </div>
            <div style="background: #2a2a4a; padding: 10px; border-radius: 5px; margin-top: 10px;">
                <strong style="color: #4CAF50;">‚úÖ RFC Firewall Rules Applied</strong>
                <p style="margin: 5px 0; color: #e0e0e0;">The RFC baseline firewall rules are automatically included in every configuration. These rules are compatible with all MikroTik models (RB1009, RB2011, CCR1036, RB5009, CCR2004, CCR2216) and RouterOS versions (6.x and 7.x).</p>
                <p style="margin: 5px 0; color: #e0e0e0; font-size: 0.9em;">‚úÖ Includes: 16 Input Chain rules, 2 Raw Chain rules, 5 Forward Chain rules, 3 NAT rules, and 37 Address List entries</p>
            </div>
            </div>
            <div style="background: #2a2a4a; padding: 15px; border-radius: 5px;">
                <h3 style="margin-top: 0; color: #FF9800;">Pre-Deployment Validation</h3>
                <button id="validateConfigBtn" style="background: #4CAF50; margin-bottom: 10px;">Validate Configuration</button>
                <div id="validationResults" style="display: none; background: #1a1a1a; padding: 10px; border-radius: 5px; margin-top: 10px;">
                    <h4>Validation Results:</h4>
                    <ul id="validationList"></ul>
                </div>
            </div>
        </div>

        <div class="section" style="display: none;">
            <h2>Keys & Settings</h2>
            <label for="sharedKey">Shared Key (OSPF/BGP MD5, e.g., m8M5JwvdYM):</label>
            <input type="text" id="sharedKey" value="m8M5JwvdYM">
            <label for="snmpCommunity">SNMP Community (e.g., FBZ1yYdphf):</label>
            <input type="text" id="snmpCommunity" value="FBZ1yYdphf">
            <label for="dhcpSecret">DHCP Secret (e.g., Nl22021234):</label>
            <input type="text" id="dhcpSecret" value="Nl22021234">
            <label for="dnsServers">DNS Servers (comma-separated, e.g., 142.147.112.3,142.147.112.19):</label>
            <input type="text" id="dnsServers" value="142.147.112.3,142.147.112.19">
        </div>

        <div class="generate-section">
            <button id="generateBtn">Generate Config Script</button>
        </div>

        <div class="section">
            <h2>Generated Configuration</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <h3 style="color: #4CAF50; margin-bottom: 10px;">üìã Configuration Metadata & Comments</h3>
                    <textarea id="metadataOutput" readonly placeholder="Configuration metadata and comments will appear here..." style="height: 300px; font-family: 'Courier New', monospace; font-size: 12px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #555; padding: 10px; border-radius: 4px;"></textarea>
                </div>
                <div>
                    <h3 style="color: #2196F3; margin-bottom: 10px;">‚öôÔ∏è Router Commands (.rsc)</h3>
                    <textarea id="output" readonly placeholder="Router commands will appear here..." style="height: 300px; font-family: 'Courier New', monospace; font-size: 12px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #555; padding: 10px; border-radius: 4px;"></textarea>
                </div>
            </div>
            <button id="downloadBtn" onclick="downloadConfig()" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px;">Download .rsc File</button>
        </div>
                    </div>
                    <!-- End mainForm -->
                </div>
            </div>
            
            <!-- ENTERPRISE CONFIG TAB -->
            <div class="content-pane" id="enterprise-pane">
                <div class="container">
                    <div class="enterprise-testing-banner">üß™ TESTING VERSION - Enterprise Config (Simple IP Route) - Functionality in Progress (NOC Ops)</div>
                    <h1>Enterprise Customer Configuration Generator</h1>
                    <p style="text-align: center; color: var(--text-color);">Simplified configuration for enterprise customers: Bridge-based setup with IP routes (no BGP/OSPF).</p>
                    <!-- Mode Toggle: AI default with Advanced manual fallback -->
                    <div id="ent_modeToggleBar" style="display:flex; align-items:center; gap:12px; justify-content:center; margin:10px 0 20px 0;">
                        <span style="color: var(--text-color); font-weight: 600;">Mode:</span>
                        <span style="padding:4px 8px; background:#1f3b2e; color:#7ee2a8; border-radius:4px;">AI (recommended)</span>
                        <label style="display:flex; align-items:center; gap:8px; color: var(--text-color); cursor:pointer;">
                            <input type="checkbox" id="ent_advanced_toggle">
                            <span>Advanced (manual)</span>
                        </label>
                    </div>
                    
                    <!-- Device Information -->
                    <div class="section">
                        <h2>Device Information</h2>
                        
                        <!-- RouterBoard + RouterOS (kept visible in AI mode) -->
                        <div id="ent_manual_device_group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label for="ent_routerboard_device">RouterBoard Device:</label>
                                <select id="ent_routerboard_device">
                                    <option value="">Select RouterBoard Device</option>
                                    <option value="rb1009">RB1009 (RouterOS 6.x/7.x)</option>
                                    <option value="rb2011">RB2011 (RouterOS 6.x/7.x)</option>
                                    <option value="ccr1036">CCR1036 (RouterOS 6.x/7.x)</option>
                                    <option value="ccr1072">CCR1072 (RouterOS 6.x/7.x)</option>
                                    <option value="rb5009">RB5009 (RouterOS 7.x)</option>
                                    <option value="ccr2004">CCR2004 (RouterOS 7.x)</option>
                                    <option value="ccr2216">CCR2216 (RouterOS 7.x)</option>
                                </select>
                            </div>
                            <div>
                                <label for="ent_routeros_version">RouterOS Version:</label>
                                <select id="ent_routeros_version">
                                    <option value="">Select RouterOS Version</option>
                                    <option value="6.45.2">6.45.2 (Legacy Speed Syntax)</option>
                                    <option value="6.49.2">6.49.2 (Legacy Speed Syntax)</option>
                                    <option value="7.11.2">7.11.2 (Legacy Speed Syntax)</option>
                                    <option value="7.16.2">7.16.2 (New Speed Syntax)</option>
                                    <option value="7.19.4">7.19.4 (New Speed Syntax)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div style="display:none;" aria-hidden="true">
                                <label for="ent_deviceType">Device Type (Legacy):</label>
                                <select id="ent_deviceType">
                                    <option value="CCR2004">CCR2004</option>
                                    <option value="CCR1036">CCR1036</option>
                                    <option value="RB5009">RB5009</option>
                                    <option value="CCR2216">CCR2216</option>
                                </select>
                            </div>
                            <div>
                                <label for="ent_customerCode">Customer Code (e.g., NX-431940):</label>
                                <input type="text" id="ent_customerCode" placeholder="NX-431940">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px;">
                            <div>
                                <label for="ent_deviceName">Device Name (auto-fills):</label>
                                <input type="text" id="ent_deviceName" placeholder="RTR-MTCCR2004.NX-431940" readonly style="background: var(--output-bg);">
                            </div>
                            <div>
                                <label for="ent_loopbackIP">Loopback IP (e.g., 10.3.0.242):</label>
                                <input type="text" id="ent_loopbackIP" placeholder="10.3.0.242">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px;">
                            <div>
                                <label for="ent_latitude">Site Latitude:</label>
                                <input type="text" id="ent_latitude" placeholder="31.12887">
                            </div>
                            <div>
                                <label for="ent_longitude">Site Longitude:</label>
                                <input type="text" id="ent_longitude" placeholder="-97.087951">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Network Configuration -->
                    <div class="section">
                        <h2>Network Configuration</h2>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label for="ent_publicIP">Public IP/Net (e.g., 143.55.49.165/30):</label>
                                <input type="text" id="ent_publicIP" placeholder="143.55.49.165/30">
                            </div>
                            <div id="ent_row_public_pool">
                                <label for="ent_publicPool">Public DHCP Pool (e.g., 143.55.49.166-143.55.49.166):</label>
                                <input type="text" id="ent_publicPool" placeholder="143.55.49.166-143.55.49.166">
                            </div>
                        </div>
                        
                        <div id="ent_row_private_pair" style="display:none; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px;">
                            <div>
                                <label for="ent_privateIP">Private IP/Net (e.g., 192.168.88.1/24):</label>
                                <input type="text" id="ent_privateIP" placeholder="192.168.88.1/24" value="192.168.88.1/24">
                            </div>
                            <div>
                                <label for="ent_privatePool">Private DHCP Pool (e.g., 192.168.88.10-192.168.88.254):</label>
                                <input type="text" id="ent_privatePool" placeholder="192.168.88.10-192.168.88.254" value="192.168.88.10-192.168.88.254">
                            </div>
                        </div>
                        
                        <div id="ent_row_gateway" style="display:none; margin-top: 10px;">
                            <label for="ent_gateway">Gateway IP (for IP route):</label>
                            <input type="text" id="ent_gateway" placeholder="10.1.241.89">
                        </div>

                        <!-- AI mode simple backhaul input (syncs into hidden uplink block) -->
                        <div id="ent_bh_simple_row" style="margin-top: 10px;">
                            <label for="ent_bh_cidr_simple">Backhaul IP/Net:</label>
                            <input type="text" id="ent_bh_cidr_simple" placeholder="10.1.241.92/29" oninput="entSyncBhCidr()">
                        </div>
                    </div>
                    
                    <!-- Interface Configuration -->
                    <div class="section" id="ent_manual_interfaces" style="display:none;">
                        <h2>Interface Configuration</h2>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label for="ent_publicInterface">Public/Customer Handoff Interface:</label>
                                <select id="ent_publicInterface">
                                    <option value="">Select Interface</option>
                                    <option value="sfp-sfpplus7">sfp-sfpplus7</option>
                                    <option value="ether7">ether7</option>
                                    <option value="ether1">ether1</option>
                                    <option value="sfp-sfpplus1">sfp-sfpplus1</option>
                                </select>
                            </div>
                            <div>
                                <label for="ent_natInterface">NAT Interface:</label>
                                <select id="ent_natInterface">
                                    <option value="">Select Interface</option>
                                    <option value="sfp-sfpplus8">sfp-sfpplus8</option>
                                    <option value="ether8">ether8</option>
                                    <option value="ether2">ether2</option>
                                    <option value="sfp-sfpplus2">sfp-sfpplus2</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <label for="ent_backhaulInterface">Backhaul/Uplink Interface:</label>
                            <select id="ent_backhaulInterface">
                                <option value="">Select Interface</option>
                                <option value="sfp-sfpplus1">sfp-sfpplus1</option>
                                <option value="ether1">ether1</option>
                                <option value="ether2">ether2</option>
                                <option value="sfp28-1">sfp28-1</option>
                            </select>
                        </div>
                        
                        <div class="dhcp-note" style="margin-top: 15px;">
                            <strong>Note:</strong> Interface speed negotiation will be set automatically based on device type and firmware version.
                        </div>
                    </div>
                    
                    <!-- Uplink/Backhaul Configuration -->
                    <div class="section" id="ent_manual_uplinks" style="display:none;">
                        <h2>Uplink/Backhaul Configuration</h2>
                        <div id="ent_uplinksContainer">
                            <div class="interface-item">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div>
                                        <label>Uplink Interface:</label>
                                        <select class="ent_uplinkInterface">
                                            <option value="">Select Interface</option>
                                            <option value="sfp-sfpplus1">sfp-sfpplus1</option>
                                            <option value="ether1">ether1</option>
                                            <option value="ether2">ether2</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label>Uplink IP/Net:</label>
                                        <input type="text" class="ent_uplinkIP" placeholder="10.1.241.92/29">
                                    </div>
                                </div>
                                <div style="margin-top: 10px;">
                                    <label>Uplink Comment/Location:</label>
                                    <input type="text" class="ent_uplinkComment" placeholder="TX-WESTPHALIA-EA-1">
                                </div>
                            </div>
                        </div>
                        <button class="add-btn" style="background: #28a745; margin-top: 10px;" onclick="addEnterpriseUplink()">+ Add Another Uplink</button>
                    </div>
                    
                    <!-- Optional Features -->
                    <div class="section" id="ent_manual_optional" style="display:none;">
                        <h2>Optional Features</h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label><input type="checkbox" id="ent_enableOSPF"> Enable OSPF</label>
                                <div class="hint" style="font-size: 12px; color: #888; margin-top: 5px;">Adds OSPF interface templates and routing</div>
                            </div>
                            <div>
                                <label><input type="checkbox" id="ent_enableBGP"> Enable BGP</label>
                                <div class="hint" style="font-size: 12px; color: #888; margin-top: 5px;">Adds BGP connections to core routers</div>
                            </div>
                        </div>
                        
                        <div id="ent_ospfBgpConfig" style="display: none; margin-top: 15px; padding: 15px; background: #2a2a2a; border-radius: 5px;">
                            <h3 style="margin-top: 0; color: #FF9800;">OSPF/BGP Configuration</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <label for="ent_sharedKey">Shared Key (OSPF/BGP MD5):</label>
                                    <input type="text" id="ent_sharedKey" value="m8M5JwvdYM" placeholder="m8M5JwvdYM">
                                </div>
                                <div>
                                    <label for="ent_ospfArea">OSPF Area:</label>
                                    <select id="ent_ospfArea">
                                        <option value="backbone-v2">backbone-v2</option>
                                        <option value="backbone">backbone</option>
                                        <option value="custom">Custom Area</option>
                                    </select>
                                </div>
                            </div>
                            <div id="ent_customOspfArea" style="display: none; margin-top: 10px;">
                                <label for="ent_ospfAreaCustom">Custom OSPF Area:</label>
                                <input type="text" id="ent_ospfAreaCustom" placeholder="e.g., 0.0.0.100">
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Assist + Generate Buttons -->
                    <div class="generate-section" style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        <button id="entAutofillBtn" style="background: #607D8B; color: white; border: none; padding: 12px 16px; border-radius: 5px; cursor: pointer; font-size: 14px;" onclick="entAutofillFromExport()">üîÑ Autofill from Export</button>
                        <button id="entSuggestBtn" style="display:none; background: #9C27B0; color: white; border: none; padding: 12px 16px; border-radius: 5px; cursor: pointer; font-size: 14px;" onclick="entAISuggest()">‚ú® AI Suggest</button>
                        <button id="entValidateBtn" style="background: #03A9F4; color: white; border: none; padding: 12px 16px; border-radius: 5px; cursor: pointer; font-size: 14px;" onclick="entValidateDryRun()">üß™ Validate / Dry‚Äërun</button>
                        <button id="generateEnterpriseBtn" style="background: #FF9800; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;" onclick="generateEnterpriseConfig()">üöÄ Generate Enterprise Configuration</button>
                    </div>

                    <!-- Paste Export (optional) -->
                    <details style="margin: 10px 0 0 0;">
                        <summary style="cursor: pointer; color: var(--text-color);">Paste exported RouterOS config (optional for Autofill)</summary>
                        <textarea id="ent_exportInput" style="width: 100%; min-height: 160px; padding: 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--output-bg); color: var(--text-color); font-family: monospace; font-size: 12px; line-height: 1.5; margin-top: 8px;" placeholder="# Paste your /export compact here..."></textarea>
                    </details>
                    
                    <!-- Output Section -->
                    <div class="section">
                        <h2>Generated Configuration</h2>
                        <div style="margin-bottom: 20px;">
                            <button onclick="copyEnterpriseConfig()" style="background: #2196F3;">üìã Copy to Clipboard</button>
                            <button onclick="downloadEnterpriseConfig()" style="background: #4CAF50;">üíæ Download .rsc File</button>
                            <button onclick="toggleEnterprisePasswords()" id="toggleEntPasswordBtn" style="background: #FF9800;">üëÅÔ∏è Show Passwords</button>
                            <button onclick="clearEnterpriseOutput()" style="background: #dc3545;">üóëÔ∏è Clear Output</button>
                        </div>
                        <div class="dhcp-note" style="margin-bottom: 15px;">
                            <strong>üîí Security:</strong> Passwords are hidden by default in the display. Click "Show Passwords" to reveal. Downloaded .rsc file contains actual passwords.
                        </div>
                        <div id="enterpriseOutput" style="background-color: var(--output-bg); color: var(--text-color); padding: 20px; border: 1px solid var(--border-color); border-radius: 4px; white-space: pre-wrap; font-family: monospace; min-height: 400px; width: 100%; transition: all 0.3s ease; font-size: 13px; line-height: 1.5;"></div>
                        <div id="entValidateReport" style="margin-top:10px; font-family: monospace; font-size: 12px; color: var(--text-color);"></div>
                    </div>
                </div>
            </div>
            
            <!-- MPLS ENTERPRISE CONFIG TAB -->
            <div class="content-pane" id="enterprise-mpls-pane">
                <div class="container">
                    <div class="enterprise-testing-banner">üß™ TESTING VERSION - MPLS Enterprise Config (with OSPF/BGP) - Functionality in Progress (NOC Ops)</div>
                    <h1>MPLS Enterprise Customer Configuration Generator</h1>
                    <p style="text-align: center; color: var(--text-color);">Full MPLS configuration for enterprise customers: Includes OSPF, BGP, firewall rules, and RFC compliance baseline.</p>
                    
                    <!-- Device Information -->
                    <div class="section">
                        <h2>Device Information</h2>
                        
                        <!-- RouterBoard Device Selection -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label for="ent_mpls_routerboard_device">RouterBoard Device:</label>
                                <select id="ent_mpls_routerboard_device">
                                    <option value="">Select RouterBoard Device</option>
                                    <option value="rb1009">RB1009 (RouterOS 6.x/7.x)</option>
                                    <option value="rb2011">RB2011 (RouterOS 6.x/7.x)</option>
                                    <option value="ccr1036">CCR1036 (RouterOS 6.x/7.x)</option>
                                    <option value="ccr1072">CCR1072 (RouterOS 6.x/7.x)</option>
                                    <option value="rb5009">RB5009 (RouterOS 7.x)</option>
                                    <option value="ccr2004">CCR2004 (RouterOS 7.x)</option>
                                    <option value="ccr2216">CCR2216 (RouterOS 7.x)</option>
                                </select>
                            </div>
                            <div>
                                <label for="ent_mpls_routeros_version">RouterOS Version:</label>
                                <select id="ent_mpls_routeros_version">
                                    <option value="">Select RouterOS Version</option>
                                    <option value="6.45.2">6.45.2 (Legacy Speed Syntax)</option>
                                    <option value="6.49.2">6.49.2 (Legacy Speed Syntax)</option>
                                    <option value="7.11.2">7.11.2 (Legacy Speed Syntax)</option>
                                    <option value="7.16.2">7.16.2 (New Speed Syntax)</option>
                                    <option value="7.19.4">7.19.4 (New Speed Syntax)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label for="ent_mpls_deviceType">Device Type (Legacy):</label>
                                <select id="ent_mpls_deviceType">
                                    <option value="">Select Device Type</option>
                                    <option value="CCR2004">CCR2004</option>
                                    <option value="CCR1036">CCR1036</option>
                                    <option value="RB5009">RB5009</option>
                                    <option value="CCR2216">CCR2216</option>
                                    <option value="CCR1072">CCR1072</option>
                                </select>
                            </div>
                            <div>
                                <label for="ent_mpls_customerCode">Customer Code (e.g., NX-477784):</label>
                                <input type="text" id="ent_mpls_customerCode" placeholder="NX-477784">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px;">
                            <div>
                                <label for="ent_mpls_deviceName">Device Name (auto-fills):</label>
                                <input type="text" id="ent_mpls_deviceName" placeholder="RTR-MTRB-5009.RTR-MT5009.NX-477784" readonly style="background: var(--output-bg);">
                            </div>
                            <div>
                                <label for="ent_mpls_loopbackIP">Loopback IP (e.g., 10.25.0.23/32):</label>
                                <input type="text" id="ent_mpls_loopbackIP" placeholder="10.25.0.23/32">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px;">
                            <div>
                                <label><input type="checkbox" id="ent_mpls_enableBGP"> Enable BGP for this site</label>
                                <div id="ent_mpls_bgpBlock" style="display:none; margin-top:6px;">
                                    <label for="ent_mpls_bgpAs">BGP ASN (e.g., 65000):</label>
                                    <input type="text" id="ent_mpls_bgpAs" placeholder="65000">
                                </div>
                            </div>
                            <div>
                                <div id="ent_mpls_bgpPeersBlock" style="display:none;">
                                    <label for="ent_mpls_bgpPeers">BGP Neighbors (comma separated IP:AS, e.g., 10.254.247.3:65001):</label>
                                    <input type="text" id="ent_mpls_bgpPeers" placeholder="10.254.247.3:65001,10.249.0.200:65002">
                                </div>
                            </div>
                        </div>
                        <div style="margin-top:10px; text-align:right;">
                            <button id="applyMplsPresetBtn" style="background:#29b6f6;">Apply MPLS Preset</button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px;">
                            <div>
                                <label for="ent_mpls_latitude">Site Latitude:</label>
                                <input type="text" id="ent_mpls_latitude" placeholder="32.4978904724">
                            </div>
                            <div>
                                <label for="ent_mpls_longitude">Site Longitude:</label>
                                <input type="text" id="ent_mpls_longitude" placeholder="-96.0615310669">
                            </div>
                        </div>
                    </div>
                    <!-- Port Configuration (NAT & Customer Handoff) -->
                    <div class="section">
                        <h2>Port Configuration</h2>
                        <p>Choose which physical interfaces will be used for Customer Handoff (bridge2000) and NAT/CPE (bridge4000). Public/private IPs and DHCP pools are handled by the BNG; only loopback and uplink IPs are added to the device here.</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label for="ent_mpls_publicInterface">Customer Handoff Interface (bridge2000):</label>
                                <select id="ent_mpls_publicInterface">
                                    <option value="">Select Interface</option>
                                    <option value="ether7">ether7</option>
                                    <option value="ether8">ether8</option>
                                    <option value="sfp-sfpplus7">sfp-sfpplus7</option>
                                    <option value="sfp-sfpplus1">sfp-sfpplus1</option>
                                </select>
                            </div>
                            <div>
                                <label for="ent_mpls_natInterface">NAT/CPE Interface (bridge4000):</label>
                                <select id="ent_mpls_natInterface">
                                    <option value="">Select Interface</option>
                                    <option value="ether8">ether8</option>
                                    <option value="ether7">ether7</option>
                                    <option value="sfp-sfpplus8">sfp-sfpplus8</option>
                                    <option value="sfp-sfpplus2">sfp-sfpplus2</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Interface Configuration removed (duplicates Port Configuration selections) -->
                    
                    <!-- Uplink/Backhaul Configuration -->
                    <div class="section">
                        <h2>Uplink/Backhaul Configuration (MPLS)</h2>
                        <div id="ent_mpls_uplinksContainer">
                            <div class="interface-item">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div>
                                        <label>Uplink Interface:</label>
                                        <select class="ent_mpls_uplinkInterface">
                                            <option value="">Select Interface</option>
                                            <!-- CCR2004 Interfaces -->
                                            <option value="ether1">ether1 (CCR2004)</option>
                                            <option value="sfp-sfpplus1">sfp-sfpplus1 (CCR2004)</option>
                                            <option value="sfp-sfpplus2">sfp-sfpplus2 (CCR2004)</option>
                                            <option value="sfp-sfpplus3">sfp-sfpplus3 (CCR2004)</option>
                                            <option value="sfp-sfpplus4">sfp-sfpplus4 (CCR2004)</option>
                                            <option value="sfp-sfpplus5">sfp-sfpplus5 (CCR2004)</option>
                                            <option value="sfp-sfpplus6">sfp-sfpplus6 (CCR2004)</option>
                                            <option value="sfp-sfpplus7">sfp-sfpplus7 (CCR2004)</option>
                                            <option value="sfp-sfpplus8">sfp-sfpplus8 (CCR2004)</option>
                                            <option value="sfp-sfpplus9">sfp-sfpplus9 (CCR2004)</option>
                                            <option value="sfp-sfpplus10">sfp-sfpplus10 (CCR2004)</option>
                                            <option value="sfp-sfpplus11">sfp-sfpplus11 (CCR2004)</option>
                                            <option value="sfp-sfpplus12">sfp-sfpplus12 (CCR2004)</option>
                                            <option value="sfp28-1">sfp28-1 (CCR2004)</option>
                                            <option value="sfp28-2">sfp28-2 (CCR2004)</option>
                                            <!-- CCR1036 Interfaces -->
                                            <option value="ether1">ether1 (CCR1036)</option>
                                            <option value="ether2">ether2 (CCR1036)</option>
                                            <option value="ether3">ether3 (CCR1036)</option>
                                            <option value="ether4">ether4 (CCR1036)</option>
                                            <option value="ether5">ether5 (CCR1036)</option>
                                            <option value="ether6">ether6 (CCR1036)</option>
                                            <option value="ether7">ether7 (CCR1036)</option>
                                            <option value="ether8">ether8 (CCR1036)</option>
                                            <option value="ether9">ether9 (CCR1036)</option>
                                            <option value="ether10">ether10 (CCR1036)</option>
                                            <option value="ether11">ether11 (CCR1036)</option>
                                            <option value="ether12">ether12 (CCR1036)</option>
                                            <option value="sfp1">sfp1 (CCR1036)</option>
                                            <option value="sfp2">sfp2 (CCR1036)</option>
                                            <option value="sfp3">sfp3 (CCR1036)</option>
                                            <option value="sfp4">sfp4 (CCR1036)</option>
                                            <!-- RB5009 Interfaces -->
                                            <option value="ether1">ether1 (RB5009)</option>
                                            <option value="ether2">ether2 (RB5009)</option>
                                            <option value="ether3">ether3 (RB5009)</option>
                                            <option value="ether4">ether4 (RB5009)</option>
                                            <option value="ether5">ether5 (RB5009)</option>
                                            <option value="ether6">ether6 (RB5009)</option>
                                            <option value="ether7">ether7 (RB5009)</option>
                                            <option value="ether8">ether8 (RB5009)</option>
                                            <option value="sfp-sfpplus1">sfp-sfpplus1 (RB5009)</option>
                                            <!-- CCR2216 Interfaces -->
                                            <option value="qsfp1">qsfp1 (CCR2216)</option>
                                            <option value="qsfp2">qsfp2 (CCR2216)</option>
                                            <option value="qsfp3">qsfp3 (CCR2216)</option>
                                            <option value="qsfp4">qsfp4 (CCR2216)</option>
                                            <option value="sfp28-1">sfp28-1 (CCR2216)</option>
                                            <option value="sfp28-2">sfp28-2 (CCR2216)</option>
                                            <option value="sfp28-3">sfp28-3 (CCR2216)</option>
                                            <option value="sfp28-4">sfp28-4 (CCR2216)</option>
                                            <option value="sfp28-5">sfp28-5 (CCR2216)</option>
                                            <option value="sfp28-6">sfp28-6 (CCR2216)</option>
                                            <option value="sfp28-7">sfp28-7 (CCR2216)</option>
                                            <option value="sfp28-8">sfp28-8 (CCR2216)</option>
                                            <option value="sfp28-9">sfp28-9 (CCR2216)</option>
                                            <option value="sfp28-10">sfp28-10 (CCR2216)</option>
                                            <option value="sfp28-11">sfp28-11 (CCR2216)</option>
                                            <option value="sfp28-12">sfp28-12 (CCR2216)</option>
                                            <option value="sfp28-13">sfp28-13 (CCR2216)</option>
                                            <option value="sfp28-14">sfp28-14 (CCR2216)</option>
                                            <option value="sfp28-15">sfp28-15 (CCR2216)</option>
                                            <option value="sfp28-16">sfp28-16 (CCR2216)</option>
                                            <!-- CCR1072 Interfaces -->
                                            <option value="ether1">ether1 (CCR1072)</option>
                                            <option value="ether2">ether2 (CCR1072)</option>
                                            <option value="ether3">ether3 (CCR1072)</option>
                                            <option value="ether4">ether4 (CCR1072)</option>
                                            <option value="ether5">ether5 (CCR1072)</option>
                                            <option value="ether6">ether6 (CCR1072)</option>
                                            <option value="ether7">ether7 (CCR1072)</option>
                                            <option value="ether8">ether8 (CCR1072)</option>
                                            <option value="ether9">ether9 (CCR1072)</option>
                                            <option value="ether10">ether10 (CCR1072)</option>
                                            <option value="ether11">ether11 (CCR1072)</option>
                                            <option value="ether12">ether12 (CCR1072)</option>
                                            <option value="sfp1">sfp1 (CCR1072)</option>
                                            <option value="sfp2">sfp2 (CCR1072)</option>
                                            <option value="sfp3">sfp3 (CCR1072)</option>
                                            <option value="sfp4">sfp4 (CCR1072)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label>Uplink IP/Net:</label>
                                        <input type="text" class="ent_mpls_uplinkIP" placeholder="10.24.251.84/29">
                                    </div>
                                </div>
                                <div style="margin-top: 10px;">
                                    <label>Uplink Comment/Location:</label>
                                    <input type="text" class="ent_mpls_uplinkComment" placeholder="UPLINK-LOCATION-1">
                                </div>
                            </div>
                        </div>
                        <button class="add-btn" style="background: #28a745; margin-top: 10px;" onclick="addMPLSUplink()">+ Add Another Uplink</button>
                    </div>
                    
                    <!-- SNMP Configuration -->
                    <div class="section">
                        <h2>SNMP Configuration</h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label for="ent_mpls_snmpCommunity">SNMP Community:</label>
                                <input type="text" id="ent_mpls_snmpCommunity" value="FBZ1yYdphf" placeholder="FBZ1yYdphf">
                            </div>
                        </div>
                    </div>
                    <!-- Generate Button -->
                    <div class="generate-section">
                        <button id="generateMPLSEnterpriseBtn" style="background: #FF9800; color: white; border: none; padding: 15px 40px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;" onclick="generateMPLSEnterpriseConfig()">
                            üöÄ Generate MPLS Enterprise Configuration
                        </button>
                    </div>
                    
                    <!-- Output Section -->
                    <div class="section">
                        <h2>Generated Configuration</h2>
                        <div style="margin-bottom: 20px;">
                            <button onclick="copyMPLSEnterpriseConfig()" style="background: #2196F3;">üìã Copy to Clipboard</button>
                            <button onclick="downloadMPLSEnterpriseConfig()" style="background: #4CAF50;">üíæ Download .rsc File</button>
                            <button onclick="toggleMPLSEnterprisePasswords()" id="toggleMPLSEntPasswordBtn" style="background: #FF9800;">üëÅÔ∏è Show Passwords</button>
                            <button onclick="clearMPLSEnterpriseOutput()" style="background: #dc3545;">üóëÔ∏è Clear Output</button>
                        </div>
                        <div class="dhcp-note" style="margin-bottom: 15px;">
                            <strong>üîí Security:</strong> Passwords are hidden by default in the display. Click "Show Passwords" to reveal. Downloaded .rsc file contains actual passwords.
                        </div>
                        <div id="mplsEnterpriseOutput" style="background-color: var(--output-bg); color: var(--text-color); padding: 20px; border: 1px solid var(--border-color); border-radius: 4px; white-space: pre-wrap; font-family: monospace; min-height: 400px; width: 100%; transition: all 0.3s ease; font-size: 13px; line-height: 1.5;"></div>
                    </div>
                </div>
            </div>
            
            <!-- CCR2004 VLAN CONFIG TAB -->
            <div class="content-pane" id="ccr2004-pane">
                <div class="container">
                    <div class="testing-banner">üß™ TESTING VERSION - CCR2004 VLAN Configuration - Functionality in Progress (NOC Ops)</div>
                    <h1>CCR2004 VLAN Configuration Generator</h1>
                    <p style="text-align: center; color: var(--text-color);">Configure VLAN 3000/4000 for CCR2004 routers with DHCP pools and OSPF templates.</p>
                    
                    <div class="section">
                        <h2>RouterBoard VLAN Configuration</h2>
                        
                        <!-- RouterBoard Device Selection -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label for="ccr_routerboard_device">RouterBoard Device:</label>
                                <select id="ccr_routerboard_device">
                                    <option value="">Select RouterBoard Device</option>
                                    <option value="rb1009">RB1009 (RouterOS 6.x/7.x)</option>
                                    <option value="rb2011">RB2011 (RouterOS 6.x/7.x)</option>
                                    <option value="ccr1036">CCR1036 (RouterOS 6.x/7.x)</option>
                                    <option value="ccr1072">CCR1072 (RouterOS 6.x/7.x)</option>
                                    <option value="rb5009">RB5009 (RouterOS 7.x)</option>
                                    <option value="ccr2004">CCR2004 (RouterOS 7.x)</option>
                                    <option value="ccr2216">CCR2216 (RouterOS 7.x)</option>
                                </select>
                            </div>
                            <div>
                                <label for="ccr_routeros_version">RouterOS Version:</label>
                                <select id="ccr_routeros_version">
                                    <option value="">Select RouterOS Version</option>
                                    <option value="6.45.2">6.45.2 (Legacy Speed Syntax)</option>
                                    <option value="6.49.2">6.49.2 (Legacy Speed Syntax)</option>
                                    <option value="7.11.2">7.11.2 (Legacy Speed Syntax)</option>
                                    <option value="7.16.2">7.16.2 (New Speed Syntax)</option>
                                    <option value="7.19.4">7.19.4 (New Speed Syntax)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label for="ccr_port">RouterBoard Port (switch uplink):</label>
                                <select id="ccr_port">
                                    <option value="">Select Port (Choose Device First)</option>
                                </select>
                                <div class="hint">Ports will populate based on selected RouterBoard device</div>
                            </div>
                            <div>
                                <label for="ccr_subnet3000">VLAN 3000 (6 GHz) Subnet (CIDR):</label>
                                <input type="text" id="ccr_subnet3000" placeholder="e.g. 10.254.32.0/28">
                                <div class="hint">Subnet Range</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px;">
                            <div>
                                <label for="ccr_subnet4000">VLAN 4000 Subnet (CIDR):</label>
                                <input type="text" id="ccr_subnet4000" placeholder="e.g. 10.10.0.0/22">
                                <div class="hint">Subnet Range</div>
                            </div>
                            <div>
                                <label for="ccr_poolOffset">DHCP Pool Start Offset (after GW):</label>
                                <input type="number" id="ccr_poolOffset" min="0" placeholder="0">
                                <div class="hint">0 = GW+1; increase to reserve more in front</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 10px;">
                            <label for="ccr_dns">DNS Servers:</label>
                            <input type="text" id="ccr_dns" placeholder="comma-separated (e.g. 142.147.112.3,142.147.112.19)">
                        </div>
                        
                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <button id="generateCCR" style="background: #FF9800;">Generate</button>
                            <button id="copyCCR" style="background: #6c757d;">Copy</button>
                        </div>
                        
                        <div id="ccr_warnBox" style="margin-top: 15px;"></div>
                        <div id="ccr_netFacts" style="margin-top: 15px;"></div>
                    </div>
                    
                    <div class="section">
                        <h2>Generated Configuration</h2>
                        <textarea id="ccr_output" style="width: 100%; min-height: 400px; padding: 15px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--output-bg); color: var(--text-color); font-family: monospace; font-size: 13px; line-height: 1.5;" placeholder="Your CCR2004 configuration will appear here..."></textarea>
                    </div>
                </div>
            </div>
            
            <!-- TARANA SECTORS TAB -->
            <div class="content-pane" id="tarana-pane">
                <div class="container">
                    <div class="testing-banner">üß™ TESTING VERSION - Tarana Sector Configuration - Functionality in Progress (NOC Ops)</div>
                    <h1>Tarana Sector Configuration Generator</h1>
                    <p style="text-align: center; color: var(--text-color);">Configure ALPHA/BETA/GAMMA/DELTA sectors with UNICORNMGMT bridge.</p>
                    
                    <div class="section">
                        <h2>Tarana Sector Configuration</h2>
                        
                        <!-- RouterBoard Device Selection -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label for="tarana_routerboard_device">RouterBoard Device:</label>
                                <select id="tarana_routerboard_device">
                                    <option value="">Select RouterBoard Device</option>
                                    <option value="ccr2004">CCR2004 (RouterOS 7.x)</option>
                                    <option value="ccr2216">CCR2216 (RouterOS 7.x)</option>
                                    <option value="ccr2116">CCR2116 (RouterOS 7.x)</option>
                                </select>
                            </div>
                            <div>
                                <label for="tarana_routeros_version">RouterOS Version:</label>
                                <select id="tarana_routeros_version">
                                    <option value="">Select RouterOS Version</option>
                                    <option value="7.11.2">7.11.2 (Legacy Speed Syntax)</option>
                                    <option value="7.16.2">7.16.2 (New Speed Syntax)</option>
                                    <option value="7.19.4">7.19.4 (New Speed Syntax)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px;">
                            <div>
                                <label for="tarana_alphaPort">ALPHA Port:</label>
                                <select id="tarana_alphaPort">
                                    <option value="">None</option>
                                </select>
                            </div>
                            <div>
                                <label for="tarana_betaPort">BETA Port:</label>
                                <select id="tarana_betaPort">
                                    <option value="">None</option>
                                </select>
                            </div>
                            <div>
                                <label for="tarana_gammaPort">GAMMA Port:</label>
                                <select id="tarana_gammaPort">
                                    <option value="">None</option>
                                </select>
                            </div>
                            <div>
                                <label for="tarana_deltaPort">DELTA Port (optional):</label>
                                <select id="tarana_deltaPort">
                                    <option value="">None</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <label for="tarana_mgmtSubnet">UNICORNMGMT (bridge3000) Subnet (CIDR):</label>
                            <input type="text" id="tarana_mgmtSubnet" placeholder="e.g. 10.246.21.64/29">
                            <div class="hint">Router IP = first usable.</div>
                        </div>
                        
                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <button id="generateTarana" style="background: #FF9800;">Generate</button>
                            <button id="copyTarana" style="background: #6c757d;">Copy</button>
                        </div>
                        
                        <div id="tarana_warn" style="margin-top: 15px;"></div>
                    </div>
                    
                    <div class="section">
                        <h2>Generated Configuration</h2>
                        <textarea id="tarana_output" style="width: 100%; min-height: 400px; padding: 15px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--output-bg); color: var(--text-color); font-family: monospace; font-size: 13px; line-height: 1.5;" placeholder="Your Tarana sector configuration will appear here..."></textarea>
                    </div>
                </div>
            </div>
            <!-- ENTERPRISE FEEDING SIDE TAB -->
            <div class="content-pane" id="enterprise-feeding-pane">
                <div class="container">
                    <div class="testing-banner">üß™ TESTING VERSION - Enterprise Feeding Side Configuration - Functionality in Progress (NOC Ops)</div>
                    <h1>Enterprise Config (Feeding Side)</h1>
                    <p style="text-align: center; color: var(--text-color);">Provision commercial/enterprise uplinks. Generates RouterOS scripts for feeding side.</p>
                    
                    <div class="section">
                        <h2>Enterprise Feeding Configuration</h2>
                        
                        <!-- Device Selection -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label for="ent_feeding_device">RouterBoard Device:</label>
                                <select id="ent_feeding_device">
                                    <option value="">Select RouterBoard Device</option>
                                    <option value="rb1009">RB1009 (RouterOS 6.x/7.x)</option>
                                    <option value="rb2011">RB2011 (RouterOS 6.x/7.x)</option>
                                    <option value="ccr1036">CCR1036 (RouterOS 6.x/7.x)</option>
                                    <option value="ccr1072">CCR1072 (RouterOS 6.x/7.x)</option>
                                    <option value="rb5009">RB5009 (RouterOS 7.x)</option>
                                    <option value="ccr2004">CCR2004 (RouterOS 7.x)</option>
                                    <option value="ccr2216">CCR2216 (RouterOS 7.x)</option>
                                </select>
                            </div>
                            <div>
                                <label for="ent_feeding_routeros">RouterOS Version:</label>
                                <select id="ent_feeding_routeros">
                                    <option value="">Select RouterOS Version</option>
                                    <option value="6.45.2">6.45.2 (Legacy Speed Syntax)</option>
                                    <option value="6.49.2">6.49.2 (Legacy Speed Syntax)</option>
                                    <option value="7.11.2">7.11.2 (Legacy Speed Syntax)</option>
                                    <option value="7.16.2">7.16.2 (New Speed Syntax)</option>
                                    <option value="7.19.4">7.19.4 (New Speed Syntax)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                            <div>
                                <label for="ent_feeding_label">Customer Label:</label>
                                <input type="text" id="ent_feeding_label" placeholder="e.g. Jamie Mitchell | 125197077 or NX-12345">
                            </div>
                            <div>
                                <label for="ent_feeding_port">Handoff Port:</label>
                                <select id="ent_feeding_port">
                                    <option value="">Select Port (Choose Device First)</option>
                                </select>
                                <div class="hint">Ports will populate based on selected RouterBoard device</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-top: 15px;">
                            <div>
                                <label for="ent_feeding_loop">Loopback /32 (10.x):</label>
                                <input type="text" id="ent_feeding_loop" placeholder="e.g. 10.26.0.7/32">
                            </div>
                            <div>
                                <label for="ent_feeding_uplink">Uplink private subnet (/29):</label>
                                <input type="text" id="ent_feeding_uplink" placeholder="e.g. 10.24.252.192/29">
                            </div>
                            <div>
                                <label for="ent_feeding_backhaul">Backhaul range /30 (fiber):</label>
                                <input type="text" id="ent_feeding_backhaul" placeholder="e.g. 132.147.181.40/30">
                            </div>
                            <div>
                                <label for="ent_feeding_public">Public IP subnet (/30 or /29):</label>
                                <input type="text" id="ent_feeding_public" placeholder="optional">
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <button id="generateEntFeeding" style="background: #FF9800;">Generate</button>
                            <button id="copyEntFeeding" style="background: #6c757d;">Copy</button>
                        </div>
                        
                        <div id="ent_feeding_warn" style="margin-top: 15px;"></div>
                    </div>
                    
                    <div class="section">
                        <h2>Generated Configuration</h2>
                        <textarea id="ent_feeding_output" style="width: 100%; min-height: 400px; padding: 15px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--output-bg); color: var(--text-color); font-family: monospace; font-size: 13px; line-height: 1.5;" placeholder="Enterprise / Commercial config will appear here..."></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="nextlink_constants.js"></script>
    <script>
        // Device-specific configurations
        const DEVICE_CONFIGS = {
            rb1009: {
                name: 'RB1009',
                ports: ['ether1', 'ether2', 'ether3', 'ether4', 'ether5', 'ether6', 'ether7', 'ether8', 'ether9', 'ether10'],
                sfpPorts: [],
                maxUplinks: 2,
                features: ['basic-routing', 'dhcp', 'firewall'],
                routerOS: ['6.x', '7.x'],
                ospfSyntax: 'v6', // Uses /routing ospf interface and /routing ospf network
                bgpSyntax: 'v6'   // Uses /routing bgp instance and /routing bgp peer
            },
            rb2011: {
                name: 'RB2011',
                ports: ['ether1', 'ether2', 'ether3', 'ether4', 'ether5', 'ether6', 'ether7', 'ether8', 'ether9', 'ether10'],
                sfpPorts: ['sfp1'],
                maxUplinks: 3,
                features: ['basic-routing', 'dhcp', 'firewall', 'mpls'],
                routerOS: ['6.x', '7.x'],
                ospfSyntax: 'v6', // Uses /routing ospf interface and /routing ospf network
                bgpSyntax: 'v6',   // Uses /routing bgp instance and /routing bgp peer
                mplsMtu: 1600
            },
            ccr1036: {
                name: 'CCR1036',
                ports: ['ether1', 'ether2', 'ether3', 'ether4', 'ether5', 'ether6', 'ether7', 'ether8', 'ether9', 'ether10', 'ether11', 'ether12'], // 12 Gigabit ethernet ports
                sfpPorts: ['sfp1', 'sfp2', 'sfp3', 'sfp4'], // 4 SFP ports (not SFP+)
                maxUplinks: 4,
                features: ['advanced-routing', 'dhcp', 'firewall', 'mpls', 'bgp', 'ospf'],
                routerOS: ['6.x', '7.x'],
                ospfSyntax: 'v6', // Uses /routing ospf interface and /routing ospf network
                bgpSyntax: 'v6',   // Uses /routing bgp instance and /routing bgp peer
                mplsMtu: 1600
            },
            rb5009: {
                name: 'RB5009',
                ports: ['ether1', 'ether2', 'ether3', 'ether4', 'ether5', 'ether6', 'ether7', 'ether8', 'ether9', 'ether10', 'ether11', 'ether12', 'ether13'],
                sfpPorts: ['sfp-sfpplus1', 'sfp-sfpplus2'], // RB5009 uses sfp-sfpplus syntax (RouterOS v7)
                maxUplinks: 2,
                features: ['advanced-routing', 'dhcp', 'firewall', 'mpls', 'bgp', 'ospf'],
                routerOS: ['7.x'],
                ospfSyntax: 'v7', // Uses /routing ospf interface-template
                bgpSyntax: 'v7',   // Uses /routing bgp template and /routing bgp connection
                mplsMtu: 1600
            },
            ccr2004: {
                name: 'CCR2004',
                ports: ['ether1'], // CCR2004 has only 1 ethernet port
                sfpPorts: ['sfp-sfpplus1', 'sfp-sfpplus2', 'sfp-sfpplus3', 'sfp-sfpplus4', 'sfp-sfpplus5', 'sfp-sfpplus6', 'sfp-sfpplus7', 'sfp-sfpplus8', 'sfp-sfpplus9', 'sfp-sfpplus10', 'sfp-sfpplus11', 'sfp-sfpplus12'],
                maxUplinks: 4,
                features: ['advanced-routing', 'dhcp', 'firewall', 'mpls', 'bgp', 'ospf'],
                routerOS: ['7.x'],
                ospfSyntax: 'v7', // Uses /routing ospf interface-template
                bgpSyntax: 'v7',   // Uses /routing bgp template and /routing bgp connection
                mplsMtu: 1600
            },
            ccr2116: {
                name: 'CCR2116',
                ports: ['ether1', 'ether2', 'ether3', 'ether4', 'ether5', 'ether6', 'ether7', 'ether8', 'ether9', 'ether10', 'ether11', 'ether12'],
                sfpPorts: ['sfp-sfpplus1', 'sfp-sfpplus2', 'sfp-sfpplus3', 'sfp-sfpplus4'],
                maxUplinks: 6,
                features: ['advanced-routing', 'dhcp', 'firewall', 'mpls', 'bgp', 'ospf'],
                routerOS: ['7.x'],
                ospfSyntax: 'v7', // Uses /routing ospf interface-template
                bgpSyntax: 'v7',   // Uses /routing bgp template and /routing bgp connection
                mplsMtu: 1600
            },
            ccr2216: {
                name: 'CCR2216',
                ports: ['ether1'], // CCR2216 has only 1 ethernet port
                sfpPorts: [
                    // QSFP28 ports (8 total)
                    'qsfp28-1-1', 'qsfp28-1-2', 'qsfp28-1-3', 'qsfp28-1-4',
                    'qsfp28-2-1', 'qsfp28-2-2', 'qsfp28-2-3', 'qsfp28-2-4',
                    // SFP28 ports (12 total)
                    'sfp28-1', 'sfp28-2', 'sfp28-3', 'sfp28-4', 'sfp28-5', 'sfp28-6',
                    'sfp28-7', 'sfp28-8', 'sfp28-9', 'sfp28-10', 'sfp28-11', 'sfp28-12'
                ],
                maxUplinks: 6,
                features: ['advanced-routing', 'dhcp', 'firewall', 'mpls', 'bgp', 'ospf'],
                routerOS: ['7.x'],
                ospfSyntax: 'v7', // Uses /routing ospf interface-template
                bgpSyntax: 'v7',   // Uses /routing bgp template and /routing bgp connection
                mplsMtu: 1600
            },
            ccr1072: {
                name: 'CCR1072',
                ports: ['ether1', 'ether2', 'ether3', 'ether4', 'ether5', 'ether6', 'ether7', 'ether8', 'ether9', 'ether10', 'ether11', 'ether12'],
                sfpPorts: ['sfp1', 'sfp2', 'sfp3', 'sfp4'],
                maxUplinks: 4,
                features: ['advanced-routing', 'dhcp', 'firewall', 'mpls', 'bgp', 'ospf'],
                routerOS: ['6.x', '7.x'],
                ospfSyntax: 'v6', // Uses /routing ospf interface and /routing ospf network
                bgpSyntax: 'v6',   // Uses /routing bgp instance and /routing bgp peer
                mplsMtu: 1600
            }
        };

        // RouterOS Version Type Detection
        function getRouterOSVersionType(version) {
            const routerOSVersions = {
                '6.45.2': 'legacy',
                '6.49.2': 'legacy', 
                '7.11.2': 'legacy',
                '7.16.2': 'new',
                '7.19.4': 'new'
            };
            return routerOSVersions[version] || 'legacy';
        }

        // Get Speed Syntax based on RouterOS version
        function getSpeedSyntax(routerOSVersion, port) {
            const versionType = getRouterOSVersionType(routerOSVersion);
            
            if (versionType === 'new') {
                // RouterOS 7.16.2+ syntax
                if (port.includes('sfp') || port.includes('qsfp')) {
                    return '1G-baseSX-full'; // Default SFP speed
                } else {
                    return '1G-baseT-full'; // Default ethernet speed
                }
            } else {
                // Legacy RouterOS syntax
                if (port.includes('sfp') || port.includes('qsfp')) {
                    return '1Gbps-duplex=full';
                } else {
                    return '1Gbps-duplex=full';
                }
            }
        }

        // Enterprise Feeding Device Selection Handler
        function handleEnterpriseFeedingDeviceChange() {
            const deviceSelect = document.getElementById('ent_feeding_device');
            const portSelect = document.getElementById('ent_feeding_port');
            
            if (!deviceSelect || !portSelect) return;
            
            const selectedDevice = deviceSelect.value || 'ccr2004';
            const deviceConfig = DEVICE_CONFIGS[selectedDevice];
            
            if (!deviceConfig) {
                portSelect.innerHTML = '<option value="">Select Port (Choose Device First)</option>';
                return;
            }
            
            // Clear existing options
            portSelect.innerHTML = '<option value="">Select Port</option>';
            
            // Add all available ports (ethernet + SFP)
            const allPorts = [...deviceConfig.ports, ...deviceConfig.sfpPorts];
            
            allPorts.forEach(port => {
                const option = document.createElement('option');
                option.value = port;
                option.textContent = `${port} (${deviceConfig.name})`;
                portSelect.appendChild(option);
            });
        }

        // Enterprise Feeding RouterOS Version Handler
        function handleEnterpriseFeedingRouterOSChange() {
            const routerOSSelect = document.getElementById('ent_feeding_routeros');
            if (!routerOSSelect) return;
            
            const selectedVersion = routerOSSelect.value;
            const versionType = getRouterOSVersionType(selectedVersion);
            
            if (versionType === 'new') {
                console.log(`RouterOS ${selectedVersion} - Using new speed syntax (e.g., 1G-baseT-full)`);
            } else {
                console.log(`RouterOS ${selectedVersion} - Using legacy speed syntax (e.g., 1Gbps-duplex=full)`);
            }
        }

        // Enterprise Config Device Selection Handler
        function handleEnterpriseDeviceChange() {
            const deviceSelect = document.getElementById('ent_routerboard_device');
            if (!deviceSelect) return;
            
            const selectedDevice = deviceSelect.value;
            const deviceConfig = DEVICE_CONFIGS[selectedDevice];
            
            if (!deviceConfig) {
                console.log('No device configuration found');
                return;
            }
            
            console.log(`Enterprise Config - Device selected: ${deviceConfig.name}`);
            console.log(`Available ports: ${[...deviceConfig.ports, ...deviceConfig.sfpPorts].join(', ')}`);
        }

        // Enterprise Config RouterOS Version Handler
        function handleEnterpriseRouterOSChange() {
            const routerOSSelect = document.getElementById('ent_routeros_version');
            if (!routerOSSelect) return;
            
            const selectedVersion = routerOSSelect.value;
            const versionType = getRouterOSVersionType(selectedVersion);
            
            if (versionType === 'new') {
                console.log(`Enterprise Config - RouterOS ${selectedVersion} - Using new speed syntax (e.g., 1G-baseT-full)`);
            } else {
                console.log(`Enterprise Config - RouterOS ${selectedVersion} - Using legacy speed syntax (e.g., 1Gbps-duplex=full)`);
            }
        }
        // MPLS Enterprise Config Device Selection Handler
        function handleMplsEnterpriseDeviceChange() {
            const deviceSelect = document.getElementById('ent_mpls_routerboard_device');
            if (!deviceSelect) return;
            
            const selectedDevice = deviceSelect.value;
            const deviceConfig = DEVICE_CONFIGS[selectedDevice];
            
            if (!deviceConfig) {
                console.log('No device configuration found');
                return;
            }
            
            console.log(`MPLS Enterprise Config - Device selected: ${deviceConfig.name}`);
            console.log(`Available ports: ${[...deviceConfig.ports, ...deviceConfig.sfpPorts].join(', ')}`);
        }
        // MPLS Enterprise Config RouterOS Version Handler
        function handleMplsEnterpriseRouterOSChange() {
            const routerOSSelect = document.getElementById('ent_mpls_routeros_version');
            if (!routerOSSelect) return;
            
            const selectedVersion = routerOSSelect.value;
            const versionType = getRouterOSVersionType(selectedVersion);
            
            if (versionType === 'new') {
                console.log(`MPLS Enterprise Config - RouterOS ${selectedVersion} - Using new speed syntax (e.g., 1G-baseT-full)`);
            } else {
                console.log(`MPLS Enterprise Config - RouterOS ${selectedVersion} - Using legacy speed syntax (e.g., 1Gbps-duplex=full)`);
            }
        }

        // CCR2004 VLAN Config Device Selection Handler
        function handleCCRDeviceChange() {
            const deviceSelect = document.getElementById('ccr_routerboard_device');
            const portSelect = document.getElementById('ccr_port');
            
            if (!deviceSelect || !portSelect) return;
            
            const selectedDevice = deviceSelect.value;
            const deviceConfig = DEVICE_CONFIGS[selectedDevice];
            
            if (!deviceConfig) {
                portSelect.innerHTML = '<option value="">Select Port (Choose Device First)</option>';
                return;
            }
            
            // Clear existing options
            portSelect.innerHTML = '<option value="">Select Port</option>';
            
            // Add all available ports (ethernet + SFP)
            const allPorts = [...deviceConfig.ports, ...deviceConfig.sfpPorts];
            
            allPorts.forEach(port => {
                const option = document.createElement('option');
                option.value = port;
                option.textContent = `${port} (${deviceConfig.name})`;
                portSelect.appendChild(option);
            });
            
            console.log(`CCR VLAN Config - Device selected: ${deviceConfig.name}`);
            console.log(`Ports updated for ${deviceConfig.name}`);
        }
        // CCR2004 VLAN Config RouterOS Version Handler
        function handleCCRRouterOSChange() {
            const routerOSSelect = document.getElementById('ccr_routeros_version');
            if (!routerOSSelect) return;
            
            const selectedVersion = routerOSSelect.value;
            const versionType = getRouterOSVersionType(selectedVersion);
            
            if (versionType === 'new') {
                console.log(`CCR VLAN Config - RouterOS ${selectedVersion} - Using new speed syntax (e.g., 1G-baseT-full)`);
            } else {
                console.log(`CCR VLAN Config - RouterOS ${selectedVersion} - Using legacy speed syntax (e.g., 1Gbps-duplex=full)`);
            }
        }

        // Tarana Sectors Device Selection Handler
        function handleTaranaDeviceChange() {
            const deviceSelect = document.getElementById('tarana_routerboard_device');
            const portSelects = [
                document.getElementById('tarana_alphaPort'),
                document.getElementById('tarana_betaPort'),
                document.getElementById('tarana_gammaPort'),
                document.getElementById('tarana_deltaPort')
            ];
            
            if (!deviceSelect) return;
            
            const selectedDevice = deviceSelect.value;
            // Hard restrict Tarana to CCR2004/CCR2216 only
            if (selectedDevice && !['ccr2004','ccr2216'].includes(selectedDevice)) {
                deviceSelect.value = '';
                alert('Tarana sectors are supported only on CCR2004 and CCR2216.');
                portSelects.forEach(ps => { if (ps) ps.innerHTML = '<option value="">None</option>'; });
                return;
            }
            const deviceConfig = DEVICE_CONFIGS[selectedDevice];
            
            if (!deviceConfig) {
                portSelects.forEach(portSelect => {
                    if (portSelect) {
                        portSelect.innerHTML = '<option value="">None</option>';
                    }
                });
                return;
            }
            
            // Clear existing options and add "None" option
            portSelects.forEach(portSelect => {
                if (portSelect) {
                    portSelect.innerHTML = '<option value="">None</option>';
                    
                    // Add all available ports (ethernet + SFP)
                    const allPorts = [...deviceConfig.ports, ...deviceConfig.sfpPorts];
                    
                    allPorts.forEach(port => {
                        const option = document.createElement('option');
                        option.value = port;
                        option.textContent = `${port} (${deviceConfig.name})`;
                        portSelect.appendChild(option);
                    });

                    // Preselect recommended Tarana ports when device is CCR2004/CCR2216
                    if (deviceConfig.name === 'CCR2004') {
                        if (portSelect.id === 'tarana_alphaPort') portSelect.value = 'sfp-sfpplus8';
                        if (portSelect.id === 'tarana_betaPort')  portSelect.value = 'sfp-sfpplus9';
                        if (portSelect.id === 'tarana_gammaPort') portSelect.value = 'sfp-sfpplus10';
                    } else if (deviceConfig.name === 'CCR2216') {
                        if (portSelect.id === 'tarana_alphaPort') portSelect.value = 'sfp28-1';
                        if (portSelect.id === 'tarana_betaPort')  portSelect.value = 'sfp28-2';
                        if (portSelect.id === 'tarana_gammaPort') portSelect.value = 'sfp28-3';
                    }
                }
            });
            
            console.log(`Tarana Sectors - Device selected: ${deviceConfig.name}`);
            console.log(`Ports updated for ${deviceConfig.name}`);
        }

        // Tarana Sectors RouterOS Version Handler
        function handleTaranaRouterOSChange() {
            const routerOSSelect = document.getElementById('tarana_routeros_version');
            if (!routerOSSelect) return;
            
            const selectedVersion = routerOSSelect.value;
            const versionType = getRouterOSVersionType(selectedVersion);
            // Force 7.x only for Tarana; reset if 6.x picked somehow
            if (selectedVersion && selectedVersion.startsWith('6.')) {
                routerOSSelect.value = '';
                alert('Tarana sectors require RouterOS 7.x.');
                return;
            }
            
            if (versionType === 'new') {
                console.log(`Tarana Sectors - RouterOS ${selectedVersion} - Using new speed syntax (e.g., 1G-baseT-full)`);
            } else {
                console.log(`Tarana Sectors - RouterOS ${selectedVersion} - Using legacy speed syntax (e.g., 1Gbps-duplex=full)`);
            }
        }

        // Move all constants to the top level to avoid redeclaration
        const SNMP_ADDRESSES = [
            '143.55.35.47', '107.178.15.15', '107.178.15.162', '142.147.112.4',
            '142.147.124.26', '107.178.5.97', '67.219.126.240/28', '198.100.53.120',
            '143.55.62.143', '132.147.138.2', '132.147.138.0', '132.147.138.6',
            '132.147.138.23', '132.147.138.29', '132.147.138.30', '132.147.138.31',
            '143.55.37.40', '143.55.37.41', '132.147.132.24', '198.100.49.99',
            '132.147.132.26', '204.11.183.126', '173.215.67.124', '132.147.138.3',
            '132.147.138.7', '132.147.138.21', '132.147.138.26'
        ];

        const WALLED_GARDEN_ADDRESSES = [
            '142.147.112.3', '142.147.112.19', '107.178.15.27',
            '142.147.112.12', '67.219.126.2'
        ];

        const DENIED_PREFIXES = [
            '10.2.0.14/32', '10.2.0.21/32', '10.2.0.107/32', '10.2.0.108/32',
            '10.17.0.10/32', '10.17.0.11/32', '10.30.0.9/32', '10.240.0.3/32',
            '10.243.0.9/32', '10.248.0.220/32', '10.249.0.220/32', '10.0.0.87/32',
            '10.9.0.88/32', '10.254.247.9/32'
        ];

        const ALLOWED_PREFIXES = [
            '10.2.0.10/32', '10.0.0.0/24', '10.0.1.0/24', '10.1.0.0/24', '10.2.0.0/24',
            '10.3.0.0/24', '10.4.0.0/24', '10.4.3.0/24', '10.5.0.0/24', '10.6.0.0/24',
            '10.7.0.0/24', '10.7.250.0/24', '10.7.254.0/24', '10.8.0.0/24', '10.9.0.0/24',
            '10.9.1.0/24', '10.9.2.0/24', '10.10.0.0/24', '10.11.0.0/24', '10.12.0.0/24',
            '10.13.0.0/24', '10.14.0.0/24', '10.15.0.0/24', '10.16.0.0/24', '10.17.0.0/24',
            '10.17.16.0/24', '10.17.18.0/24', '10.17.31.0/24', '10.17.48.0/24',
            '10.18.0.0/24', '10.18.2.0/24', '10.19.0.0/24', '10.21.0.0/24', '10.22.0.0/24',
            '10.25.0.0/24', '10.26.0.0/24', '10.27.0.0/24', '10.30.0.0/24', '10.32.0.0/24',
            '10.33.0.0/24', '10.34.0.0/24', '10.35.0.0/24', '10.36.0.0/24', '10.37.0.0/24',
            '10.39.0.0/24', '10.45.252.0/24', '10.47.0.0/24', '10.53.252.0/22',
            '10.254.243.0/24', '10.243.0.0/24', '10.54.0.0/22', '10.250.0.0/24',
            '10.250.40.0/22', '10.241.0.0/24', '10.241.64.0/22', '10.254.245.0/24',
            '10.254.249.0/24', '10.249.0.0/24', '10.249.7.0/24', '10.249.180.0/22',
            '10.254.247.0/24', '10.247.0.0/24', '10.247.13.0/24', '10.247.72.0/24',
            '10.247.147.0/24', '10.247.187.0/24', '10.247.64.0/22', '10.254.248.0/24',
            '10.248.0.0/24', '10.248.32.0/24', '10.248.36.0/24', '10.248.86.0/24',
            '10.248.208.0/22'
        ];

        function calculateNetwork(ipCidr) {
            if (!ipCidr || !ipCidr.includes('/')) return ipCidr;
            
            const [ip, cidr] = ipCidr.split('/');
            const octets = ip.split('.').map(Number);
            const prefix = parseInt(cidr);
            
            // Calculate subnet mask
            const mask = (0xFFFFFFFF << (32 - prefix)) >>> 0;
            
            // Calculate network address
            const ipNum = (octets[0] << 24 | octets[1] << 16 | octets[2] << 8 | octets[3]) >>> 0;
            const networkNum = (ipNum & mask) >>> 0;
            
            // Convert back to dotted decimal
            const networkOctets = [
                (networkNum >>> 24) & 0xFF,
                (networkNum >>> 16) & 0xFF,
                (networkNum >>> 8) & 0xFF,
                networkNum & 0xFF
            ];
            
            return networkOctets.join('.');
        }

        function addDHCPConfiguration(config, enableDHCP, routerId, dnsServers, dhcpSecret) {
            if (!enableDHCP) return config;

            const cgnatRange = document.getElementById('cgnatRange').value.trim() || '100.64.112.0/22';
            const cpeRange = document.getElementById('cpeRange').value.trim();
            const unauthRange = document.getElementById('unauthRange').value.trim();
            const vlan4000Range = document.getElementById('vlan4000Range').value.trim();
            
            // DHCP Options
            config += `/ip dhcp-server option\nadd code=66 name=option66-ata value="'http://ndp1-dal.nxlink.com/cfg/\$MA.cfg'"\nadd code=43 name=opt43 value=0x011768747470733a2f2f7573732e6e786c696e6b2e636f6d2f\n/ip dhcp-server option sets\nadd name=optset options=opt43\n`;
            
            // IP Pools
            config += `/ip pool\n`;
            if (cpeRange && cpeRange.includes('/')) {
                const [cpeNet] = cpeRange.split('/');
                const cpeOctets = cpeNet.split('.').map(Number);
                const cpeStart = `${cpeOctets[0]}.${cpeOctets[1]}.${cpeOctets[2]}.50`;
                const cpeEnd = `${cpeOctets[0]}.${cpeOctets[1]}.${cpeOctets[2] + 3}.254`;
                config += `add name=cpe ranges=${cpeStart}-${cpeEnd}\n`;
            }
            if (cgnatRange && cgnatRange.includes('/')) {
                const [cgnatNet] = cgnatRange.split('/');
                const cgnatOctets = cgnatNet.split('.').map(Number);
                const cgnatStart = `${cgnatOctets[0]}.${cgnatOctets[1]}.${cgnatOctets[2]}.3`;
                const cgnatEnd = `${cgnatOctets[0]}.${cgnatOctets[1]}.${cgnatOctets[2] + 3}.254`;
                config += `add name=cust ranges=${cgnatStart}-${cgnatEnd}\n`;
            }
            if (unauthRange && unauthRange.includes('/')) {
                const [unauthNet] = unauthRange.split('/');
                const unauthOctets = unauthNet.split('.').map(Number);
                const unauthStart = `${unauthOctets[0]}.${unauthOctets[1]}.${unauthOctets[2]}.2`;
                const unauthEnd = `${unauthOctets[0]}.${unauthOctets[1]}.${unauthOctets[2] + 3}.254`;
                config += `add name=unauth ranges=${unauthStart}-${unauthEnd}\n`;
            }
            if (document.getElementById('enableSWT').checked && vlan4000Range && vlan4000Range.includes('/')) {
                const [vlan4000Net] = vlan4000Range.split('/');
                const vlan4000Octets = vlan4000Net.split('.').map(Number);
                const vlan4000Start = `${vlan4000Octets[0]}.${vlan4000Octets[1]}.${vlan4000Octets[2]}.50`;
                const vlan4000End = `${vlan4000Octets[0]}.${vlan4000Octets[1]}.${vlan4000Octets[2] + 3}.254`;
                config += `add name=vlan4000 ranges=${vlan4000Start}-${vlan4000End}\n`;
            }

            // DHCP Servers
            config += `/ip dhcp-server\n`;
            config += `add address-pool=cust interface=lan-bridge lease-time=1h name=server1 use-radius=yes\n`;
            if (document.getElementById('enableSWT').checked && vlan4000Range) {
                config += `add address-pool=vlan4000 interface=bridge4000 lease-time=1h name=vlan4000\n`;
            }
            
            // DHCP Server Networks
            config += `/ip dhcp-server network\n`;
            if (cpeRange && cpeRange.includes('/')) {
                const [cpeNet, cpeCidr] = cpeRange.split('/');
                const cpeGateway = `${cpeNet.split('.')[0]}.${cpeNet.split('.')[1]}.${cpeNet.split('.')[2]}.1`;
                config += `add address=${cpeRange} dns-server=${dnsServers} gateway=${cpeGateway}\n`;
            }
            if (cgnatRange && cgnatRange.includes('/')) {
                const [cgnatNet, cgnatCidr] = cgnatRange.split('/');
                const cgnatGateway = `${cgnatNet.split('.')[0]}.${cgnatNet.split('.')[1]}.${cgnatNet.split('.')[2]}.1`;
                config += `add address=${cgnatRange} dns-server=${dnsServers} gateway=${cgnatGateway} dhcp-option-set=optset\n`;
            }
            if (unauthRange && unauthRange.includes('/')) {
                const [unauthNet, unauthCidr] = unauthRange.split('/');
                const unauthGateway = `${unauthNet.split('.')[0]}.${unauthNet.split('.')[1]}.${unauthNet.split('.')[2]}.1`;
                config += `add address=${unauthRange} dns-server=${dnsServers} gateway=${unauthGateway} dhcp-option-set=optset\n`;
            }
            if (document.getElementById('enableSWT').checked && vlan4000Range && vlan4000Range.includes('/')) {
                const [vlan4000Net, vlan4000Cidr] = vlan4000Range.split('/');
                const vlan4000Gateway = `${vlan4000Net.split('.')[0]}.${vlan4000Net.split('.')[1]}.${vlan4000Net.split('.')[2]}.1`;
                config += `add address=${vlan4000Range} dns-server=${dnsServers} gateway=${vlan4000Gateway}\n`;
            }

            // Always add the 100. range to DHCP server networks if CGNAT range is configured
            if (cgnatRange && cgnatRange.includes('/') && cgnatRange.startsWith('100.')) {
                const [cgnatNet, cgnatCidr] = cgnatRange.split('/');
                const cgnatGateway = cgnatNet.split('.').map((octet, i) => i === 3 ? '1' : octet).join('.');
                config += `add address=${cgnatNet}/${cgnatCidr} dhcp-option-set=optset dns-server=${dnsServers} gateway=${cgnatGateway} netmask=${cgnatCidr}\n`;
            }

            // RADIUS configuration - DHCP only (no login services)
            config += `/radius\n`;
            config += `add address=142.147.112.2 secret=${dhcpSecret} service=dhcp src-address=${routerId} timeout=5s\n`;
            config += `add address=142.147.112.18 secret=${dhcpSecret} service=dhcp src-address=${routerId} timeout=5s\n`;

            return config;
        }

        function addFirewallConfiguration(config, enableDHCP, enableMPLS) {
            // IP Firewall Address List
            config += `/ip firewall address-list\n`;
            config += `add address=10.0.0.0/8 list=EOIP-ALLOW\n`;
            config += `add address=192.168.128.0/21 list=managerIP\n`;
            config += `add address=107.178.5.97 list=managerIP\n`;
            config += `add address=198.100.53.0/25 list=managerIP\n`;
            config += `add address=143.55.62.143 list=managerIP\n`;
            config += `add address=142.147.127.2 list=managerIP\n`;
            config += `add address=132.147.132.6 list=managerIP\n`;
            config += `add address=67.219.122.201 list=managerIP\n`;
            config += `add address=10.249.1.26 list=managerIP\n`;
            config += `add address=10.0.0.0/8 list=managerIP\n`;
            config += `add address=10.0.0.0/8 list=BGP-ALLOW\n`;

            if (enableDHCP) {
                const cgnatRange = document.getElementById('cgnatRange').value.trim();
                const unauthRange = document.getElementById('unauthRange').value.trim();
                if (cgnatRange) config += `add address=${cgnatRange} list=bgp-networks\n`;
                if (unauthRange) {
                    config += `add address=${unauthRange} list=bgp-networks\n`;
                    config += `add address=${unauthRange} list=unauth\n`;
                }
                WALLED_GARDEN_ADDRESSES.forEach(addr => {
                    config += `add address=${addr} list=WALLED-GARDEN\n`;
                });
            }
            
            SNMP_ADDRESSES.forEach(addr => {
                config += `add address=${addr} list=SNMP\n`;
            });

            // Add static customers to firewall address lists
            const staticCustomers = Array.from(document.querySelectorAll('#staticCustomers .customer-item:not(#customerTemplate)'))
                .map(item => ({
                    name: item.querySelector('input[name="customerName"]')?.value,
                    range: item.querySelector('input[name="customerRange"]')?.value,
                    comment: item.querySelector('input[name="customerComment"]')?.value
                }))
                .filter(customer => customer.name && customer.range);
            
            staticCustomers.forEach(customer => {
                config += `add address=${customer.range} comment="${customer.comment || customer.name}" list=static-customers\n`;
            });

            // IP Firewall Filter
            config += `/ip firewall filter\n`;
            config += `add action=accept chain=input comment="ALLOW EST REL" connection-state=established,related,untracked\n`;
            config += `add action=accept chain=input comment="ALLOW MT NEIGHBOR" dst-port=5678 protocol=udp\n`;
            config += `add action=accept chain=input comment="ALLOW MAC TELNET" dst-port=20561 protocol=udp\n`;
            config += `add action=accept chain=input comment="ALLOW IGMP" protocol=igmp\n`;
            config += `add action=accept chain=input comment="ALLOW ICMP" protocol=icmp\n`;
            config += `add action=accept chain=input comment="ALLOW DHCPv4" dst-port=67 protocol=udp\n`;
            config += `add action=accept chain=input comment="ALLOW DHCPv6" dst-port=547 protocol=udp\n`;
            config += `add action=accept chain=input comment="ALLOW OSPF" protocol=ospf\n`;
            if (enableMPLS) {
                config += `add action=accept chain=input comment="ALLOW LDP" dst-port=646 protocol=tcp\n`;
                config += `add action=accept chain=input comment="ALLOW LDP" dst-port=646 protocol=udp\n`;
            }
            config += `add action=accept chain=input comment="ALLOW MANAGER IP" src-address-list=managerIP\n`;
            config += `add action=accept chain=input comment="ALLOW BGP" dst-port=179 protocol=tcp src-address-list=BGP-ALLOW\n`;
            config += `add action=accept chain=input comment="ALLOW EOIP" protocol=gre src-address-list=EOIP-ALLOW\n`;
            config += `add action=accept chain=input comment="ALLOW SNMP" dst-port=161 protocol=tcp src-address-list=SNMP\n`;
            config += `add action=accept chain=input comment="ALLOW SNMP" dst-port=161 protocol=udp src-address-list=SNMP\n`;
            config += `add action=drop chain=input comment="DROP INPUT"\n`;
            config += `add action=accept chain=forward comment="BGP Accept" dst-address=10.0.0.0/8 dst-port=179 protocol=tcp src-address=10.0.0.0/8\n`;
            config += `add action=accept chain=forward comment="GRE Accept" dst-address=10.0.0.0/8 protocol=gre src-address=10.0.0.0/8\n`;
            if (enableDHCP) {
                config += `add action=drop chain=forward comment="unauth drop rule" dst-address-list=!WALLED-GARDEN src-address-list=unauth\n`;
            }
            // Allow static customers full access
            if (staticCustomers.length > 0) {
                config += `add action=accept chain=forward comment="Allow static customers" src-address-list=static-customers\n`;
            }
            config += `add action=fasttrack-connection chain=forward connection-state=established,related,untracked hw-offload=yes\n`;
            config += `add action=accept chain=forward connection-state=established,related,untracked\n`;

            // IP Firewall NAT - Dynamic rules based on user configuration
            config += `/ip firewall nat\n`;
            config += `add action=redirect chain=dstnat dst-port=5022 protocol=tcp to-ports=22\n`;
            
            // Dynamic src-nat rules based on user IP configuration
            const natPublicIP = document.getElementById('natPublicIP').value.trim();
            const lanBridgeIP = document.getElementById('lanBridgeIP').value.trim();
            
            if (natPublicIP && lanBridgeIP) {
                const natIP = natPublicIP.includes('/') ? natPublicIP.split('/')[0] : natPublicIP;
                const lanNetwork = calculateNetwork(lanBridgeIP);
                const lanCidr = lanBridgeIP.split('/')[1];
                
                // Source NAT for LAN traffic
                config += `add action=src-nat chain=srcnat comment="LAN to Internet NAT" out-interface=all src-address=${lanNetwork}/${lanCidr} to-addresses=${natIP}\n`;
            }
            
            if (enableDHCP) {
                config += `add action=dst-nat chain=dstnat comment="unauth proxy rule" dst-address-list=!WALLED-GARDEN dst-port=80 protocol=tcp src-address-list=unauth to-addresses=107.178.15.27 to-ports=3128\n`;
                
                // Dynamic dst-nat rules for DHCP ranges
                const cgnatRange = document.getElementById('cgnatRange').value.trim();
                const unauthRange = document.getElementById('unauthRange').value.trim();
                
                if (cgnatRange && natPublicIP) {
                    const natIP = natPublicIP.includes('/') ? natPublicIP.split('/')[0] : natPublicIP;
                    config += `add action=dst-nat chain=dstnat comment="CGNAT to Public" dst-address=${cgnatRange} to-addresses=${natIP}\n`;
                }
                
                if (unauthRange && natPublicIP) {
                    const natIP = natPublicIP.includes('/') ? natPublicIP.split('/')[0] : natPublicIP;
                    config += `add action=dst-nat chain=dstnat comment="Unauth to Public" dst-address=${unauthRange} to-addresses=${natIP}\n`;
                }
            }

            // IP Firewall Raw
            config += `/ip firewall raw\nadd action=drop chain=prerouting comment="DROP BAD UDP" port=0 protocol=udp\n`;

            // IP Firewall Service-Port
            config += `/ip firewall service-port\nset sip disabled=yes\n`;

            return config;
        }
        function addMPLSConfiguration(config, enableMPLS, uplinkCount, deviceConfig) {
            // MPLS LDP Filters (always added for security)
            config += `/mpls ldp accept-filter\n`;
            DENIED_PREFIXES.forEach(prefix => {
                config += `add accept=no disabled=no prefix=${prefix}\n`;
            });
            ALLOWED_PREFIXES.forEach(prefix => {
                config += `add accept=yes disabled=no prefix=${prefix}\n`;
            });
            config += `add accept=no disabled=no prefix=0.0.0.0/0\n`;
            
            config += `/mpls ldp advertise-filter\n`;
            DENIED_PREFIXES.forEach(prefix => {
                config += `add advertise=no disabled=no prefix=${prefix}\n`;
            });
            ALLOWED_PREFIXES.forEach(prefix => {
                config += `add advertise=yes disabled=no prefix=${prefix}\n`;
            });
            config += `add advertise=no disabled=no prefix=0.0.0.0/0\n`;

            if (enableMPLS) {
                const mplsMtu = document.getElementById('mplsMtu').value || '9000';
                const ldpTransport = document.getElementById('ldpTransport').value || document.getElementById('routerId').value;
                
                config += `/mpls interface\nadd disabled=no interface=all mpls-mtu=${mplsMtu}\n`;
                config += `/mpls ldp\nadd afi=ip disabled=no distribute-for-default=no hop-limit=255 loop-detect=no lsr-id=${ldpTransport} path-vector-limit=255 transport-addresses=${ldpTransport} use-explicit-null=no vrf=main\n`;
                
                config += `/mpls ldp interface\n`;
                // Process all uplinks dynamically for MPLS LDP
                const allUplinkElements = document.querySelectorAll('#uplinks .uplink-item:not(#uplinkTemplate)');
                allUplinkElements.forEach((element, index) => {
                    const port = element.querySelector('select[id*="NewPort"]')?.value;
                    const comment = element.querySelector('input[id*="Comment"]')?.value || `Uplink-${index + 1}`;
                    if (port) {
                        config += `add comment="${comment}" disabled=no interface=${port}\n`;
                    }
                });
            }

            return config;
        }
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize counters first
            let vlanCount = 0;
            let vplsCount = 0;
            let customerCount = 0;
            let uplinkCount = 1;
            let portCount = 0;

            // Dark mode toggle will be handled in initializeEventHandlers

            // DHCP toggle and other event handlers moved to initializeEventHandlers

            function calculateDHCPRanges() {
                const lanBridgeIP = document.getElementById('lanBridgeIP').value.trim();
                if (lanBridgeIP && lanBridgeIP.includes('/')) {
                    const [ip] = lanBridgeIP.split('/');
                    const octets = ip.split('.').map(Number);
                    
                    // CPE Range - use the LAN bridge network directly
                    document.getElementById('cpeRange').value = calculateNetwork(lanBridgeIP) + '/' + lanBridgeIP.split('/')[1];
                    
                    // Unauth Range - add 100 to the SECOND octet (10.45.x.x becomes 10.145.x.x)
                    if (octets[1] !== undefined) {
                        const unauthSecondOctet = octets[1] + 100;
                        const unauthRange = `${octets[0]}.${unauthSecondOctet}.${octets[2]}.0/${lanBridgeIP.split('/')[1]}`;
                        document.getElementById('unauthRange').value = unauthRange;
                    }
                }
                
                // VLAN 4000 range from VLAN 4000 subnet if provided
                const vlan4000Subnet = document.getElementById('vlan4000Subnet').value.trim();
                if (vlan4000Subnet && vlan4000Subnet.includes('/')) {
                    document.getElementById('vlan4000Range').value = calculateNetwork(vlan4000Subnet) + '/' + vlan4000Subnet.split('/')[1];
                }
            }

            // Refactored VLAN and VPLS functions with preset support
            function addVlan(preset = {}) {
                if (vlanCount >= 10) return null;
                const tpl = document.getElementById('vlanTemplate').cloneNode(true);
                tpl.style.display = 'block';
                const num = ++vlanCount;
                tpl.id = `vlan${num}`;
                
                // Safer element selection using name attributes
                const selParent  = tpl.querySelector('select[name="vlanParent"]') || tpl.querySelector('select');
                const inpId      = tpl.querySelector('input[name="vlanId"]');
                const inpComment = tpl.querySelector('input[name="vlanComment"]');
                const inpBridge  = tpl.querySelector('input[name="vlanBridge"]');
                
                // Assign unique IDs
                if (selParent)  selParent.id  = `vlan${num}Parent`;
                if (inpId)      inpId.id      = `vlan${num}Id`;
                if (inpComment) inpComment.id = `vlan${num}Comment`;
                if (inpBridge)  inpBridge.id  = `vlan${num}Bridge`;
                
                // Populate port options for the new VLAN parent interface
                if (selParent) {
                    const targetDevice = document.getElementById('targetDevice').value;
                    const currentDevice = document.getElementById('currentDevice').value;
                    const selectedDevice = targetDevice || currentDevice;
                    
                    if (selectedDevice && DEVICE_CONFIGS[selectedDevice]) {
                        const allPorts = [...DEVICE_CONFIGS[selectedDevice].ports, ...DEVICE_CONFIGS[selectedDevice].sfpPorts];
                        selParent.innerHTML = '';
                        allPorts.forEach(port => {
                            const option = document.createElement('option');
                            option.value = port;
                            option.textContent = port;
                            selParent.appendChild(option);
                        });
                    }
                }
                
                // Fill values with preset data
                if (selParent)  selParent.value  = preset.parent  ?? (selParent.options[0] ? selParent.options[0].value : '');
                if (inpId)      inpId.value      = preset.vid     ?? '';
                if (inpComment) inpComment.value = preset.comment ?? '';
                if (inpBridge)  inpBridge.value  = preset.bridge  ?? '';
                
                // Remove handler
                const btn = tpl.querySelector('button');
                if (btn) btn.onclick = () => {
                    tpl.remove();
                    vlanCount--;
                    document.getElementById('addVlanBtn').disabled = vlanCount >= 10;
                };
                
                document.getElementById('vlanInterfaces').appendChild(tpl);
                if (vlanCount === 10) document.getElementById('addVlanBtn').disabled = true;
                return tpl;
            }

            function addVpls(preset = {}) {
                if (vplsCount >= 8) return null;
                const tpl = document.getElementById('vplsTemplate').cloneNode(true);
                tpl.style.display = 'block';
                const num = ++vplsCount;
                tpl.id = `vpls${num}`;
                
                // Safer element selection using name attributes
                const inpName    = tpl.querySelector('input[name="vplsName"]');
                const inpBridge  = tpl.querySelector('input[name="vplsBridge"]');
                const inpPeer    = tpl.querySelector('input[name="vplsPeer"]');
                const inpStatic  = tpl.querySelector('input[name="vplsStaticId"]');
                
                // Assign unique IDs
                if (inpName)   inpName.id   = `vpls${num}Name`;
                if (inpBridge) inpBridge.id = `vpls${num}Bridge`;
                if (inpPeer)   inpPeer.id   = `vpls${num}Peer`;
                if (inpStatic) inpStatic.id = `vpls${num}StaticId`;
                
                // Fill values with preset data
                if (inpName)   inpName.value   = preset.name    ?? '';
                if (inpBridge) inpBridge.value = preset.bridge  ?? '';
                if (inpPeer)   inpPeer.value   = preset.peer    ?? '';
                if (inpStatic) inpStatic.value = preset.staticId ?? '';
                
                // Remove handler
                const btn = tpl.querySelector('button');
                if (btn) btn.onclick = () => {
                    tpl.remove();
                    vplsCount--;
                    document.getElementById('addVplsBtn').disabled = vplsCount >= 8;
                };
                
                document.getElementById('vplsInstances').appendChild(tpl);
                if (vplsCount === 8) document.getElementById('addVplsBtn').disabled = true;
                return tpl;
            }

            function updateVlanCount() {
                vlanCount = document.querySelectorAll('.vlan-item:not(#vlanTemplate)').length;
                document.getElementById('addVlanBtn').disabled = vlanCount >= 10;
            }

            function updateVplsCount() {
                vplsCount = document.querySelectorAll('.vpls-item:not(#vplsTemplate)').length;
                document.getElementById('addVplsBtn').disabled = vplsCount >= 8;
            }

            function vplsBaseForArea(area) {
                if (area === 'area243-v2') return 1000;   // use VID directly
                if (area === 'area249')    return 1249;
                if (area === 'area248-v2') return 1248;
                if (area === 'area250')    return 1250;
                if (area === 'area42-v2' || area === 'area42') return 1245;
                if (area === 'backbone-v2-IL') return 1247;
                return null;
            }

            function autoPopulateVpls(area, defaultPeer = '10.249.0.200') {
                const base = vplsBaseForArea(area);
                if (base == null) return;
                
                // Clear existing VPLS instances first
                document.querySelectorAll('.vpls-item:not(#vplsTemplate)').forEach(el => el.remove());
                vplsCount = 0;
                
                // Read VIDs from existing VLAN rows
                const vids = Array.from(document.querySelectorAll('#vlanInterfaces .vlan-item:not(#vlanTemplate) input[name="vlanId"]'))
                    .map(i => Number(i.value)).filter(Boolean);
                    
                vids.forEach(vid => {
                    const staticId = base === 1000 ? vid : base + (vid - 1000);
                    addVpls({
                        name:    `vpls${vid}-bng1`,
                        bridge:  vid === 1000 ? 'bridge1000' : `bridge${vid}`,
                        peer:    defaultPeer,
                        staticId: String(staticId)
                    });
                });
                
                updateVplsCount();
            }

            // OSPF Area management with automatic protocol selection
            const ospfAreaMap = {
                'backbone-v2': { id: '0.0.0.243', bgp: true, mpls: false, vplsBase: null },
                'backbone-v2-IL': { id: '0.0.0.243', bgp: false, mpls: true, vplsBase: 1247 },
                'area243-v2': { id: '0.0.0.243', bgp: false, mpls: true, vplsBase: 1000 },
                'area248-v2': { id: '0.0.0.248', bgp: false, mpls: true, vplsBase: 1248 },
                'area249': { id: '0.0.0.249', bgp: false, mpls: true, vplsBase: 1249 },
                'area250': { id: '0.0.0.250', bgp: false, mpls: true, vplsBase: 1250 },
                'area42-v2': { id: '0.0.0.42', bgp: false, mpls: true, vplsBase: 1245 },
                'area42': { id: '0.0.0.42', bgp: false, mpls: true, vplsBase: 1245 }
            };

            // Function to handle OSPF area changes
            function handleOspfAreaChange(selectedArea) {
                const customInput = document.getElementById('ospfAreaCustom');
                const areaIdInput = document.getElementById('ospfAreaId');
                const bgpSection = document.getElementById('bgpSection');
                const enableMPLS = document.getElementById('enableMPLS');
                const enableVPLS = document.getElementById('enableVPLS');
                const enableDHCP = document.getElementById('enableDHCP');
                const dhcpSection = document.getElementById('dhcpSection');

                if (selectedArea === 'custom') {
                    customInput.style.display = 'block';
                    areaIdInput.readOnly = false;
                    areaIdInput.value = '0.0.0.0';
                } else {
                    customInput.style.display = 'none';
                    areaIdInput.readOnly = true;
                    
                    const areaConfig = ospfAreaMap[selectedArea];
                    if (areaConfig) {
                        areaIdInput.value = areaConfig.id;
                        
                        // Auto-configure protocols based on area
                        if (areaConfig.bgp) {
                            bgpSection.style.display = 'block';
                            enableMPLS.checked = false;
                            enableVPLS.checked = false;
                            document.querySelector('.mpls-section').style.display = 'none';
                            document.querySelector('.vpls-section').style.display = 'none';
                            // Enable DHCP for backbone-v2 areas
                            enableDHCP.checked = true;
                            dhcpSection.style.display = 'block';
                            calculateDHCPRanges();
                        } else {
                            bgpSection.style.display = 'none';
                            // Disable DHCP for MPLS areas (they use BNGs)
                            enableDHCP.checked = false;
                            dhcpSection.style.display = 'none';
                            if (areaConfig.mpls) {
                                enableMPLS.checked = true;
                                enableVPLS.checked = true;
                                document.querySelector('.mpls-section').style.display = 'block';
                                document.querySelector('.vpls-section').style.display = 'block';
                                // Auto-populate VPLS profile and instances for non-BGP areas
                                if (!document.getElementById('enableTarana').checked && !document.getElementById('enableSWT').checked) {
                                    document.getElementById('vlanProfile').value = 'vpls';
                                    populateVlanProfile('vpls');
                                }
                                // Always populate VPLS instances for MPLS areas
                                setTimeout(() => autoPopulateVpls(selectedArea), 100); // Small delay to ensure VLANs are populated first
                            }
                        }
                    }
                }
            }

            document.getElementById('ospfArea').addEventListener('change', (e) => {
                handleOspfAreaChange(e.target.value);
            });

            // Initialize with default area selection (backbone-v2)
            handleOspfAreaChange('backbone-v2');

            // Initialize DHCP ranges on page load
            calculateDHCPRanges();

            // Tarana event listeners moved to initializeEventHandlers

            function populateTaranaVlans() {
                // Clear existing Tarana VLANs first
                document.querySelectorAll('.vlan-item:not(#vlanTemplate)').forEach(el => {
                    const portSelect = el.querySelector('select[name="vlanParent"]');
                    if (portSelect && ['sfp-sfpplus6', 'sfp-sfpplus8', 'sfp-sfpplus9', 'sfp-sfpplus10'].includes(portSelect.value)) {
                        el.remove();
                        vlanCount--;
                    }
                });

                const fourthSector = document.getElementById('enableTaranaFourthSector').checked;
                
                // Standard Tarana ports with Greek letter names: Alpha, Beta, Gamma, Delta
                const taranaPorts = [
                    { port: 'sfp-sfpplus8', name: 'Alpha' },
                    { port: 'sfp-sfpplus9', name: 'Beta' },
                    { port: 'sfp-sfpplus10', name: 'Gamma' }
                ];
                
                if (fourthSector) {
                    taranaPorts.push({ port: 'sfp-sfpplus6', name: 'Delta' });
                }

                // VLAN configuration: always tagged 1000, 2000, 3000 on each port
                const vlanConfigs = [
                    { vid: 1000, comment: 'Dynamic VLAN', bridge: 'lan-bridge' },
                    { vid: 2000, comment: 'Static VLAN', bridge: 'bridge2000' },
                    { vid: 3000, comment: 'Infra VLAN', bridge: 'bridge3000' }
                ];

                taranaPorts.forEach(({ port, name }) => {
                    // Create VLANs 1000, 2000, 3000 on each Tarana port
                    vlanConfigs.forEach(vlanConfig => {
                        addVlan({
                            parent: port,
                            vid: String(vlanConfig.vid),
                            comment: `${vlanConfig.comment} - Sector ${name}`,
                            bridge: vlanConfig.bridge
                        });
                    });
                });
            }

            document.getElementById('enableSWT').addEventListener('change', (e) => {
                if (e.target.checked) {
                    document.getElementById('enableTarana').checked = false;
                    document.getElementById('vlanProfile').value = 'nonvpls';
                    populateVlanProfile('nonvpls');
                }
                toggleVlanSection();
            });
            document.getElementById('enableVPLS').addEventListener('change', (e) => {
                document.querySelector('.vpls-section').style.display = e.target.checked ? 'block' : 'none';
                if (e.target.checked) {
                    // Auto-select VPLS profile and populate VLANs
                    document.getElementById('vlanProfile').value = 'vpls';
                    populateVlanProfile('vpls');
                }
            });
            
            // MPLS event listener moved to initializeEventHandlers

            function toggleVlanSection() {
                // VLANs shown only when SWT is enabled. Enabling Tarana does not expose VLAN subnet fields.
                document.getElementById('vlanSection').style.display = document.getElementById('enableSWT').checked ? 'grid' : 'none';
            }

            // VLAN Profile auto-population using refactored functions
            function populateVlanProfile(profile) {
                const profileSets = {
                    nonvpls: [
                        { vid: '1000', parent: 'sfp-sfpplus1', comment: 'Dynamic VLAN', bridge: 'lan-bridge' },
                        { vid: '2000', parent: 'sfp-sfpplus1', comment: 'Static VLAN', bridge: 'bridge2000' },
                        { vid: '3000', parent: 'sfp-sfpplus1', comment: 'Infra VLAN', bridge: 'bridge3000' },
                        { vid: '4000', parent: 'sfp-sfpplus1', comment: 'SWT/CPE VLAN', bridge: 'bridge4000' }
                    ],
                    vpls: [
                        { vid: '1000', parent: 'sfp-sfpplus1', comment: 'VPLS Dynamic', bridge: 'bridge1000' },
                        { vid: '2000', parent: 'sfp-sfpplus1', comment: 'VPLS Static', bridge: 'bridge2000' },
                        { vid: '3000', parent: 'sfp-sfpplus1', comment: 'VPLS Infra', bridge: 'bridge3000' },
                        { vid: '4000', parent: 'sfp-sfpplus1', comment: 'VPLS CPE', bridge: 'bridge4000' }
                    ]
                };
                
                const vlans = profileSets[profile] || [];
                if (!vlans.length) return;
                
                // Clear existing VLAN interfaces
                document.querySelectorAll('.vlan-item:not(#vlanTemplate)').forEach(el => el.remove());
                vlanCount = 0;
                
                // Add profile VLANs using refactored function
                vlans.forEach(vlan => {
                    addVlan(vlan);
                });
                
                updateVlanCount();
            }

            // btnPopulateVlans event listener moved to initializeEventHandlers

            // VLAN interface management (starting with no default interfaces)

            // VPLS management (starting with no default instances)
            
            function addVpls() {
                const template = document.getElementById('vplsTemplate').cloneNode(true);
                template.style.display = 'block';
                const num = ++vplsCount;
                template.id = `vpls${num}`;
                
                // Update IDs
                template.querySelector('input[name="vplsName"]').id = `vpls${num}Name`;
                template.querySelector('input[name="vplsBridge"]').id = `vpls${num}Bridge`;
                template.querySelector('input[name="vplsPeer"]').id = `vpls${num}Peer`;
                template.querySelector('input[name="vplsStaticId"]').id = `vpls${num}StaticId`;
                
                // Update remove button
                template.querySelector('button').onclick = () => {
                    template.remove();
                    vplsCount--;
                };
                
                document.getElementById('vplsInstances').appendChild(template);
            }
            
            function updateVplsCount() {
                vplsCount = document.querySelectorAll('#vplsInstances .vpls-item:not(#vplsTemplate)').length;
            }

            // Port configuration management (variable already declared above)
            
            function addPort(preset = {}) {
                if (portCount >= 12) return null;
                const tpl = document.getElementById('portTemplate').cloneNode(true);
                tpl.style.display = 'block';
                const num = ++portCount;
                tpl.id = `port${num}`;
                
                // Assign unique IDs
                const selPort = tpl.querySelector('select[name="portName"]');
                const selSpeed = tpl.querySelector('select[name="portSpeed"]');
                const inpComment = tpl.querySelector('input[name="portComment"]');
                const selBridge = tpl.querySelector('select[name="portBridge"]');
                const inpMtu = tpl.querySelector('input[name="portMtu"]');
                const inpL2Mtu = tpl.querySelector('input[name="portL2Mtu"]');
                
                if (selPort) selPort.id = `port${num}Name`;
                if (selSpeed) selSpeed.id = `port${num}Speed`;
                if (inpComment) inpComment.id = `port${num}Comment`;
                if (selBridge) selBridge.id = `port${num}Bridge`;
                if (inpMtu) inpMtu.id = `port${num}Mtu`;
                if (inpL2Mtu) inpL2Mtu.id = `port${num}L2Mtu`;
                
                // Populate port options for the new port configuration
                if (selPort) {
                    const targetDevice = document.getElementById('targetDevice').value;
                    const currentDevice = document.getElementById('currentDevice').value;
                    const selectedDevice = targetDevice || currentDevice;
                    
                    if (selectedDevice && DEVICE_CONFIGS[selectedDevice]) {
                        const allPorts = [...DEVICE_CONFIGS[selectedDevice].ports, ...DEVICE_CONFIGS[selectedDevice].sfpPorts];
                        selPort.innerHTML = '';
                        allPorts.forEach(port => {
                            const option = document.createElement('option');
                            option.value = port;
                            option.textContent = port;
                            selPort.appendChild(option);
                        });
                    }
                }
                
                // Fill values with preset data
                if (selPort) selPort.value = preset.port ?? (selPort.options[0] ? selPort.options[0].value : '');
                if (selSpeed) selSpeed.value = preset.speed ?? '1Gbps';
                if (inpComment) inpComment.value = preset.comment ?? '';
                if (selBridge) selBridge.value = preset.bridge ?? '';
                if (inpMtu) inpMtu.value = preset.mtu ?? '';
                if (inpL2Mtu) inpL2Mtu.value = preset.l2mtu ?? '';
                
                // Remove handler
                const btn = tpl.querySelector('button');
                if (btn) btn.onclick = () => {
                    tpl.remove();
                    portCount--;
                    document.getElementById('addPortBtn').disabled = portCount >= 12;
                };
                
                document.getElementById('portConfigs').appendChild(tpl);
                if (portCount === 12) document.getElementById('addPortBtn').disabled = true;
                return tpl;
            }


            function autoPopulateTaranaPorts() {
                // Clear existing Tarana ports first
                document.querySelectorAll('#portConfigs .uplink-item:not(#portTemplate)').forEach(el => {
                    const portSelect = el.querySelector('select[name="portName"]');
                    if (portSelect && ['sfp-sfpplus8', 'sfp-sfpplus9', 'sfp-sfpplus10'].includes(portSelect.value)) {
                        el.remove();
                        portCount--;
                    }
                });
                
                const taranaPorts = [
                    { port: 'sfp-sfpplus8', comment: 'Tarana Alpha' },
                    { port: 'sfp-sfpplus9', comment: 'Tarana Beta' },
                    { port: 'sfp-sfpplus10', comment: 'Tarana Gamma' }
                ];
                
                if (document.getElementById('enableTaranaFourthSector')?.checked) {
                    taranaPorts.push({ port: 'sfp-sfpplus6', comment: 'Tarana Sector Delta' });
                }
                
                taranaPorts.forEach(({ port, comment }) => {
                    addPort({
                        port: port,
                        speed: '10Gbps',
                        comment: comment,
                        mtu: '1500',
                        l2mtu: '1592'
                    });
                });
            }
            function autoPopulateNetonixPorts() {
                // Clear existing Netonix ports first
                document.querySelectorAll('#portConfigs .uplink-item:not(#portTemplate)').forEach(el => {
                    const portSelect = el.querySelector('select[name="portName"]');
                    if (portSelect && ['sfp-sfpplus1', 'sfp-sfpplus2'].includes(portSelect.value)) {
                        el.remove();
                        portCount--;
                    }
                });
                
                const netonixPorts = [
                    { port: 'sfp-sfpplus1', comment: 'Netonix Uplink #1' },
                    { port: 'sfp-sfpplus2', comment: 'Netonix Uplink #2' }
                ];
                
                netonixPorts.forEach(({ port, comment }) => {
                    addPort({
                        port: port,
                        speed: '1Gbps',
                        comment: comment,
                        bridge: 'lan-bridge',
                        mtu: '1500',
                        l2mtu: '1592'
                    });
                });
            }

            // Event handlers will be set up in DOMContentLoaded
            
            function addCustomer() {
                const template = document.getElementById('customerTemplate').cloneNode(true);
                template.style.display = 'block';
                const num = ++customerCount;
                template.id = `customer${num}`;
                
                // Update IDs
                template.querySelector('input[name="customerName"]').id = `customer${num}Name`;
                template.querySelector('input[name="customerRange"]').id = `customer${num}Range`;
                template.querySelector('input[name="customerComment"]').id = `customer${num}Comment`;
                
                // Update remove button
                template.querySelector('button').onclick = () => {
                    template.remove();
                    customerCount--;
                };
                
                document.getElementById('staticCustomers').appendChild(template);
            }
            
            function updateCustomerCount() {
                customerCount = document.querySelectorAll('#staticCustomers .customer-item:not(#customerTemplate)').length;
            }

            // Device selection functionality will be set up in DOMContentLoaded
            
            function updatePortLabels() {
                // Update uplink port labels based on selected device and port
                const targetDevice = document.getElementById('targetDevice').value;
                const deviceConfig = DEVICE_CONFIGS[targetDevice];
                const uplink1NewPort = document.getElementById('uplink1NewPort');
                const uplink1NewPortLabel = document.getElementById('uplink1NewPortLabel');
                
                if (uplink1NewPort && uplink1NewPortLabel && deviceConfig) {
                    const selectedPort = uplink1NewPort.value;
                    let portType = '';
                    
                    if (selectedPort.includes('sfp-sfpplus')) {
                        portType = 'SFP+';
                    } else if (selectedPort.includes('sfp28')) {
                        portType = 'SFP28';
                    } else if (selectedPort.includes('qsfp28')) {
                        portType = 'QSFP28';
                    } else if (selectedPort.includes('ether')) {
                        portType = 'Ethernet';
                    } else if (selectedPort.includes('sfp')) {
                        portType = 'SFP';
                    }
                    
                    uplink1NewPortLabel.textContent = `New Port (${deviceConfig.name}, ${portType}):`;
                }
            }

            function updateUplinksDescription() {
                const targetDevice = document.getElementById('targetDevice').value || 'ccr2004';
                const deviceConfig = DEVICE_CONFIGS[targetDevice] || DEVICE_CONFIGS.ccr2004;
                const descriptionElement = document.getElementById('uplinksDescription');
                
                if (descriptionElement) {
                    let portDescription = '';
                    
                    // Get the appropriate port naming based on device
                    if (targetDevice === 'rb1009' || targetDevice === 'rb2011') {
                        portDescription = 'ether2 onwards';
                    } else if (targetDevice === 'ccr1036') {
                        portDescription = 'ether1 onwards';
                    } else if (targetDevice === 'rb5009') {
                        portDescription = 'ether2 onwards';
                    } else if (targetDevice === 'ccr2004') {
                        portDescription = 'sfp-sfpplus4 downwards';
                    } else if (targetDevice === 'ccr2216') {
                        portDescription = 'sfp28-1 onwards';
                    } else {
                        portDescription = 'available ports';
                    }
                    
                    descriptionElement.textContent = `Up to 4; generates ethernet sets, /ip address, OSPF templates (ptp type). Uses ${portDescription}.`;
                }
            }

            function updateDevicePorts() {
                const targetDevice = document.getElementById('targetDevice').value;
                const currentDevice = document.getElementById('currentDevice').value;
                
                // Use target device if selected, otherwise use current device
                const selectedDevice = targetDevice || currentDevice;
                
                if (selectedDevice && DEVICE_CONFIGS[selectedDevice]) {
                    const deviceConfig = DEVICE_CONFIGS[selectedDevice];
                    const allPorts = [...deviceConfig.ports, ...deviceConfig.sfpPorts];
                    
                    // Update uplink port options
                    const uplinkSelects = document.querySelectorAll('#uplinks select[id*="NewPort"]');
                    uplinkSelects.forEach(select => {
                        const currentValue = select.value;
                        select.innerHTML = '';
                        
                        allPorts.forEach(port => {
                            const option = document.createElement('option');
                            option.value = port;
                            option.textContent = port;
                            select.appendChild(option);
                        });
                        
                        // Restore previous value if it exists in new options
                        if (allPorts.includes(currentValue)) {
                            select.value = currentValue;
                        }
                    });
                    
                    // Update uplink template
                    const templateSelect = document.getElementById('uplinkTemplate').querySelector('select');
                    templateSelect.innerHTML = '';
                    allPorts.forEach(port => {
                        const option = document.createElement('option');
                        option.value = port;
                        option.textContent = port;
                        templateSelect.appendChild(option);
                    });
                    
                    // Update port configuration dropdowns
                    const portConfigSelects = document.querySelectorAll('#portConfigs select[name="portName"]');
                    portConfigSelects.forEach(select => {
                        const currentValue = select.value;
                        select.innerHTML = '';
                        
                        allPorts.forEach(port => {
                            const option = document.createElement('option');
                            option.value = port;
                            option.textContent = port;
                            select.appendChild(option);
                        });
                        
                        // Restore previous value if it exists in new options
                        if (allPorts.includes(currentValue)) {
                            select.value = currentValue;
                        }
                    });
                    // Populate Tarana port selects so all device ports are available
                    const taranaSelectIds = ['tower_tarana_alpha', 'tower_tarana_beta', 'tower_tarana_gamma', 'tower_tarana_delta'];
                    taranaSelectIds.forEach(id => {
                        const sel = document.getElementById(id);
                        if (!sel) return;
                        const prev = sel.value;
                        sel.innerHTML = '';
                        const noneOption = document.createElement('option');
                        if (id === 'tower_tarana_delta') {
                            noneOption.value = '';
                            noneOption.textContent = 'None';
                            sel.appendChild(noneOption);
                        }
                        allPorts.forEach(p => {
                            const opt = document.createElement('option');
                            opt.value = p;
                            opt.textContent = p;
                            sel.appendChild(opt);
                        });
                        if (allPorts.includes(prev)) sel.value = prev;
                    });
                    
                    // Update port configuration template
                    const portTemplateSelect = document.getElementById('port2Name');
                    if (portTemplateSelect) {
                        portTemplateSelect.innerHTML = '';
                        allPorts.forEach(port => {
                            const option = document.createElement('option');
                            option.value = port;
                            option.textContent = port;
                            portTemplateSelect.appendChild(option);
                        });
                    }
                    
                    // Update VLAN parent interface dropdowns
                    const vlanParentSelects = document.querySelectorAll('#vlanInterfaces select[name="vlanParent"]');
                    vlanParentSelects.forEach(select => {
                        const currentValue = select.value;
                        select.innerHTML = '';
                        
                        allPorts.forEach(port => {
                            const option = document.createElement('option');
                            option.value = port;
                            option.textContent = port;
                            select.appendChild(option);
                        });
                        
                        // Restore previous value if it exists in new options
                        if (allPorts.includes(currentValue)) {
                            select.value = currentValue;
                        }
                    });
                    
                    // Update VLAN parent interface template
                    const vlanTemplateSelect = document.getElementById('vlan2Parent');
                    if (vlanTemplateSelect) {
                        vlanTemplateSelect.innerHTML = '';
                        allPorts.forEach(port => {
                            const option = document.createElement('option');
                            option.value = port;
                            option.textContent = port;
                            vlanTemplateSelect.appendChild(option);
                        });
                    }
                    
                    // Update max uplinks
                    const maxUplinks = deviceConfig.maxUplinks;
                    document.getElementById('addUplinkBtn').disabled = uplinkCount >= maxUplinks;
                    
                    // Update port labels
                    updatePortLabels();
                    
                    // Update uplinks description
                    updateUplinksDescription();
                    
                    // Update system identity if site name is already filled
                    const siteName = document.getElementById('siteName')?.value;
                    const systemName = document.getElementById('systemName');
                    if (siteName && systemName) {
                        systemName.value = `RTR-${deviceConfig.name}-1.${siteName}`;
                    }
                }
            }

            // Uplinks dynamic (variable already declared above)
            
            function addUplink() {
                const targetDevice = document.getElementById('targetDevice').value;
                const currentDevice = document.getElementById('currentDevice').value;
                const selectedDevice = targetDevice || currentDevice;
                const maxUplinks = selectedDevice && DEVICE_CONFIGS[selectedDevice] ? DEVICE_CONFIGS[selectedDevice].maxUplinks : 4;
                
                if (uplinkCount < maxUplinks) {
                    const template = document.getElementById('uplinkTemplate').cloneNode(true);
                    template.style.display = 'block';
                    const num = ++uplinkCount;
                    template.id = `uplink${num}`;
                    template.querySelector('select').id = `uplink${num}NewPort`;
                    template.querySelectorAll('input')[0].id = `uplink${num}Ip`;
                    template.querySelectorAll('input')[1].id = `uplink${num}Comment`;
                    template.querySelectorAll('input')[2].id = `uplink${num}Cost`;
                    template.querySelector('button').onclick = () => {
                        template.remove();
                        uplinkCount--;
                        document.getElementById('addUplinkBtn').disabled = uplinkCount >= maxUplinks;
                    };
                    document.getElementById('uplinks').appendChild(template);
                    
                    // Populate port options for the new uplink
                    const newPortSelect = template.querySelector('select[id*="NewPort"]');
                    if (newPortSelect && selectedDevice && DEVICE_CONFIGS[selectedDevice]) {
                        const allPorts = [...DEVICE_CONFIGS[selectedDevice].ports, ...DEVICE_CONFIGS[selectedDevice].sfpPorts];
                        newPortSelect.innerHTML = '';
                        allPorts.forEach(port => {
                            const option = document.createElement('option');
                            option.value = port;
                            option.textContent = port;
                            newPortSelect.appendChild(option);
                        });
                    }
                    
                    if (uplinkCount === maxUplinks) document.getElementById('addUplinkBtn').disabled = true;
                }
            }

            function updateUplinkCount() {
                uplinkCount = document.querySelectorAll('.uplink-item:not(#uplinkTemplate)').length;
                document.getElementById('addUplinkBtn').disabled = uplinkCount >= 4;
            }

            // Initialize all event handlers
            initializeEventHandlers();
            function initializeEventHandlers() {
                // Tab switching logic
                const navTabs = document.querySelectorAll('.nav-tab');
                const contentPanes = document.querySelectorAll('.content-pane');
                
                navTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        // Remove active class from all tabs and panes
                        navTabs.forEach(t => t.classList.remove('active'));
                        contentPanes.forEach(p => p.classList.remove('active'));
                        
                        // Add active class to clicked tab
                        tab.classList.add('active');
                        
                        // Show corresponding content pane
                        const tabId = tab.getAttribute('data-tab');
                        const pane = document.getElementById(tabId + '-pane');
                        if (pane) {
                            pane.classList.add('active');
                        }
                    });
                });
                
                // Event listeners for new tabs
                const generateCCRBtn = document.getElementById('generateCCR');
                const copyCCRBtn = document.getElementById('copyCCR');
                const generateTaranaBtn = document.getElementById('generateTarana');
                const copyTaranaBtn = document.getElementById('copyTarana');
                const generateEntFeedingBtn = document.getElementById('generateEntFeeding');
                const copyEntFeedingBtn = document.getElementById('copyEntFeeding');
                
                if (generateCCRBtn) generateCCRBtn.addEventListener('click', function(){
                    if (typeof generateCCR === 'function') return generateCCR();
                    if (typeof genCCR === 'function') return genCCR();
                    console.warn('generateCCR/genCCR not defined');
                });
                if (copyCCRBtn) copyCCRBtn.addEventListener('click', copyCCR);
                if (generateTaranaBtn) generateTaranaBtn.addEventListener('click', genTarana);
                if (copyTaranaBtn) copyTaranaBtn.addEventListener('click', copyTarana);
                if (generateEntFeedingBtn) generateEntFeedingBtn.addEventListener('click', genEntFeeding);
                if (copyEntFeedingBtn) copyEntFeedingBtn.addEventListener('click', copyEntFeeding);
                
                // Generate and Download buttons
                const generateBtn = document.getElementById('generateBtn');
                const downloadBtn = document.getElementById('downloadBtn');
                const output = document.getElementById('output');
                
                if (generateBtn) {
                    generateBtn.addEventListener('click', generateConfig);
                }
                if (downloadBtn) downloadBtn.addEventListener('click', downloadConfig);
                
                // Configuration Type change handler
                const configTypeSelect = document.getElementById('configType');
                if (configTypeSelect) {
                    const handleConfigTypeChange = () => {
                        const configType = configTypeSelect.value;
                        const isSimpleMode = configType === 'legacy-simple';
                        
                        // Show/hide sections based on configuration type
                        const mplsSection = document.querySelector('.mpls-section');
                        const vplsSection = document.querySelector('.vpls-section');
                        const bgpSection = document.getElementById('bgpPeers');
                        const ospfSection = document.getElementById('ospfArea');
                        
                        if (mplsSection) mplsSection.style.display = isSimpleMode ? 'none' : 'block';
                        if (vplsSection) vplsSection.style.display = isSimpleMode ? 'none' : 'block';
                        const bgpGroup = bgpSection ? bgpSection.closest('.form-group') : null;
                        const ospfGroup = ospfSection ? ospfSection.closest('.form-group') : null;
                        if (bgpGroup) bgpGroup.style.display = isSimpleMode ? 'none' : 'block';
                        if (ospfGroup) ospfGroup.style.display = isSimpleMode ? 'none' : 'block';
                        
                        // Update compliance status
                        if (typeof updateComplianceStatus === 'function') updateComplianceStatus();
                    };
                    
                    configTypeSelect.addEventListener('change', handleConfigTypeChange);
                    // Apply initial state
                    handleConfigTypeChange();
                }
                
                // OSPF Area change handler
                const ospfAreaSelect = document.getElementById('ospfArea');
                if (ospfAreaSelect) {
                    ospfAreaSelect.addEventListener('change', function() {
                        const customInput = document.getElementById('ospfAreaCustom');
                        if (customInput) {
                            customInput.style.display = this.value === 'custom' ? 'block' : 'none';
                        }
                        
                        // Hide LAN Bridge and NAT Public IP for MPLS/BNG areas
                        const lanBridgeSection = document.getElementById('lanBridgeSection');
                        const natPublicSection = document.getElementById('natPublicSection');
                        const isMPLSArea = this.value.includes('IL') || this.value.includes('243') || 
                                          this.value.includes('248') || this.value.includes('249') || 
                                          this.value.includes('250') || this.value.includes('42');
                        
                        if (lanBridgeSection) {
                            lanBridgeSection.style.display = isMPLSArea ? 'none' : 'block';
                        }
                        if (natPublicSection) {
                            natPublicSection.style.display = isMPLSArea ? 'none' : 'block';
                        }
                    });
                }
                
                // Feature checkboxes
                const enableTarana = document.getElementById('enableTarana');
                const enableSWT = document.getElementById('enableSWT');
                const enableVPLS = document.getElementById('enableVPLS');
                const enableMPLS = document.getElementById('enableMPLS');
                const enableDHCP = document.getElementById('enableDHCP');
                
                if (enableTarana) enableTarana.addEventListener('change', toggleTaranaSection);
                if (enableSWT) enableSWT.addEventListener('change', toggleSWTSection);
                if (enableVPLS) enableVPLS.addEventListener('change', toggleVPLSSection);
                if (enableMPLS) enableMPLS.addEventListener('change', toggleMPLSSection);
                if (enableDHCP) enableDHCP.addEventListener('change', toggleDHCPSection);
                
                // Tarana sector configuration
                const enableTaranaAlpha = document.getElementById('enableTaranaAlpha');
                const enableTaranaBeta = document.getElementById('enableTaranaBeta');
                const enableTaranaGamma = document.getElementById('enableTaranaGamma');
                const enableTaranaDelta = document.getElementById('enableTaranaDelta');
                const btnAutoConfigTarana = document.getElementById('btnAutoConfigTarana');
                
                if (btnAutoConfigTarana) btnAutoConfigTarana.addEventListener('click', autoConfigureTaranaSectors);
                // Tarana mini-generator preview and copy buttons removed ‚Äî Tarana block is included automatically in the full generated config
                
                // VLAN Profile handler
                const vlanProfile = document.getElementById('vlanProfile');
                if (vlanProfile) {
                    vlanProfile.addEventListener('change', function() {
                        if (this.value) {
                            populateVlanProfile(this.value);
                        }
                    });
                }
                
                // Auto-calculate ranges when LAN Bridge IP changes
                const lanBridgeIP = document.getElementById('lanBridgeIP');
                if (lanBridgeIP) {
                    lanBridgeIP.addEventListener('input', autoCalculateRanges);
                }
                
                // Auto-fill system name when site name changes with auto-capitalization
                const siteName = document.getElementById('siteName');
                const systemName = document.getElementById('systemName');
                if (siteName && systemName) {
                    siteName.addEventListener('input', function() {
                        // Auto-capitalize the site name
                        this.value = this.value.toUpperCase();
                        
                        if (this.value) {
                            // Get the selected target device
                            const targetDevice = document.getElementById('targetDevice')?.value;
                            const deviceConfig = targetDevice && DEVICE_CONFIGS[targetDevice] ? DEVICE_CONFIGS[targetDevice] : DEVICE_CONFIGS.ccr2004;
                            
                            // Auto-fill system identity with proper device name
                            systemName.value = `RTR-${deviceConfig.name}-1.${this.value}`;
                        }
                    });
                }
                
                // Router ID change handler
                const routerId = document.getElementById('routerId');
                if (routerId) {
                    routerId.addEventListener('input', function() {
                        const ldpTransport = document.getElementById('ldpTransport');
                        if (ldpTransport) {
                            ldpTransport.value = this.value;
                        }
                    });
                }

                // MPLS: Enable BGP toggle (hide/show BGP fields)
                const entMplsEnableBGP = document.getElementById('ent_mpls_enableBGP');
                if (entMplsEnableBGP) {
                    entMplsEnableBGP.addEventListener('change', function() {
                        const block = document.getElementById('ent_mpls_bgpBlock');
                        const peers = document.getElementById('ent_mpls_bgpPeersBlock');
                        if (block) block.style.display = this.checked ? 'block' : 'none';
                        if (peers) peers.style.display = this.checked ? 'block' : 'none';
                    });
                }
                
                // DHCP toggle (using existing enableDHCP variable)
                if (enableDHCP) {
                    enableDHCP.addEventListener('change', function() {
                        const dhcpSection = document.getElementById('dhcpSection');
                        if (dhcpSection) {
                            dhcpSection.style.display = this.checked ? 'block' : 'none';
                        }
                    });
                }
                
                // VLAN 4000 subnet change handler
                const vlan4000Subnet = document.getElementById('vlan4000Subnet');
                if (vlan4000Subnet) {
                    vlan4000Subnet.addEventListener('input', autoCalculateRanges);
                }
                // Dark mode toggle
                const darkToggle = document.getElementById('darkToggle');
                if (darkToggle) {
                    darkToggle.addEventListener('click', toggleDarkMode);
                }
                
                // Validation button
                const validateBtn = document.getElementById('validateConfigBtn');
                if (validateBtn) {
                    validateBtn.addEventListener('click', validateConfiguration);
                }
                
                // Auto-check compliance when configuration changes
                const complianceInputs = document.querySelectorAll('#complianceChecklist input[type="checkbox"]');
                complianceInputs.forEach(input => {
                    input.addEventListener('change', updateComplianceStatus);
                });
                // Add port configuration event handlers
                const addPortBtn = document.getElementById('addPortBtn');
                // Auto-populate Tarana button removed from Port Configuration to avoid duplication with Tarana optional feature
                const btnAutoPopulateTarana = null;
                const btnAutoPopulateNetonix = document.getElementById('btnAutoPopulateNetonix');
                
                if (addPortBtn) addPortBtn.addEventListener('click', () => addPort());
                if (btnAutoPopulateNetonix) btnAutoPopulateNetonix.addEventListener('click', autoPopulateNetonixPorts);

                // Static customer management
                const addCustomerBtn = document.getElementById('addCustomerBtn');
                if (addCustomerBtn) addCustomerBtn.addEventListener('click', addCustomer);
                
                // Device selection functionality
                const targetDevice = document.getElementById('targetDevice');
                const currentDevice = document.getElementById('currentDevice');
                if (targetDevice) targetDevice.addEventListener('change', updateDevicePorts);
                if (currentDevice) currentDevice.addEventListener('change', updateDevicePorts);
                
                // Enterprise Feeding device selection functionality
                const entFeedingDevice = document.getElementById('ent_feeding_device');
                const entFeedingRouterOS = document.getElementById('ent_feeding_routeros');
                if (entFeedingDevice) entFeedingDevice.addEventListener('change', handleEnterpriseFeedingDeviceChange);
                if (entFeedingRouterOS) entFeedingRouterOS.addEventListener('change', handleEnterpriseFeedingRouterOSChange);
                
                // Enterprise Config device selection functionality
                const entRouterboardDevice = document.getElementById('ent_routerboard_device');
                const entRouterOSVersion = document.getElementById('ent_routeros_version');
                if (entRouterboardDevice) entRouterboardDevice.addEventListener('change', handleEnterpriseDeviceChange);
                if (entRouterOSVersion) entRouterOSVersion.addEventListener('change', handleEnterpriseRouterOSChange);
                
                // MPLS Enterprise Config device selection functionality
                const entMplsRouterboardDevice = document.getElementById('ent_mpls_routerboard_device');
                const entMplsRouterOSVersion = document.getElementById('ent_mpls_routeros_version');
                if (entMplsRouterboardDevice) entMplsRouterboardDevice.addEventListener('change', handleMplsEnterpriseDeviceChange);
                if (entMplsRouterOSVersion) entMplsRouterOSVersion.addEventListener('change', handleMplsEnterpriseRouterOSChange);
                
                // CCR2004 VLAN Config device selection functionality
                const ccrRouterboardDevice = document.getElementById('ccr_routerboard_device');
                const ccrRouterOSVersion = document.getElementById('ccr_routeros_version');
                if (ccrRouterboardDevice) ccrRouterboardDevice.addEventListener('change', handleCCRDeviceChange);
                if (ccrRouterOSVersion) ccrRouterOSVersion.addEventListener('change', handleCCRRouterOSChange);
                
                // Tarana Sectors device selection functionality
                const taranaRouterboardDevice = document.getElementById('tarana_routerboard_device');
                const taranaRouterOSVersion = document.getElementById('tarana_routeros_version');
                if (taranaRouterboardDevice) taranaRouterboardDevice.addEventListener('change', handleTaranaDeviceChange);
                if (taranaRouterOSVersion) taranaRouterOSVersion.addEventListener('change', handleTaranaRouterOSChange);
                // Initialize Tarana selects so ports populate immediately
                if (taranaRouterboardDevice) {
                    handleTaranaDeviceChange();
                }
                if (taranaRouterOSVersion) {
                    handleTaranaRouterOSChange();
                }
                
                // Uplinks dynamic
                const addUplinkBtn = document.getElementById('addUplinkBtn');
                if (addUplinkBtn) addUplinkBtn.addEventListener('click', addUplink);
                
                // Initialize uplink template
                const uplink1NewPort = document.getElementById('uplink1NewPort');
                const uplinkTemplate = document.getElementById('uplinkTemplate');
                if (uplink1NewPort && uplinkTemplate) {
                    const uplinkPortOptions = uplink1NewPort.innerHTML;
                    uplinkTemplate.querySelector('select').innerHTML = uplinkPortOptions;
                }
                
                // VLAN interface management
                const addVlanBtn = document.getElementById('addVlanBtn');
                if (addVlanBtn) addVlanBtn.addEventListener('click', () => addVlan());
                
                // VPLS management
                const addVplsBtn = document.getElementById('addVplsBtn');
                if (addVplsBtn) addVplsBtn.addEventListener('click', addVpls);
                
                // VLAN profile populate button
                const btnPopulateVlans = document.getElementById('btnPopulateVlans');
                if (btnPopulateVlans) {
                    btnPopulateVlans.addEventListener('click', () => {
                        const profile = document.getElementById('vlanProfile').value;
                        if (profile) populateVlanProfile(profile);
                    });
                }
                
                // Initialize port dropdowns based on default device selection
                updateDevicePorts();
                
                // Add port change listeners to update labels dynamically
                const uplink1NewPortElement = document.getElementById('uplink1NewPort');
                if (uplink1NewPortElement) {
                    uplink1NewPortElement.addEventListener('change', updatePortLabels);
                }
                
                // NOC Workflow Tools
                const btnPresetBackbone = document.getElementById('btnPresetBackbone');
                const btnPresetMPLS = document.getElementById('btnPresetMPLS');
                const btnPresetTarana = document.getElementById('btnPresetTarana');
                const btnValidateConfig = document.getElementById('btnValidateConfig');
                const btnCheckCompliance = document.getElementById('btnCheckCompliance');
                const btnExportTroubleshooting = document.getElementById('btnExportTroubleshooting');
                
                if (btnPresetBackbone) btnPresetBackbone.addEventListener('click', applyBackbonePreset);
                if (btnPresetMPLS) btnPresetMPLS.addEventListener('click', applyMPLSPreset);
                if (btnPresetTarana) btnPresetTarana.addEventListener('click', applyTaranaPreset);
                if (btnValidateConfig) btnValidateConfig.addEventListener('click', validateConfiguration);
                if (btnCheckCompliance) btnCheckCompliance.addEventListener('click', checkRFCCompliance);
                
            }
            
            // NOC Workflow Functions
            function applyBackbonePreset() {
                document.getElementById('ospfArea').value = 'backbone-v2';
                document.getElementById('enableDHCP').checked = true;
                document.getElementById('enableMPLS').checked = false;
                document.getElementById('enableVPLS').checked = false;
                document.getElementById('enableTarana').checked = false;
                document.getElementById('enableSWT').checked = false;
                
                // Trigger area change to update UI
                document.getElementById('ospfArea').dispatchEvent(new Event('change'));
                
                alert('Backbone-v2 preset applied! BGP/OSPF configuration with DHCP enabled.');
            }
            
            function applyMPLSPreset() {
                document.getElementById('ospfArea').value = 'backbone-v2-IL';
                document.getElementById('enableDHCP').checked = false;
                document.getElementById('enableMPLS').checked = true;
                document.getElementById('enableVPLS').checked = true;
                document.getElementById('enableTarana').checked = false;
                document.getElementById('enableSWT').checked = false;
                
                // Trigger area change to update UI
                document.getElementById('ospfArea').dispatchEvent(new Event('change'));
                
                alert('MPLS/VPLS preset applied! MPLS/LDP and VPLS tunnels enabled.');
            }
            
            function applyTaranaPreset() {
                document.getElementById('ospfArea').value = 'backbone-v2';
                document.getElementById('enableDHCP').checked = true;
                document.getElementById('enableMPLS').checked = false;
                document.getElementById('enableVPLS').checked = false;
                document.getElementById('enableTarana').checked = true;
                document.getElementById('enableSWT').checked = false;
                
                // Enable common Tarana sectors by default
                document.getElementById('enableTaranaAlpha').checked = true;
                document.getElementById('enableTaranaBeta').checked = true;
                document.getElementById('enableTaranaGamma').checked = true;
                document.getElementById('enableTaranaDelta').checked = false; // DELTA is rare
                
                // Trigger area change to update UI
                document.getElementById('ospfArea').dispatchEvent(new Event('change'));
                
                alert('Tarana preset applied! ALPHA, BETA, and GAMMA sectors enabled. Use "Auto-Configure Selected Sectors" to set up VLANs.');
            }
            
            function autoConfigureTaranaSectors() {
                const targetDevice = document.getElementById('targetDevice').value;
                const deviceConfig = DEVICE_CONFIGS[targetDevice];
                
                if (!deviceConfig) {
                    alert('Please select a target device first.');
                    return;
                }
                
                // Get selected sectors
                const alphaSelected = document.getElementById('enableTaranaAlpha').checked;
                const betaSelected = document.getElementById('enableTaranaBeta').checked;
                const gammaSelected = document.getElementById('enableTaranaGamma').checked;
                const deltaSelected = document.getElementById('enableTaranaDelta').checked;
                
                if (!alphaSelected && !betaSelected && !gammaSelected && !deltaSelected) {
                    alert('Please select at least one Tarana sector to configure.');
                    return;
                }
                
                // Define sector port mappings based on device
                let sectorPorts = {};
                if (deviceConfig.name === 'CCR2004' || deviceConfig.name === 'CCR2216') {
                    // RouterOS v7 devices use sfp-sfpplus naming
                    sectorPorts = {
                        alpha: 'sfp-sfpplus8',
                        beta: 'sfp-sfpplus9', 
                        gamma: 'sfp-sfpplus10',
                        delta: 'sfp-sfpplus11'
                    };
                } else if (deviceConfig.name === 'CCR1036') {
                    // CCR1036 uses sfp naming
                    sectorPorts = {
                        alpha: 'sfp1',
                        beta: 'sfp2',
                        gamma: 'sfp3', 
                        delta: 'sfp4'
                    };
                } else {
                    // Default to sfp-sfpplus for other devices
                    sectorPorts = {
                        alpha: 'sfp-sfpplus8',
                        beta: 'sfp-sfpplus9',
                        gamma: 'sfp-sfpplus10', 
                        delta: 'sfp-sfpplus11'
                    };
                }
                
                // Configure selected sectors
                const configuredSectors = [];
                
                if (alphaSelected) {
                    addTaranaVLANs('ALPHA', sectorPorts.alpha);
                    configuredSectors.push('ALPHA');
                }
                if (betaSelected) {
                    addTaranaVLANs('BETA', sectorPorts.beta);
                    configuredSectors.push('BETA');
                }
                if (gammaSelected) {
                    addTaranaVLANs('GAMMA', sectorPorts.gamma);
                    configuredSectors.push('GAMMA');
                }
                if (deltaSelected) {
                    addTaranaVLANs('DELTA', sectorPorts.delta);
                    configuredSectors.push('DELTA');
                }
                
                alert(`Tarana sectors configured successfully!\n\nConfigured sectors: ${configuredSectors.join(', ')}\n\nEach sector includes:\n- VLAN 1000 ‚Üí lan-bridge\n- VLAN 2000 ‚Üí bridge2000\n- VLAN 3000 ‚Üí bridge3000`);
            }
            
            function addTaranaVLANs(sectorName, portName) {
                // Add VLAN 1000
                addVlan({
                    parent: portName,
                    vid: 1000,
                    comment: `Tarana ${sectorName} - VLAN 1000`,
                    bridge: 'lan-bridge'
                });
                
                // Add VLAN 2000
                addVlan({
                    parent: portName,
                    vid: 2000,
                    comment: `Tarana ${sectorName} - VLAN 2000`,
                    bridge: 'bridge2000'
                });
                
                // Add VLAN 3000
                addVlan({
                    parent: portName,
                    vid: 3000,
                    comment: `Tarana ${sectorName} - VLAN 3000`,
                    bridge: 'bridge3000'
                });
            }
            
            function validateConfiguration() {
                const siteName = document.getElementById('siteName').value;
                const routerId = document.getElementById('routerId').value;
                const targetDevice = document.getElementById('targetDevice').value;
                
                let issues = [];
                
                if (!siteName) issues.push('Site Name is required');
                if (!routerId) issues.push('Router ID is required');
                if (!targetDevice) issues.push('Target Device must be selected');
                
                // Comprehensive IP validation
                const ipErrors = validateAllIPs();
                issues.push(...ipErrors);
                
                if (issues.length === 0) {
                    alert('‚úì Configuration validation passed! All required fields are filled and IP addresses are valid.');
                } else {
                    alert('‚ö† Configuration Issues Found:\n\n' + issues.join('\n'));
                }
            }
            function checkRFCCompliance() {
                const complianceItems = document.querySelectorAll('#complianceChecklist input[type="checkbox"]');
                let checkedCount = 0;
                let totalCount = complianceItems.length;
                
                complianceItems.forEach(item => {
                    if (item.checked) checkedCount++;
                });
                
                const percentage = Math.round((checkedCount / totalCount) * 100);
                alert(`RFC Compliance Status: ${checkedCount}/${totalCount} items (${percentage}%)\n\nAll baseline RFC configurations are automatically applied to every generated config.`);
            }
            

            function toggleTaranaSection() {
                const taranaSection = document.getElementById('taranaSection');
                const vlanSection = document.getElementById('vlanSection');
                if (taranaSection) taranaSection.style.display = this.checked ? 'block' : 'none';
                if (vlanSection) vlanSection.style.display = (this.checked || document.getElementById('enableSWT').checked) ? 'grid' : 'none';
                // When enabling Tarana, apply defaults
                if (this.checked) applyTaranaDefaults();
            }

            // Apply Tarana defaults based on selected device
            function applyTaranaDefaults() {
                const target = document.getElementById('targetDevice')?.value || 'ccr2004';
                const cfg = DEVICE_CONFIGS[target] || DEVICE_CONFIGS.ccr2004;

                // Default mappings (per model family)
                const defaults = {
                    CCR2004: { alpha: 'sfp-sfpplus8', beta: 'sfp-sfpplus9', gamma: 'sfp-sfpplus10', delta: 'sfp-sfpplus11', speed: '10G-baseCR', mtu: 1500 },
                    CCR2216: { alpha: 'sfp28-1', beta: 'sfp28-2', gamma: 'sfp28-3', delta: 'sfp28-4', speed: '10G-baseCR', mtu: 1500 },
                    CCR1036: { alpha: 'sfp1', beta: 'sfp2', gamma: 'sfp3', delta: 'sfp4', speed: '1G-baseT-full', mtu: 1500 },
                    RB5009: { alpha: 'sfp-sfpplus6', beta: 'sfp-sfpplus7', gamma: 'sfp-sfpplus8', delta: '', speed: '10G-baseCR', mtu: 1500 },
                    RB1009: { alpha: 'sfp1', beta: 'sfp2', gamma: 'sfp3', delta: '', speed: '1G-baseT-full', mtu: 1500 }
                };

                let modelKey = 'CCR2004';
                if (cfg && cfg.name) {
                    if (cfg.name.includes('CCR2216')) modelKey = 'CCR2216';
                    else if (cfg.name.includes('CCR2004')) modelKey = 'CCR2004';
                    else if (cfg.name.includes('CCR1036')) modelKey = 'CCR1036';
                    else if (cfg.name.includes('RB5009')) modelKey = 'RB5009';
                    else if (cfg.name.includes('RB1009')) modelKey = 'RB1009';
                }

                const d = defaults[modelKey];
                if (d) {
                    // set port selects
                    const setIf = (id, val) => { const el = document.getElementById(id); if (el && val !== undefined) el.value = val; };
                    setIf('tower_tarana_alpha', d.alpha);
                    setIf('tower_tarana_beta', d.beta);
                    setIf('tower_tarana_gamma', d.gamma);
                    setIf('tower_tarana_delta', d.delta || '');

                    // set speed and mtu
                    setIf('tower_tarana_alpha_speed', d.speed);
                    setIf('tower_tarana_beta_speed', d.speed);
                    setIf('tower_tarana_gamma_speed', d.speed);
                    setIf('tower_tarana_delta_speed', d.speed);
                    setIf('tower_tarana_alpha_mtu', d.mtu);
                    setIf('tower_tarana_beta_mtu', d.mtu);
                    setIf('tower_tarana_gamma_mtu', d.mtu);
                    setIf('tower_tarana_delta_mtu', d.mtu);
                }
            }
            
            function toggleSWTSection() {
                const vlanSection = document.getElementById('vlanSection');
                if (vlanSection) vlanSection.style.display = (this.checked || document.getElementById('enableTarana').checked) ? 'grid' : 'none';
            }
            function toggleVPLSSection() {
                const vplsSection = document.querySelector('.vpls-section');
                if (vplsSection) vplsSection.style.display = this.checked ? 'block' : 'none';
                if (this.checked) {
                    document.getElementById('vlanProfile').value = 'vpls';
                    populateVlanProfile('vpls');
                }
            }
            function toggleMPLSSection() {
                const mplsSection = document.querySelector('.mpls-section');
                if (mplsSection) mplsSection.style.display = this.checked ? 'block' : 'none';
            }
            
            function toggleDHCPSection() {
                const dhcpSection = document.getElementById('dhcpSection');
                if (dhcpSection) dhcpSection.style.display = this.checked ? 'block' : 'none';
            }
            
            function autoCalculateRanges() {
                const lanBridgeIP = document.getElementById('lanBridgeIP').value;
                if (lanBridgeIP && lanBridgeIP.includes('/')) {
                    const [ip, cidr] = lanBridgeIP.split('/');
                    const octets = ip.split('.').map(Number);
                    
                    // Calculate CPE range (same as LAN bridge)
                    const cpeRange = document.getElementById('cpeRange');
                    if (cpeRange) cpeRange.value = lanBridgeIP;
                    
                    // Calculate unauth range (increment second octet by 100)
                    const unauthOctets = [...octets];
                    unauthOctets[1] += 100;
                    const unauthRange = document.getElementById('unauthRange');
                    if (unauthRange) unauthRange.value = `${unauthOctets.join('.')}/${cidr}`;
                }
            }
            
            function toggleDarkMode() {
                const html = document.documentElement;
                const currentTheme = html.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                html.setAttribute('data-theme', newTheme);
                const darkToggle = document.getElementById('darkToggle');
                if (darkToggle) {
                    darkToggle.textContent = newTheme === 'dark' ? 'Toggle Light Mode' : 'Toggle Dark Mode';
                }
            }

            // === AI Chat Wiring ===
            (function initChat(){
                const log = document.getElementById('chatLog');
                const input = document.getElementById('chatInput');
                const send = document.getElementById('chatSendBtn');
                if (!log || !input || !send) return;
                function append(role, text){
                    const tag = role === 'user' ? 'üßë' : 'ü§ñ';
                    const div = document.createElement('div');
                    div.textContent = `${tag} ${text}`;
                    log.appendChild(div);
                    log.scrollTop = log.scrollHeight;
                }
                async function doSend(){
                    const q = input.value.trim();
                    if (!q) return;
                    append('user', q);
                    input.value = '';
                    try{
                        const r = await fetch(`${AI_API_BASE}/chat`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({message:q})});
                        const j = await r.json();
                        if (!j.success) throw new Error(j.error||'Chat failed');
                        append('assistant', j.reply);
                    }catch(e){ append('assistant', 'Error: '+e.message); }
                }
                send.addEventListener('click', doSend);
                input.addEventListener('keydown', function(ev){ if (ev.key==='Enter') doSend(); });
            })();
            
            // Copy upgrade output to clipboard
            function copyUpgradeOutput() {
                const ta = document.getElementById('upgradeOutput');
                if (!ta) return;
                const config = ta.value || '';
                if (!config) { alert('No translated configuration available!'); return; }
                try {
                    if (navigator.clipboard && window.isSecureContext) {
                        navigator.clipboard.writeText(config).then(() => alert('Translated configuration copied to clipboard!')).catch(() => {
                            ta.select(); document.execCommand('copy'); alert('Copied to clipboard.');
                        });
                    } else {
                        ta.select(); document.execCommand('copy'); alert('Copied to clipboard.');
                    }
                } catch (e) { console.error(e); alert('Copy failed'); }
            }
            
            // Download upgrade output as .rsc file
            function downloadUpgradeOutput() {
                const ta = document.getElementById('upgradeOutput');
                if (!ta) return;
                const config = ta.value || '';
                if (!config) { alert('No translated configuration available!'); return; }
                const targetDevice = (document.getElementById('upgradeTargetDevice')||{}).value || 'device';
                const targetVersion = (document.getElementById('upgradeTargetVersion')||{}).value || '7.x';
                const ts = new Date().toISOString().split('T')[0];
                const blob = new Blob([config.replace(/\r?\n/g, '\n')], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `upgraded-${targetDevice}-v${targetVersion}-${ts}.rsc`;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 0);
            }
            
            function downloadConfig() {
                const config = document.getElementById('output').value;
                if (!config) {
                    alert('Please generate a configuration first!');
                    return;
                }
                
                const siteName = document.getElementById('siteName').value || 'mikrotik';
                const targetDevice = document.getElementById('targetDevice').value || 'ccr2004';
                const timestamp = new Date().toISOString().split('T')[0];
                
                const blob = new Blob([config], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${siteName}-${targetDevice}-${timestamp}.rsc`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            function normalizeConfigOrder(config) {
            // Define the correct RouterOS configuration order based on the production config
            const sectionOrder = [
                '/interface bridge',
                '/interface ethernet', 
                '/interface vlan',
                '/interface vpls',
                '/interface lte apn',
                '/interface wireless security-profiles',
                '/ip dhcp-server option',
                '/ip dhcp-server option sets',
                '/ip pool',
                '/ip dhcp-server',
                '/port',
                '/queue simple',
                '/queue type',
                '/queue tree',
                '/routing bgp template',
                '/routing ospf instance',
                '/routing ospf area',
                '/snmp community',
                '/system logging action',
                '/user group',
                '/interface bridge port',
                '/ip firewall connection tracking',
                '/ip settings',
                '/ipv6 settings',
                '/interface ovpn-server server',
                '/ip address',
                '/ip dhcp-server lease',
                '/ip dhcp-server network',
                '/ip dns',
                '/ip firewall address-list',
                '/ip firewall filter',
                '/ip firewall mangle',
                '/ip firewall nat',
                '/ip firewall raw',
                '/ip firewall service-port',
                '/ip route',
                '/ip service',
                '/mpls interface',
                '/mpls ldp',
                '/mpls ldp interface',
                '/mpls ldp accept-filter',
                '/mpls ldp advertise-filter',
                '/radius',
                '/routing bfd configuration',
                '/routing bgp connection',
                '/routing filter rule',
                '/routing ospf interface-template',
                '/snmp',
                '/system clock',
                '/system identity',
                '/system logging',
                '/system note',
                '/system ntp client',
                '/system ntp client servers',
                '/system resource irq rps',
                '/system routerboard settings',
                '/system scheduler',
                '/system script',
                '/system watchdog',
                '/user aaa'
            ];

            // Split config into sections
            const sections = {};
            const lines = config.split('\n');
            let currentSection = null;
            let currentContent = [];

            lines.forEach(line => {
                if (line.startsWith('/')) {
                    // Save previous section
                    if (currentSection && currentContent.length > 0) {
                        sections[currentSection] = currentContent.join('\n');
                    }
                    // Start new section
                    currentSection = line.trim();
                    currentContent = [line];
                } else if (currentSection) {
                    currentContent.push(line);
                } else {
                    // Header comments before first section
                    if (!sections['_header']) sections['_header'] = [];
                    sections['_header'].push(line);
                }
            });

            // Save last section
            if (currentSection && currentContent.length > 0) {
                sections[currentSection] = currentContent.join('\n');
            }

            // Rebuild config in correct order
            let orderedConfig = '';
            
            // Add header first
            if (sections['_header']) {
                orderedConfig += sections['_header'].join('\n') + '\n';
            }

            // Add sections in RouterOS order
            sectionOrder.forEach(section => {
                if (sections[section]) {
                    orderedConfig += sections[section] + '\n';
                }
            });

            // Add any remaining sections not in the standard order
            Object.keys(sections).forEach(section => {
                if (section !== '_header' && !sectionOrder.includes(section)) {
                    orderedConfig += sections[section] + '\n';
                }
            });

            return orderedConfig.trim();
        }
        
        function validateConfiguration() {
            const results = [];
            const validationList = document.getElementById('validationList');
            const validationResults = document.getElementById('validationResults');
            
            // Clear previous results
            if (validationList) validationList.innerHTML = '';
            
            // Validate required fields
            const siteName = document.getElementById('siteName').value.trim();
            const routerId = document.getElementById('routerId').value.trim();
            const targetDevice = document.getElementById('targetDevice').value;
            
            if (!siteName) {
                results.push({ type: 'error', message: 'Site Name is required' });
            }
            
            if (!routerId) {
                results.push({ type: 'error', message: 'Router ID is required' });
            } else if (!isValidIP(routerId)) {
                results.push({ type: 'error', message: 'Router ID must be a valid IP address' });
            }
            
            if (!targetDevice) {
                results.push({ type: 'warning', message: 'Target device selection recommended' });
            }
            
            // Validate IP addresses
            const lanBridgeIP = document.getElementById('lanBridgeIP').value.trim();
            if (lanBridgeIP && !isValidIPWithCIDR(lanBridgeIP)) {
                results.push({ type: 'error', message: 'LAN Bridge IP must be in CIDR format (e.g., 10.1.1.1/24)' });
            }
            
            const natPublicIP = document.getElementById('natPublicIP').value.trim();
            if (natPublicIP && !isValidIP(natPublicIP)) {
                results.push({ type: 'error', message: 'NAT Public IP must be a valid IP address' });
            }
            
            // Validate Site Coordinates
            const siteLatitude = document.getElementById('siteLatitude').value.trim();
            const siteLongitude = document.getElementById('siteLongitude').value.trim();
            if (siteLatitude && !isValidCoordinate(siteLatitude, 'latitude')) {
                results.push({ type: 'error', message: 'Site Latitude must be a valid coordinate (-90 to 90)' });
            }
            if (siteLongitude && !isValidCoordinate(siteLongitude, 'longitude')) {
                results.push({ type: 'error', message: 'Site Longitude must be a valid coordinate (-180 to 180)' });
            }
            
            // Validate uplinks
            const uplinkElements = document.querySelectorAll('#uplinks .uplink-item:not(#uplinkTemplate)');
            uplinkElements.forEach((element, index) => {
                const ip = element.querySelector('input[id*="Ip"]')?.value;
                const port = element.querySelector('select[id*="NewPort"]')?.value;
                
                if (ip && !isValidIPWithCIDR(ip)) {
                    results.push({ type: 'error', message: `Uplink ${index + 1} IP must be in CIDR format` });
                }
                
                if (ip && !port) {
                    results.push({ type: 'error', message: `Uplink ${index + 1} port selection required` });
                }
            });
            
            // Validate keys and settings
            const sharedKey = document.getElementById('sharedKey').value.trim();
            const snmpCommunity = document.getElementById('snmpCommunity').value.trim();
            const dhcpSecret = document.getElementById('dhcpSecret').value.trim();
            
            if (!sharedKey) {
                results.push({ type: 'error', message: 'Shared Key is required for OSPF/BGP' });
            }
            
            if (!snmpCommunity) {
                results.push({ type: 'warning', message: 'SNMP Community recommended for monitoring' });
            }
            
            if (document.getElementById('enableDHCP').checked && !dhcpSecret) {
                results.push({ type: 'error', message: 'DHCP Secret required when DHCP is enabled' });
            }
            
            // Display results
            results.forEach(result => {
                const li = document.createElement('li');
                li.style.color = result.type === 'error' ? '#f44336' : '#ff9800';
                li.textContent = `${result.type.toUpperCase()}: ${result.message}`;
                if (validationList) validationList.appendChild(li);
            });
            
            if (results.length === 0) {
                const li = document.createElement('li');
                li.style.color = '#4caf50';
                li.textContent = 'SUCCESS: Configuration validation passed';
                if (validationList) validationList.appendChild(li);
            }
            
            if (validationResults) {
                validationResults.style.display = 'block';
            }
            
            // Auto-update compliance checklist
            updateComplianceStatus();
        }
        function updateComplianceStatus() {
            // Auto-check RFC compliance items based on configuration
            const complianceSecurity = document.getElementById('complianceSecurity');
            const complianceRouting = document.getElementById('complianceRouting');
            const complianceNAT = document.getElementById('complianceNAT');
            const complianceDHCP = document.getElementById('complianceDHCP');
            const complianceSNMP = document.getElementById('complianceSNMP');
            const complianceLogging = document.getElementById('complianceLogging');
            const complianceNTP = document.getElementById('complianceNTP');
            
            // RFC Security: Always true - RFC baseline firewall rules are always applied
            if (complianceSecurity) {
                complianceSecurity.checked = true;
            }
            
            // RFC Routing: Check if OSPF/BGP is configured
            if (complianceRouting) {
                const routerId = document.getElementById('routerId').value.trim();
                const ospfArea = document.getElementById('ospfArea').value;
                complianceRouting.checked = routerId && ospfArea;
            }
            
            // RFC NAT: Check if NAT rules will be generated
            if (complianceNAT) {
                const natPublicIP = document.getElementById('natPublicIP').value.trim();
                const lanBridgeIP = document.getElementById('lanBridgeIP').value.trim();
                complianceNAT.checked = natPublicIP && lanBridgeIP;
            }
            
            // RFC DHCP: Check if DHCP is enabled and configured
            if (complianceDHCP) {
                const enableDHCP = document.getElementById('enableDHCP').checked;
                const dhcpSecret = document.getElementById('dhcpSecret').value.trim();
                complianceDHCP.checked = enableDHCP && dhcpSecret;
            }
            
            // RFC SNMP: Check if SNMP community is set
            if (complianceSNMP) {
                const snmpCommunity = document.getElementById('snmpCommunity').value.trim();
                complianceSNMP.checked = !!snmpCommunity;
            }
            
            // RFC Logging: Always true - RFC baseline logging is always applied
            if (complianceLogging) {
                complianceLogging.checked = true;
            }
            
            // RFC NTP: Always true - RFC baseline NTP is always applied
            if (complianceNTP) {
                complianceNTP.checked = true;
            }
        }
        
        function isValidIP(ip) {
            const ipRegex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
            return ipRegex.test(ip);
        }
        
        function isValidIPWithCIDR(ip) {
            const parts = ip.split('/');
            if (parts.length !== 2) return false;
            
            const ipPart = parts[0];
            const cidrPart = parseInt(parts[1]);
            
            return isValidIP(ipPart) && cidrPart >= 0 && cidrPart <= 32;
        }
        
        function isNetworkOrBroadcastAddress(ipCidr) {
            if (!isValidIPWithCIDR(ipCidr)) return false;
            
            const [ip, cidr] = ipCidr.split('/');
            const cidrNum = parseInt(cidr);
            const ipParts = ip.split('.').map(Number);
            
            // Convert IP to 32-bit integer
            const ipInt = (ipParts[0] << 24) + (ipParts[1] << 16) + (ipParts[2] << 8) + ipParts[3];
            
            // Calculate network mask
            const mask = (0xFFFFFFFF << (32 - cidrNum)) >>> 0;
            
            // Calculate network address
            const networkAddress = (ipInt & mask) >>> 0;
            
            // Calculate broadcast address
            const broadcastAddress = (networkAddress | (~mask)) >>> 0;
            
            // Check if the IP is network or broadcast address
            return ipInt === networkAddress || ipInt === broadcastAddress;
        }

        function isValidCoordinate(coord, type) {
            const num = parseFloat(coord);
            if (isNaN(num)) return false;
            
            if (type === 'latitude') {
                return num >= -90 && num <= 90;
            } else if (type === 'longitude') {
                return num >= -180 && num <= 180;
            }
            return false;
        }
        function validateAllIPs() {
            const errors = [];
            
            // Validate Router ID
            const routerId = document.getElementById('routerId').value.trim();
            if (routerId && !isValidIP(routerId)) {
                errors.push('Router ID: Invalid IP address format');
            }
            
            // Validate LAN Bridge IP
            const lanBridgeIP = document.getElementById('lanBridgeIP').value.trim();
            if (lanBridgeIP && !isValidIPWithCIDR(lanBridgeIP)) {
                errors.push('LAN Bridge IP: Invalid IP/CIDR format');
            } else if (lanBridgeIP && isNetworkOrBroadcastAddress(lanBridgeIP)) {
                errors.push('LAN Bridge IP: Cannot use network or broadcast address');
            }
            
            // Validate NAT Public IP
            const natPublicIP = document.getElementById('natPublicIP').value.trim();
            if (natPublicIP && !isValidIP(natPublicIP)) {
                errors.push('NAT Public IP: Invalid IP address format');
            }
            
            // Validate LDP Transport
            const ldpTransport = document.getElementById('ldpTransport').value.trim();
            if (ldpTransport && !isValidIP(ldpTransport)) {
                errors.push('LDP Transport: Invalid IP address format');
            }
            
            // Validate Site Coordinates
            const siteLatitude = document.getElementById('siteLatitude').value.trim();
            const siteLongitude = document.getElementById('siteLongitude').value.trim();
            if (siteLatitude && !isValidCoordinate(siteLatitude, 'latitude')) {
                errors.push('Site Latitude: Invalid coordinate (-90 to 90)');
            }
            if (siteLongitude && !isValidCoordinate(siteLongitude, 'longitude')) {
                errors.push('Site Longitude: Invalid coordinate (-180 to 180)');
            }
            
            // Validate Uplink IPs
            const uplinkIPs = document.querySelectorAll('#uplinks input[id*="Ip"]');
            uplinkIPs.forEach((input, index) => {
                const ip = input.value.trim();
                if (ip && !isValidIPWithCIDR(ip)) {
                    errors.push(`Uplink ${index + 1}: Invalid IP/CIDR format`);
                } else if (ip && isNetworkOrBroadcastAddress(ip)) {
                    errors.push(`Uplink ${index + 1}: Cannot use network or broadcast address`);
                }
            });
            
            // Validate Static Customer IPs
            const customerRanges = document.querySelectorAll('#staticCustomers input[name="customerRange"]');
            customerRanges.forEach((input, index) => {
                const range = input.value.trim();
                if (range && !isValidIPWithCIDR(range)) {
                    errors.push(`Static Customer ${index + 1}: Invalid IP/CIDR format`);
                } else if (range && isNetworkOrBroadcastAddress(range)) {
                    errors.push(`Static Customer ${index + 1}: Cannot use network or broadcast address`);
                }
            });
            
            // Validate VLAN Subnets
            const vlan3000Subnet = document.getElementById('vlan3000Subnet').value.trim();
            if (vlan3000Subnet && !isValidIPWithCIDR(vlan3000Subnet)) {
                errors.push('VLAN 3000 Subnet: Invalid IP/CIDR format');
            } else if (vlan3000Subnet && isNetworkOrBroadcastAddress(vlan3000Subnet)) {
                errors.push('VLAN 3000 Subnet: Cannot use network or broadcast address');
            }
            
            const vlan4000Subnet = document.getElementById('vlan4000Subnet').value.trim();
            if (vlan4000Subnet && !isValidIPWithCIDR(vlan4000Subnet)) {
                errors.push('VLAN 4000 Subnet: Invalid IP/CIDR format');
            } else if (vlan4000Subnet && isNetworkOrBroadcastAddress(vlan4000Subnet)) {
                errors.push('VLAN 4000 Subnet: Cannot use network or broadcast address');
            }
            
            return errors;
        }
        
        function generateConfigHeader(siteName, targetDevice, currentDevice, currentRouterOS, targetRouterOS, deviceConfig) {
            const timestamp = new Date().toISOString();
            const date = timestamp.split('T')[0];
            const time = timestamp.split('T')[1].split('.')[0];
            
            let header = `# ========================================\n`;
            header += `# NextLink MikroTik Configuration Generator\n`;
            header += `# ========================================\n`;
            header += `# Site: ${siteName}\n`;
            header += `# Target Device: ${deviceConfig.name}\n`;
            if (currentDevice) {
                header += `# Upgrade From: ${DEVICE_CONFIGS[currentDevice]?.name || currentDevice}\n`;
            }
            if (currentRouterOS && targetRouterOS) {
                header += `# RouterOS Upgrade: ${currentRouterOS} ‚Üí ${targetRouterOS}\n`;
            }
            header += `# Generated: ${date} ${time} UTC\n`;
            header += `# Compliance: NextLink Standards\n`;
            header += `# Features: ${deviceConfig.features.join(', ')}\n`;
            header += `# Max Uplinks: ${deviceConfig.maxUplinks}\n`;
            header += `# Ports: ${deviceConfig.ports.length} ethernet, ${deviceConfig.sfpPorts.length} SFP+\n`;
            header += `# ========================================\n\n`;
            
            // Add RFC compliance checklist results
            header += `# RFC COMPLIANCE CHECKLIST:\n`;
            const complianceItems = [
                '‚úì RFC Baseline: Standard firewall rules applied',
                '‚úì RFC Address Lists: EOIP-ALLOW, managerIP, BGP-ALLOW, SNMP configured',
                '‚úì RFC System Hardening: Services locked down, watchdog enabled',
                '‚úì RFC Logging: Remote syslog to 142.147.116.215 configured',
                '‚úì RFC SNMP: Community strings and access controls set',
                '‚úì RFC NTP: Time synchronization to ntp-pool.nxlink.com',
                '‚úì RFC RADIUS: DHCP authentication servers configured',
                '‚úì RFC User Management: AAA and group policies hardened',
                '‚úì RFC DHCP Options: Vendor-specific options configured',
                '‚úì RFC MPLS: LDP accept/advertise filters (if enabled)',
                '‚úì Dynamic Features: User-selected configurations applied',
                '‚úì Device-Specific: Optimizations for target device applied'
            ];
            
            complianceItems.forEach(item => {
                header += `# ${item}\n`;
            });
            header += `# ========================================\n\n`;
            
            return header;
        }
        
        function generateDeviceSpecificConfig(config, deviceConfig, targetDevice) {
            // Add device-specific optimizations
            if (targetDevice === 'rb1009' || targetDevice === 'rb2011') {
                // Basic devices - simpler configuration
                config += `# Basic device optimization\n`;
                config += `/system resource\nset cpu-frequency=auto\n`;
            } else if (targetDevice === 'ccr1036') {
                // High-performance device
                config += `# CCR1036 optimization\n`;
                config += `/system resource\nset cpu-frequency=auto\nset cpu-count=36\n`;
            } else if (targetDevice === 'rb5009' || targetDevice === 'ccr2004' || targetDevice === 'ccr2116' || targetDevice === 'ccr2216') {
                // ARM-based devices
                config += `# ARM device optimization\n`;
                config += `/system resource\nset cpu-frequency=auto\n`;
            }
            
            return config;
        }
        // RFC Compliance Configuration Templates
        const RFC_COMPLIANCE_CONFIG = {
            // Standard Firewall Address Lists (always required) - /ip firewall address-list
            firewallAddressLists: {
                'WALLED-GARDEN': [
                    '142.147.112.3', '142.147.112.19', '107.178.15.27', '142.147.112.12', '67.219.126.2'
                ],
                'NAT-EXEMPT-DST': [
                    '142.147.112.3', '142.147.112.19', '107.178.15.0/27', '107.178.5.97'
                ],
                'NTP': [
                    '52.128.59.240', '52.128.59.241', '52.128.59.242', '52.128.59.243'
                ],
                'NETFLIX': [
                    '69.53.224.0/19', '108.175.32.0/20', '192.173.64.0/18', '198.38.96.0/19', '198.45.48.0/20',
                    '208.75.76.0/22', '24.220.183.0/24', '216.168.119.0/24', '23.246.0.0/20', '173.246.157.0/24',
                    '37.77.184.0/23', '64.140.112.0/24', '66.97.254.0/24', '185.2.223.0/24'
                ],
                'Voip-Servers': ['107.178.15.4'],
                'EOIP-ALLOW': ['10.0.0.0/8'],
                'managerIP': [
                    '192.168.128.0/21', '107.178.5.97', '198.100.53.0/25', '143.55.62.143',
                    '142.147.127.2', '132.147.132.6', '67.219.122.201', '10.249.1.26', '10.0.0.0/8'
                ],
                'BGP-ALLOW': ['10.0.0.0/8'],
                'SNMP': [
                    '143.55.35.47', '107.178.15.15', '107.178.15.162', '142.147.112.4', '142.147.124.26',
                    '107.178.5.97', '67.219.126.240/28', '198.100.53.120', '143.55.62.143', '132.147.138.2',
                    '132.147.138.0', '132.147.138.6', '132.147.138.23', '132.147.138.29', '132.147.138.30',
                    '132.147.138.31', '143.55.37.40', '143.55.37.41', '132.147.132.24', '198.100.49.99',
                    '132.147.132.26', '204.11.183.126', '173.215.67.124', '132.147.138.3', '132.147.138.7',
                    '132.147.138.21', '132.147.138.26'
                ],
                'bgp-networks': [
                    // This will be populated dynamically with UNAUTH, CGNAT_PUBLIC, CGNAT_PRIVATE IPs
                ]
            },
            
            // MPLS LDP Filters (standard prefixes)
            mplsLdpFilters: {
                acceptDeny: [
                    '10.2.0.14/32', '10.2.0.21/32', '10.2.0.107/32', '10.2.0.108/32', '10.17.0.10/32',
                    '10.17.0.11/32', '10.30.0.9/32', '10.240.0.3/32', '10.243.0.9/32', '10.248.0.220/32',
                    '10.249.0.220/32', '10.0.0.87/32', '10.9.0.88/32', '10.254.247.9/32'
                ],
                acceptAllow: [
                    '10.2.0.10/32', '10.0.0.0/24', '10.0.1.0/24', '10.1.0.0/24', '10.2.0.0/24', '10.3.0.0/24',
                    '10.4.0.0/24', '10.4.3.0/24', '10.5.0.0/24', '10.6.0.0/24', '10.7.0.0/24', '10.7.250.0/24',
                    '10.7.254.0/24', '10.8.0.0/24', '10.9.0.0/24', '10.9.1.0/24', '10.9.2.0/24', '10.10.0.0/24',
                    '10.11.0.0/24', '10.12.0.0/24', '10.13.0.0/24', '10.14.0.0/24', '10.15.0.0/24', '10.16.0.0/24',
                    '10.17.0.0/24', '10.17.16.0/24', '10.17.18.0/24', '10.17.31.0/24', '10.17.48.0/24',
                    '10.18.0.0/24', '10.18.2.0/24', '10.19.0.0/24', '10.21.0.0/24', '10.22.0.0/24', '10.25.0.0/24',
                    '10.26.0.0/24', '10.27.0.0/24', '10.30.0.0/24', '10.32.0.0/24', '10.33.0.0/24', '10.34.0.0/24',
                    '10.35.0.0/24', '10.36.0.0/24', '10.37.0.0/24', '10.39.0.0/24', '10.45.252.0/24', '10.47.0.0/24',
                    '10.53.252.0/22', '10.254.243.0/24', '10.243.0.0/24', '10.54.0.0/22', '10.250.0.0/24',
                    '10.250.40.0/22', '10.241.0.0/24', '10.241.64.0/22', '10.254.245.0/24',
                    '10.254.249.0/24', '10.249.0.0/24', '10.249.7.0/24', '10.249.180.0/22',
                    '10.254.247.0/24', '10.247.0.0/24', '10.247.13.0/24', '10.247.72.0/24',
                    '10.247.147.0/24', '10.247.187.0/24', '10.247.64.0/22', '10.254.248.0/24',
                    '10.248.0.0/24', '10.248.32.0/24', '10.248.36.0/24', '10.248.86.0/24', '10.248.208.0/22'
                ]
            }
        };
            // RFC Compliance Functions
        function verifyFirewallAddressLists() {
            // Expected address lists from user specification
            const expectedAddressLists = {
                'EOIP-ALLOW': ['10.0.0.0/8'],
                'managerIP': [
                    '192.168.128.0/21', '107.178.5.97', '198.100.53.0/25', '143.55.62.143',
                    '142.147.127.2', '132.147.132.6', '67.219.122.201', '10.249.1.26', '10.0.0.0/8'
                ],
                'BGP-ALLOW': ['10.0.0.0/8'],
                'SNMP': [
                    '143.55.35.47', '107.178.15.15', '107.178.15.162', '142.147.112.4', '142.147.124.26',
                    '107.178.5.97', '67.219.126.240/28', '198.100.53.120', '143.55.62.143', '132.147.138.2',
                    '132.147.138.0', '132.147.138.6', '132.147.138.23', '132.147.138.29', '132.147.138.30',
                    '132.147.138.31', '143.55.37.40', '143.55.37.41', '132.147.132.24', '198.100.49.99',
                    '132.147.132.26', '204.11.183.126', '173.215.67.124', '132.147.138.3', '132.147.138.7',
                    '132.147.138.21', '132.147.138.26'
                ]
            };
            
            // Check if our configuration matches
            const configAddressLists = RFC_COMPLIANCE_CONFIG.firewallAddressLists;
            let allMatch = true;
            let report = 'Address List Verification:\n\n';
            
            Object.entries(expectedAddressLists).forEach(([listName, expectedAddresses]) => {
                if (configAddressLists[listName]) {
                    const configAddresses = configAddressLists[listName];
                    const match = expectedAddresses.every(addr => configAddresses.includes(addr)) && 
                                 expectedAddresses.length === configAddresses.length;
                    
                    report += `${listName}: ${match ? '‚úÖ MATCH' : '‚ùå MISMATCH'}\n`;
                    report += `  Expected: ${expectedAddresses.length} addresses\n`;
                    report += `  Config: ${configAddresses.length} addresses\n`;
                    
                    if (!match) {
                        allMatch = false;
                        report += `  Missing: ${expectedAddresses.filter(addr => !configAddresses.includes(addr)).join(', ')}\n`;
                    }
                } else {
                    report += `${listName}: ‚ùå MISSING\n`;
                    allMatch = false;
                }
                report += '\n';
            });
            
            report += `Overall Status: ${allMatch ? '‚úÖ ALL ADDRESS LISTS CORRECT' : '‚ùå ISSUES FOUND'}`;
            return report;
        }
        
        function verifyFirewallRules() {
            // Expected firewall filter rules from user specification
            const expectedFilterRules = {
                input: [
                    'rem [find chain=input dynamic=no]',
                    'add action=accept chain=input comment="ALLOW EST REL" connection-state=established,related,untracked',
                    'add action=accept chain=input comment="ALLOW MT NEIGHBOR" dst-port=5678 protocol=udp',
                    'add action=accept chain=input comment="ALLOW MAC TELNET" dst-port=20561 protocol=udp',
                    'add action=accept chain=input comment="ALLOW IGMP" protocol=igmp',
                    'add action=accept chain=input comment="ALLOW ICMP" protocol=icmp',
                    'add action=accept chain=input comment="ALLOW DHCPv4" protocol=udp dst-port=67',
                    'add action=accept chain=input comment="ALLOW DHCPv6" protocol=udp dst-port=547',
                    'add action=accept chain=input comment="ALLOW OSPF" protocol=ospf',
                    'add action=accept chain=input comment="ALLOW LDP" dst-port=646 protocol=tcp',
                    'add action=accept chain=input comment="ALLOW LDP" dst-port=646 protocol=udp',
                    'add action=accept chain=input comment="ALLOW MANAGER IP" src-address-list=managerIP',
                    'add action=accept chain=input comment="ALLOW BGP" protocol=tcp dst-port=179 src-address-list=BGP-ALLOW',
                    'add action=accept chain=input comment="ALLOW EOIP" protocol=gre src-address-list=EOIP-ALLOW',
                    'add action=accept chain=input comment="ALLOW SNMP" dst-port=161 protocol=tcp src-address-list=SNMP',
                    'add action=drop chain=input comment="DROP INPUT" log=no'
                ],
                raw: [
                    'rem [find dynamic=no]',
                    'add action=drop chain=prerouting comment="DROP BAD UDP" port=0 protocol=udp'
                ],
                forward: [
                    'rem [find where chain=forward dynamic=no]',
                    'add action=accept chain=forward comment="BGP Accept" dst-address=10.0.0.0/8 dst-port=179 protocol=tcp src-address=10.0.0.0/8',
                    'add action=accept chain=forward comment="GRE Accept" dst-address=10.0.0.0/8 protocol=gre src-address=10.0.0.0/8',
                    'add action=drop chain=forward comment="unauth drop rule" dst-address-list=!WALLED-GARDEN src-address-list=unauth',
                    'add action=fasttrack-connection chain=forward connection-state=established,related,untracked hw-offload=yes',
                    'add action=accept chain=forward connection-state=established,related,untracked'
                ]
            };
            
            const expectedNATRules = [
                'rem [find]',
                'add chain=dstnat protocol=tcp dst-port=5022 action=redirect to-ports=22',
                'add action=dst-nat chain=dstnat comment="unauth proxy rule" dst-address-list=!WALLED-GARDEN dst-port=80 protocol=tcp src-address-list=unauth to-addresses=107.178.15.27 to-ports=3128'
            ];
            
            let report = 'Firewall Rules Verification:\n\n';
            let allMatch = true;
            
            // Test generation
            let testConfig = '';
            testConfig = addRFCComplianceBaseline(testConfig, '10.0.0.1', 'FBZ1yYdphf', 'Nl22021234', false, '10.100.0.0/22', '100.64.0.0/10', '10.200.0.0/22');
            
            // Check Input Chain
            const inputSection = testConfig.split('# FIREWALL INPUT CHAIN')[1];
            if (inputSection) {
                const inputContent = inputSection.split('# FIREWALL RAW CHAIN')[0];
                const inputLines = inputContent.split('\n').filter(line => line.trim() && !line.startsWith('#'));
                
                report += `INPUT CHAIN: ${inputLines.length} rules generated\n`;
                expectedFilterRules.input.forEach((expectedRule, index) => {
                    const found = inputLines.some(line => line.includes(expectedRule.split(' ')[2])); // Check by action
                    report += `  Rule ${index + 1}: ${found ? '‚úÖ' : '‚ùå'} ${expectedRule.split(' ')[2]}\n`;
                    if (!found) allMatch = false;
                });
            } else {
                report += 'INPUT CHAIN: ‚ùå NOT FOUND\n';
                allMatch = false;
            }
            
            // Check Raw Chain
            const rawSection = testConfig.split('# FIREWALL RAW CHAIN')[1];
            if (rawSection) {
                const rawContent = rawSection.split('# FIREWALL FORWARD CHAIN')[0];
                const rawLines = rawContent.split('\n').filter(line => line.trim() && !line.startsWith('#'));
                
                report += `\nRAW CHAIN: ${rawLines.length} rules generated\n`;
                expectedFilterRules.raw.forEach((expectedRule, index) => {
                    const found = rawLines.some(line => line.includes(expectedRule.split(' ')[2])); // Check by action
                    report += `  Rule ${index + 1}: ${found ? '‚úÖ' : '‚ùå'} ${expectedRule.split(' ')[2]}\n`;
                    if (!found) allMatch = false;
                });
            } else {
                report += '\nRAW CHAIN: ‚ùå NOT FOUND\n';
                allMatch = false;
            }
            
            // Check Forward Chain
            const forwardSection = testConfig.split('# FIREWALL FORWARD CHAIN')[1];
            if (forwardSection) {
                const forwardContent = forwardSection.split('# FIREWALL MANGLE')[0];
                const forwardLines = forwardContent.split('\n').filter(line => line.trim() && !line.startsWith('#'));
                
                report += `\nFORWARD CHAIN: ${forwardLines.length} rules generated\n`;
                expectedFilterRules.forward.forEach((expectedRule, index) => {
                    const found = forwardLines.some(line => line.includes(expectedRule.split(' ')[2])); // Check by action
                    report += `  Rule ${index + 1}: ${found ? '‚úÖ' : '‚ùå'} ${expectedRule.split(' ')[2]}\n`;
                    if (!found) allMatch = false;
                });
            } else {
                report += '\nFORWARD CHAIN: ‚ùå NOT FOUND\n';
                allMatch = false;
            }
            
            // Check NAT Rules
            const natSection = testConfig.split('# FIREWALL NAT')[1];
            if (natSection) {
                const natContent = natSection.split('# SYSTEM HARDENING')[0];
                const natLines = natContent.split('\n').filter(line => line.trim() && !line.startsWith('#'));
                
                report += `\nNAT RULES: ${natLines.length} rules generated\n`;
                expectedNATRules.forEach((expectedRule, index) => {
                    const found = natLines.some(line => line.includes(expectedRule.split(' ')[2])); // Check by action
                    report += `  Rule ${index + 1}: ${found ? '‚úÖ' : '‚ùå'} ${expectedRule.split(' ')[2]}\n`;
                    if (!found) allMatch = false;
                });
            } else {
                report += '\nNAT RULES: ‚ùå NOT FOUND\n';
                allMatch = false;
            }
            
            report += `\nOverall Status: ${allMatch ? '‚úÖ ALL FIREWALL RULES CORRECT' : '‚ùå ISSUES FOUND'}`;
            return report;
        }
        function addRFCComplianceBaseline(config, routerId, snmpCommunity, dhcpSecret, enableMPLS, unauthRange, cgnatRange, vlan4000Range) {
            // Variables section
            config += `# RFC COMPLIANCE BASELINE CONFIGURATION\n`;
            config += `# Variables\n`;
            config += `:global LoopIP [/ip address get [find interface=loop0] address]\n`;
            config += `:global curDate [/system clock get date]\n`;
            config += `:global curTime [/system clock get time]\n`;
            config += `:global CurDT ($curDate . " " . $curTime)\n\n`;

            // IP Services Hardening
            config += `# IP SERVICES - RFC Compliance Hardening\n`;
            config += `/ip service\n`;
            config += `set telnet disabled=yes port=5023\n`;
            config += `set ftp disabled=yes port=5021\n`;
            config += `set www disabled=yes port=1234\n`;
            config += `set api disabled=yes\n`;
            config += `set api-ssl disabled=yes\n`;
            config += `set www-ssl disabled=yes port=443\n`;
            config += `set winbox port=8291 address="" disabled=no\n`;
            config += `set ssh port=22 address="" disabled=no\n\n`;

            // DNS Configuration
            config += `# DNS Configuration\n`;
            config += `/ip dns\n`;
            config += `set servers=142.147.112.3,142.147.112.19\n\n`;

            // System Clock and NTP
            config += `# CLOCK AND NTP\n`;
            // (Removed duplicated user account creation block for MPLS output)
            config += `\n`;

            // Firewall Input Chain (RFC Standard)
            config += `# FIREWALL INPUT CHAIN - RFC Standard\n`;
            config += `/ip firewall filter\n`;
            config += `rem [find chain=input dynamic=no]\n`;
            config += `add action=accept chain=input comment="ALLOW EST REL" connection-state=established,related,untracked\n`;
            config += `add action=accept chain=input comment="ALLOW MT NEIGHBOR" dst-port=5678 protocol=udp\n`;
            config += `add action=accept chain=input comment="ALLOW MAC TELNET" dst-port=20561 protocol=udp\n`;
            config += `add action=accept chain=input comment="ALLOW IGMP" protocol=igmp\n`;
            config += `add action=accept chain=input comment="ALLOW ICMP" protocol=icmp\n`;
            config += `add action=accept chain=input comment="ALLOW DHCPv4" protocol=udp dst-port=67\n`;
            config += `add action=accept chain=input comment="ALLOW DHCPv6" protocol=udp dst-port=547\n`;
            config += `add action=accept chain=input comment="ALLOW OSPF" protocol=ospf\n`;
            config += `add action=accept chain=input comment="ALLOW LDP" dst-port=646 protocol=tcp\n`;
            config += `add action=accept chain=input comment="ALLOW LDP" dst-port=646 protocol=udp\n`;
            config += `add action=accept chain=input comment="ALLOW MANAGER IP" src-address-list=managerIP\n`;
            config += `add action=accept chain=input comment="ALLOW BGP" protocol=tcp dst-port=179 src-address-list=BGP-ALLOW\n`;
            config += `add action=accept chain=input comment="ALLOW EOIP" protocol=gre src-address-list=EOIP-ALLOW\n`;
            config += `add action=accept chain=input comment="ALLOW SNMP" dst-port=161 protocol=tcp src-address-list=SNMP\n`;
            config += `add action=drop chain=input comment="DROP INPUT" log=no\n\n`;

            // Firewall Raw Chain
            config += `# FIREWALL RAW CHAIN\n`;
            config += `/ip firewall raw\n`;
            config += `rem [find dynamic=no]\n`;
            config += `add action=drop chain=prerouting comment="DROP BAD UDP" port=0 protocol=udp\n\n`;

            // Firewall Forward Chain
            config += `# FIREWALL FORWARD CHAIN\n`;
            config += `/ip firewall filter\n`;
            config += `rem [find where chain=forward dynamic=no]\n`;
            config += `add action=accept chain=forward comment="BGP Accept" dst-address=10.0.0.0/8 dst-port=179 protocol=tcp src-address=10.0.0.0/8\n`;
            config += `add action=accept chain=forward comment="GRE Accept" dst-address=10.0.0.0/8 protocol=gre src-address=10.0.0.0/8\n`;
            config += `add action=drop chain=forward comment="unauth drop rule" dst-address-list=!WALLED-GARDEN src-address-list=unauth\n`;
            config += `add action=fasttrack-connection chain=forward connection-state=established,related,untracked hw-offload=yes\n`;
            config += `add action=accept chain=forward connection-state=established,related,untracked\n\n`;

            // Firewall Mangle
            config += `# FIREWALL MANGLE\n`;
            config += `/ip firewall mangle\n`;
            config += `rem [find where dynamic=no]\n`;
            config += `add action=mark-packet chain=prerouting comment="Mark SMTP packets" dst-address-list=NAT-EXEMPT-DST dst-port=25 new-packet-mark=SMTP passthrough=no protocol=tcp\n`;
            config += `add action=mark-packet chain=prerouting comment="Mark NTP packets" dst-address-list=NTP dst-port=123 new-packet-mark=NTP passthrough=no protocol=udp\n\n`;

            // Firewall NAT
            config += `# FIREWALL NAT\n`;
            config += `/ip firewall nat\n`;
            config += `rem [find]\n`;
            config += `add action=redirect chain=dstnat dst-address-type=local dst-port=5022 protocol=tcp to-ports=22\n`;
            config += `add action=dst-nat chain=dstnat comment="unauth proxy rule" dst-address-list=!WALLED-GARDEN dst-port=80 protocol=tcp src-address-list=unauth to-addresses=107.178.15.27 to-ports=3128\n`;
            config += `add action=src-nat chain=srcnat packet-mark=SMTP to-addresses=${routerId}\n`;
            config += `add action=src-nat chain=srcnat packet-mark=NTP to-addresses=${routerId}\n\n`;

            // System Hardening
            config += `# SYSTEM HARDENING\n`;
            config += `/system watchdog\n`;
            config += `set watchdog-timer=yes\n`;
            config += `/system routerboard settings\n`;
            config += `set auto-upgrade=yes\n`;
            config += `/ip firewall connection tracking\n`;
            config += `set udp-timeout=30s\n`;
            config += `/ip proxy\n`;
            config += `set enabled=no\n`;
            config += `/ip firewall service-port\n`;
            config += `set sip disabled=yes\n\n`;

            // SNMP Configuration
            config += `# SNMP CONFIGURATION\n`;
            config += `/snmp\n`;
            config += `set enabled=yes src-address=${routerId} trap-community=${snmpCommunity}\n`;
            config += `/snmp community\n`;
            config += `set [find default=yes] read-access=no\n`;
            config += `rem [find default=no]\n`;
            config += `add name=${snmpCommunity} addresses=::/0\n\n`;

            // Logging Configuration
            config += `# LOGGING CONFIGURATION\n`;
            config += `/system logging action\n`;
            config += `rem [find default=no]\n`;
            config += `set [find name="memory"] memory-lines=1000\n`;
            config += `set [find name="disk"] disk-lines-per-file=10000 disk-file-count=3\n`;
            config += `add name=syslog remote=142.147.116.215 src-address=$LoopIP target=remote\n`;
            config += `/system logging\n`;
            config += `rem [find default=no]\n`;
            config += `add action=syslog topics=critical\n`;
            config += `add action=syslog topics=error\n`;
            config += `add action=syslog topics=warning\n`;
            config += `add action=disk topics=critical\n`;
            config += `add action=disk topics=error\n`;
            config += `add action=disk topics=warning\n`;
            config += `add action=memory topics=critical\n`;
            config += `add action=memory topics=error\n`;
            config += `add action=memory topics=warning\n`;
            config += `set 0 action=echo\n\n`;

            // User Management
            config += `# USER MANAGEMENT\n`;
            config += `/user aaa\n`;
            config += `set use-radius=no\n`;
            config += `/user group\n`;
            config += `rem [find where name!="full" and name!="read" and name!="write"]\n`;
            config += `set read policy="local,telnet,read,test,winbox,sniff,ssh,!ftp,!reboot,!write,!policy,!password,!web,!sensitive,!api,!romon,!rest-api"\n\n`;

            // DHCP Options
            config += `# DHCP OPTIONS\n`;
            config += `/ip dhcp-server option\n`;
            config += `rem [find]\n`;
            config += `add code=43 name=opt43 value=0x011768747470733a2f2f7573732e6e786c696e6b2e636f6d2f\n`;
            config += `/ip dhcp-server option sets\n`;
            config += `rem [find]\n`;
            config += `add name=optset options=opt43\n`;
            config += `/ip dhcp-server network\n`;
            config += `set [find where address !~ "^10\\\\."] dhcp-option-set=optset\n\n`;

            // RADIUS Configuration
            config += `# RADIUS CONFIGURATION\n`;
            config += `/radius\n`;
            config += `rem [find]\n`;
            config += `add address=142.147.112.2 secret=${dhcpSecret} service=dhcp src-address=$LoopIP timeout=5s\n`;
            config += `add address=142.147.112.18 secret=${dhcpSecret} service=dhcp src-address=$LoopIP timeout=5s\n\n`;

            // MPLS LDP Filters (if MPLS enabled)
            if (enableMPLS) {
                config += `# MPLS LDP FILTERS\n`;
                config += `/mpls ldp accept-filter\n`;
                config += `rem [find]\n`;
                RFC_COMPLIANCE_CONFIG.mplsLdpFilters.acceptDeny.forEach(prefix => {
                    config += `add accept=no disabled=no prefix=${prefix}\n`;
                });
                RFC_COMPLIANCE_CONFIG.mplsLdpFilters.acceptAllow.forEach(prefix => {
                    config += `add accept=yes disabled=no prefix=${prefix}\n`;
                });
                config += `add accept=no disabled=no prefix=0.0.0.0/0\n\n`;
                
                config += `/mpls ldp advertise-filter\n`;
                config += `rem [find]\n`;
                RFC_COMPLIANCE_CONFIG.mplsLdpFilters.acceptDeny.forEach(prefix => {
                    config += `add advertise=no disabled=no prefix=${prefix}\n`;
                });
                RFC_COMPLIANCE_CONFIG.mplsLdpFilters.acceptAllow.forEach(prefix => {
                    config += `add advertise=yes disabled=no prefix=${prefix}\n`;
                });
                config += `add advertise=no disabled=no prefix=0.0.0.0/0\n\n`;
            }
            // BGP Template Configuration
            config += `# BGP TEMPLATE CONFIGURATION\n`;
            config += `/routing bgp template\n`;
            config += `set default as=26077 disabled=no multihop=yes output.network=bgp-networks router-id=${routerId} routing-table=main\n\n`;
            // OSPF Instance and Area Configuration
            config += `# OSPF INSTANCE AND AREA CONFIGURATION\n`;
            config += `/routing ospf instance\n`;
            config += `add disabled=no name=default-v2 router-id=${routerId}\n`;
            config += `/routing ospf area\n`;
            config += `add disabled=no instance=default-v2 name=backbone-v2\n\n`;

            // SNMP Configuration
            config += `# SNMP CONFIGURATION\n`;
            config += `/snmp\n`;
            const siteLatitude = document.getElementById('siteLatitude').value.trim();
            const siteLongitude = document.getElementById('siteLongitude').value.trim();
            const location = siteLatitude && siteLongitude ? `"${siteLatitude}, ${siteLongitude}"` : '"Unknown Location"';
            config += `set enabled=yes location=${location} src-address=${routerId} trap-community=${snmpCommunity}\n\n`;

            // System Note
            config += `# SYSTEM NOTE\n`;
            config += `/system note\n`;
            config += `set note="RFC COMPLIANCE SCRIPT APPLIED ON $CurDT"\n\n`;

            return config;
        }
        function addOutOfStateConfiguration(config, routerId, snmpCommunity, lanBridgeIP, natPublicIP, siteLatitude, siteLongitude) {
            // Out-of-state configuration - simple bridge/DHCP setup
            config += `# OUT-OF-STATE CONFIGURATION\n`;
            config += `# Simple bridge and DHCP setup for out-of-state deployments\n\n`;
            
            // Basic bridges
            config += `/interface bridge\n`;
            config += `add name=public-bridge priority=0x1\n`;
            config += `add name=nat-bridge priority=0x1\n`;
            config += `add name=loop0\n\n`;
            
            // Basic IP addresses
            config += `/ip address\n`;
            config += `add address=${routerId}/32 interface=loop0 comment=loop0\n`;
            if (natPublicIP) {
                config += `add address=${natPublicIP} interface=public-bridge comment="PUBLIC(S)"\n`;
            }
            if (lanBridgeIP) {
                const lanIP = lanBridgeIP.includes('/') ? lanBridgeIP.split('/')[0] : lanBridgeIP;
                config += `add address=${lanIP}/24 interface=nat-bridge comment="PRIVATES"\n`;
            }
            config += `\n`;
            
            // Basic DNS
            config += `/ip dns\n`;
            config += `set max-udp-packet-size=512 servers=142.147.112.3,142.147.112.19\n\n`;
            
            // Basic DHCP pools
            config += `/ip pool\n`;
            if (natPublicIP) {
                const publicIP = natPublicIP.includes('/') ? natPublicIP.split('/')[0] : natPublicIP;
                const publicRange = publicIP.replace(/\.\d+$/, '.226') + '-' + publicIP.replace(/\.\d+$/, '.230');
                config += `add name=public ranges="${publicRange}"\n`;
            }
            if (lanBridgeIP) {
                const lanIP = lanBridgeIP.includes('/') ? lanBridgeIP.split('/')[0] : lanBridgeIP;
                const privateRange = lanIP.replace(/\.\d+$/, '.10') + '-' + lanIP.replace(/\.\d+$/, '.254');
                config += `add name=private ranges="${privateRange}"\n`;
            }
            config += `\n`;
            
            // Basic DHCP servers
            config += `/ip dhcp-server\n`;
            if (natPublicIP) {
                config += `add address-pool=public disabled=no interface=public-bridge lease-time=1h name=public-server use-radius=no authoritative=yes\n`;
            }
            if (lanBridgeIP) {
                config += `add address-pool=private disabled=no interface=nat-bridge lease-time=1h name=nat-server use-radius=no authoritative=yes\n`;
            }
            config += `\n`;
            
            // Basic DHCP networks
            config += `/ip dhcp-server network\n`;
            if (natPublicIP) {
                const publicIP = natPublicIP.includes('/') ? natPublicIP.split('/')[0] : natPublicIP;
                const publicNetwork = publicIP.replace(/\.\d+$/, '.224/29');
                config += `add address=${publicNetwork} dns-server=142.147.112.3,142.147.112.19 comment="PUBLIC(S)" gateway=${publicIP} netmask=29\n`;
            }
            if (lanBridgeIP) {
                const lanIP = lanBridgeIP.includes('/') ? lanBridgeIP.split('/')[0] : lanBridgeIP;
                config += `add address=${lanIP}/24 dns-server=142.147.112.3,142.147.112.19 comment=PRIVATES gateway=${lanIP} netmask=24\n`;
            }
            config += `\n`;
            
            // Basic SNMP
            config += `/snmp community\n`;
            config += `set [ find default=yes ] read-access=no\n`;
            config += `add name=${snmpCommunity} addresses=::/0\n`;
            config += `/snmp\n`;
            const location = siteLatitude && siteLongitude ? `"${siteLatitude}, ${siteLongitude}"` : '"Unknown Location"';
            config += `set enabled=yes location=${location} trap-community=${snmpCommunity} src-address=${routerId}\n\n`;
            
            // Basic NAT
            config += `/ip firewall nat\n`;
            if (natPublicIP && lanBridgeIP) {
                const publicIP = natPublicIP.includes('/') ? natPublicIP.split('/')[0] : natPublicIP;
                const lanIP = lanBridgeIP.includes('/') ? lanBridgeIP.split('/')[0] : lanBridgeIP;
                config += `add action=src-nat chain=srcnat src-address=${lanIP}/24 to-addresses=${publicIP}\n`;
            }
            config += `\n`;
            
            // Basic address lists
            config += `/ip firewall address-list\n`;
            config += `add address=67.219.119.0/24 list=ACS\n`;
            config += `add address=142.147.121.0/24 list=ACS\n\n`;
            
            // Basic filter rules
            config += `/ip firewall filter\n`;
            config += `add action=accept chain=input comment="ACS RULE" src-address-list=ACS\n\n`;
            
            // Basic logging
            config += `/system logging action\n`;
            config += `set 0 memory-lines=100\n`;
            config += `set 1 disk-lines-per-file=10000\n`;
            config += `add name=syslog remote=142.147.116.215 src-address=${routerId} target=remote\n`;
            config += `/system logging\n`;
            config += `add action=syslog topics=critical\n`;
            config += `add action=syslog topics=error\n`;
            config += `add action=syslog topics=info\n`;
            config += `add action=syslog topics=warning\n`;
            config += `add disabled=yes topics=debug\n\n`;
            
            return config;
        }

        // Dynamic Configuration Functions
        function addDynamicConfigurations(config, enableTarana, enableSWT, enableVPLS, enableMPLS, enableDHCP, lanBridgeIP, cgnatRange, unauthRange, vlan4000Range, routerId, sharedKey) {
            // Add dynamic address lists for user-configured features (append to existing RFC lists)
            config += `# DYNAMIC ADDRESS LISTS (Additional to RFC Baseline)\n`;
            
            // Add static customers to address lists
            const staticCustomers = Array.from(document.querySelectorAll('#staticCustomers .customer-item:not(#customerTemplate)'))
                .map(item => ({
                    name: item.querySelector('input[name="customerName"]')?.value,
                    range: item.querySelector('input[name="customerRange"]')?.value,
                    comment: item.querySelector('input[name="customerComment"]')?.value
                }))
                .filter(customer => customer.name && customer.range);
            
            if (staticCustomers.length > 0) {
                config += `/ip firewall address-list\n`;
                config += `rem [find list=static-customers]\n`;
                staticCustomers.forEach(customer => {
                    config += `add address=${customer.range} comment="${customer.comment || customer.name}" list=static-customers\n`;
                });
            }
            
            // Add DHCP-related address lists (these are now handled in RFC baseline bgp-networks)
            // Note: UNAUTH, CGNAT_PUBLIC, CGNAT_PRIVATE are now added to bgp-networks in RFC baseline
            if (enableDHCP) {
                if (cgnatRange) {
                    config += `/ip firewall address-list\n`;
                    config += `rem [find list=cgnat-customers]\n`;
                    config += `add address=${cgnatRange} comment="CGNAT customers" list=cgnat-customers\n`;
                }
                if (vlan4000Range) {
                    config += `/ip firewall address-list\n`;
                    config += `rem [find list=vlan4000-customers]\n`;
                    config += `add address=${vlan4000Range} comment="VLAN 4000 customers" list=vlan4000-customers\n`;
                }
            }
            config += `\n`;

            // Add dynamic firewall rules for user features (append to existing RFC rules)
            config += `# DYNAMIC FIREWALL RULES (Additional to RFC Baseline)\n`;
            
            // Allow static customers full access
            if (staticCustomers.length > 0) {
                config += `/ip firewall filter\n`;
                config += `add action=accept chain=forward comment="Allow static customers" src-address-list=static-customers\n`;
            }
            
            // Tarana-specific rules
            if (enableTarana) {
                config += `/ip firewall filter\n`;
                config += `add action=accept chain=forward comment="Allow Tarana traffic" src-address=10.25.0.0/16\n`;
                config += `add action=accept chain=forward comment="Allow Tarana management" src-address=10.25.34.0/28\n`;
            }
            
            // SWT-specific rules
            if (enableSWT) {
                config += `/ip firewall filter\n`;
                config += `add action=accept chain=forward comment="Allow SWT traffic" src-address=10.10.0.0/16\n`;
                config += `add action=accept chain=forward comment="Allow SWT management" src-address=10.10.9.0/22\n`;
            }
            
            // VPLS-specific rules
            if (enableVPLS) {
                config += `/ip firewall filter\n`;
                config += `add action=accept chain=forward comment="Allow VPLS traffic" protocol=gre\n`;
                config += `add action=accept chain=forward comment="Allow VPLS control" dst-port=4789 protocol=udp\n`;
            }
            config += `\n`;

            // Add dynamic NAT rules
            config += `# DYNAMIC NAT RULES\n`;
            config += `/ip firewall nat\n`;
            
            const natPublicIP = document.getElementById('natPublicIP').value.trim();
            if (natPublicIP && lanBridgeIP) {
                const natIP = natPublicIP.includes('/') ? natPublicIP.split('/')[0] : natPublicIP;
                const lanNetwork = calculateNetwork(lanBridgeIP);
                const lanCidr = lanBridgeIP.split('/')[1];
                
                // Source NAT for LAN traffic
                config += `add action=src-nat chain=srcnat comment="LAN to Internet NAT" out-interface=all src-address=${lanNetwork}/${lanCidr} to-addresses=${natIP}\n`;
            }
            
            if (enableDHCP) {
                if (cgnatRange && natPublicIP) {
                    const natIP = natPublicIP.includes('/') ? natPublicIP.split('/')[0] : natPublicIP;
                    config += `add action=dst-nat chain=dstnat comment="CGNAT to Public" dst-address=${cgnatRange} to-addresses=${natIP}\n`;
                }
                
                if (unauthRange && natPublicIP) {
                    const natIP = natPublicIP.includes('/') ? natPublicIP.split('/')[0] : natPublicIP;
                    config += `add action=dst-nat chain=dstnat comment="Unauth to Public" dst-address=${unauthRange} to-addresses=${natIP}\n`;
                }
            }
            config += `\n`;

            // Add OSPF Interface Templates
            config += `# OSPF INTERFACE TEMPLATES\n`;
            config += `/routing ospf interface-template\n`;
            
            // Loopback interface template
            config += `add area=backbone-v2 cost=10 disabled=no interfaces=loop0 networks=${routerId}/32 passive priority=1\n`;
            
            // LAN bridge interface template
            if (lanBridgeIP) {
                const lanNetwork = calculateNetwork(lanBridgeIP);
                const lanCidr = lanBridgeIP.split('/')[1];
                config += `add area=backbone-v2 cost=10 disabled=no interfaces=lan-bridge networks=${lanNetwork}/${lanCidr} priority=1\n`;
            }
            
            // Add uplink interface templates
            const uplinkElements = document.querySelectorAll('#uplinks .uplink-item:not(#uplinkTemplate)');
            uplinkElements.forEach((element, index) => {
                const port = element.querySelector('select[name="port"]')?.value;
                const ip = element.querySelector('input[name="ip"]')?.value;
                const comment = element.querySelector('input[name="comment"]')?.value || `Uplink-${index + 1}`;
                
                if (port && ip) {
                    const network = calculateNetwork(ip);
                    const cidr = ip.split('/')[1];
                    config += `add area=backbone-v2 auth=md5 auth-id=1 auth-key=${sharedKey} comment="${comment}" cost=10 disabled=no interfaces=${port} networks=${network}/${cidr} priority=1 type=ptp\n`;
                }
            });
            config += `\n`;

            // Add BGP Connections (if MPLS enabled)
            if (enableMPLS) {
                config += `# BGP CONNECTIONS\n`;
                config += `/routing bgp connection\n`;
                
                // Add BGP connections for core routers
                const bgpConnections = [
                    { name: 'CR7', remote: '10.2.0.107' },
                    { name: 'CR8', remote: '10.2.0.108' }
                ];
                
                bgpConnections.forEach(conn => {
                    config += `add cisco-vpls-nlri-len-fmt=auto-bits connect=yes listen=yes local.address=${routerId} .role=ibgp multihop=yes name=${conn.name} remote.address=${conn.remote} .as=26077 .port=179 tcp-md5-key=${sharedKey} templates=default\n`;
                });
                config += `\n`;

                // Add BGP Routing Filter Rules
                config += `# BGP ROUTING FILTER RULES\n`;
                config += `/routing filter rule\n`;
                config += `add chain=bgr-a-bgp-in-filter disabled=no rule="if (dst in 0.0.0.0/0 && dst-len == 32 && protocol bgp && bgp-communities includes 26077:86) { set blackhole yes; accept; }"\n`;
                config += `add chain=bgr-a-bgp-in-filter disabled=no rule="if (dst in 0.0.0.0/0 && dst-len == 0 && protocol bgp) { set bgp-local-pref 500; accept; }"\n`;
                config += `add chain=bgr-a-bgp-in-filter disabled=no rule="if (dst in 0.0.0.0/0 && dst-len >= 0 && protocol bgp) { accept; }"\n`;
                config += `add chain=bgr-b-bgp-in-filter disabled=no rule="if (dst in 0.0.0.0/0 && dst-len == 32 && protocol bgp && bgp-communities includes 26077:86) { set blackhole yes; accept; }"\n`;
                config += `add chain=bgr-b-bgp-in-filter disabled=no rule="if (dst in 0.0.0.0/0 && dst-len == 0 && protocol bgp) { set bgp-local-pref 500; accept; }"\n`;
                config += `add chain=bgr-b-bgp-in-filter disabled=no rule="if (dst in 0.0.0.0/0 && dst-len >= 0 && protocol bgp) { accept; }"\n\n`;
            }

            return config;
        }
        function generateConfig() {
                try {
                    const siteName = document.getElementById('siteName').value.trim();
                const routerId = document.getElementById('routerId').value.trim();
                const targetDevice = document.getElementById('targetDevice').value || 'ccr2004';
                const currentDevice = document.getElementById('currentDevice').value;
                const currentRouterOS = document.getElementById('currentRouterOS').value;
                const targetRouterOS = document.getElementById('targetRouterOS').value;
                
                // Get device configuration
                const deviceConfig = DEVICE_CONFIGS[targetDevice] || DEVICE_CONFIGS.ccr2004;
                const systemName = document.getElementById('systemName').value.trim() || `RTR-${deviceConfig.name}-1.${siteName}`;
                const lanBridgeIP = document.getElementById('lanBridgeIP').value.trim();
                const ospfArea = document.getElementById('ospfArea').value === 'custom' 
                    ? document.getElementById('ospfAreaCustom').value.trim() 
                    : document.getElementById('ospfArea').value;
                const ospfAreaId = document.getElementById('ospfAreaId').value.trim();
                const bgpPeersJson = document.getElementById('bgpPeers').value.trim();
                const bgpAS = document.getElementById('bgpAS').value.trim();
                const configType = document.getElementById('configType').value;
                const isSimpleMode = configType === 'legacy-simple';
                const enableVPLS = document.getElementById('enableVPLS').checked;
                const enableMPLS = document.getElementById('enableMPLS').checked;
                const enableDHCP = document.getElementById('enableDHCP').checked;
                const enableTarana = document.getElementById('enableTarana').checked;
                const enableSWT = document.getElementById('enableSWT').checked;
                const sharedKey = document.getElementById('sharedKey').value.trim();
                const dnsServers = document.getElementById('dnsServers').value.trim();
                const dhcpSecret = document.getElementById('dhcpSecret').value.trim();
                const snmpCommunity = document.getElementById('snmpCommunity').value.trim();
                const natPublicIPRaw = document.getElementById('natPublicIP').value.trim();
                const siteLatitude = document.getElementById('siteLatitude').value.trim();
                const siteLongitude = document.getElementById('siteLongitude').value.trim();
                
                // Get IP range variables (needed early for RFC compliance)
                const cgnatRange = document.getElementById('cgnatRange').value.trim();
                const unauthRange = document.getElementById('unauthRange').value.trim();
                const vlan4000Range = document.getElementById('vlan4000Range').value.trim();

                if (!siteName || !routerId) {
                    alert('Please fill in Site Name and Router ID!');
                    return;
                }

                // Get VLAN data once for reuse
                const vlanRows = Array.from(document.querySelectorAll('#vlanInterfaces .vlan-item:not(#vlanTemplate)'))
                    .map(item => ({
                        parent: item.querySelector('select[name="vlanParent"]')?.value,
                        vid: item.querySelector('input[name="vlanId"]')?.value,
                        comment: item.querySelector('input[name="vlanComment"]')?.value,
                        bridge: item.querySelector('input[name="vlanBridge"]')?.value || 'lan-bridge'
                    }))
                    .filter(v => v.parent && v.vid);

                // Deduplicate VLANs with same parent and VID
                const seen = new Set();
                const uniqueVlans = vlanRows.filter(v => {
                    const key = `${v.parent}|${v.vid}`;
                    if (seen.has(key)) return false;
                    seen.add(key);
                    return true;
                });
                // Collect direct port‚Üíbridge assignments early so we only create needed bridges
                const portBridgeAssignmentsEarly = Array.from(
                  document.querySelectorAll('#portConfigs .uplink-item:not(#portTemplate)')
                ).map(item => {
                  const port   = item.querySelector('select[name="portName"]')?.value?.trim();
                  const bridge = item.querySelector('select[name="portBridge"]')?.value?.trim();
              return { port, bridge };
                }).filter(x => x.port && x.bridge);

                // Work out which bridges we actually need
                const bridgesNeeded = new Set(
                  uniqueVlans.map(v => v.bridge).filter(Boolean)
                );
                portBridgeAssignmentsEarly.forEach(({ bridge }) => bridgesNeeded.add(bridge));

                // Only add lan-bridge if the LAN Bridge IP is set
                if (lanBridgeIP) bridgesNeeded.add('lan-bridge');
                // Only add nat-public-bridge if the NAT Public IP is set
                if (natPublicIPRaw) bridgesNeeded.add('nat-public-bridge');
                
                // Add Tarana bridges if Tarana is enabled
                if (enableTarana) {
                    bridgesNeeded.add('bridge1000');
                    bridgesNeeded.add('bridge2000');
                    bridgesNeeded.add('bridge3000');
                }

                // Always keep loopback pseudo-bridge (loop0) as in current build
                const needsLoop = true;

                // Generate device-specific configuration header
                let config = generateConfigHeader(siteName, targetDevice, currentDevice, currentRouterOS, targetRouterOS, deviceConfig);
                
                // Add configuration based on type
                if (isSimpleMode) {
                    // Out-of-state: Simple bridge/DHCP configuration
                    config = addOutOfStateConfiguration(config, routerId, snmpCommunity, lanBridgeIP, natPublicIPRaw, siteLatitude, siteLongitude);
                } else {
                    // In-state: Full RFC compliance baseline
                    config = addRFCComplianceBaseline(config, routerId, snmpCommunity, dhcpSecret, enableMPLS, unauthRange, cgnatRange, vlan4000Range);
                }

                // 1. Interface Bridge (only create bridges actually referenced/needed)
                if (!isSimpleMode) {
                    config += `/interface bridge\n`;
                    if (needsLoop) {
                      config += `add fast-forward=no name=loop0\n`;
                    }
                if (bridgesNeeded.has('lan-bridge')) {
                  config += `add fast-forward=no name=lan-bridge priority=0x1\n`;
                }
                if (bridgesNeeded.has('nat-public-bridge')) {
                  config += `add fast-forward=no name=nat-public-bridge\n`;
                }
                // Create only VLAN bridges that are referenced anywhere
                ['bridge1000','bridge2000','bridge3000','bridge4000','bridge999249'].forEach(b => {
                  if (bridgesNeeded.has(b)) {
                    if (b === 'bridge999249') {
                      config += `add comment=m-VPLS name=bridge999249 port-cost-mode=short priority=0x7000 protocol-mode=mstp vlan-filtering=yes\n`;
                    } else {
                      config += `add name=${b}\n`;
                    }
                  }
                });

                // --- Consolidated ethernet emission (ordered & de-duped) ---
                const configuredPorts = new Set();

                // Seed from Uplink inputs - process all uplinks dynamically
                const ethMap = new Map(); // port -> {comment, speed, mtu, l2mtu}
                const allUplinkElementsEth = document.querySelectorAll('#uplinks .uplink-item:not(#uplinkTemplate)');
                allUplinkElementsEth.forEach((element, index) => {
                  const port = element.querySelector('select[id*="NewPort"]')?.value;
                  if (!port) return;
                  const comment = element.querySelector('input[id*="Comment"]')?.value || `Uplink-${index + 1}`;
                  const speed = element.querySelector('select[id*="Speed"]')?.value || '1Gbps';
                  ethMap.set(port, { comment, speed, mtu: '', l2mtu: '' });
                });

                // Merge Port Config rows (override uplink values where provided)
                const portConfigs = Array.from(document.querySelectorAll('#portConfigs .uplink-item:not(#portTemplate)'))
                  .map(item => ({
                port:    item.querySelector('select[name="portName"]')?.value,
                    speed:   item.querySelector('select[name="portSpeed"]')?.value,
                    comment: item.querySelector('input[name="portComment"]')?.value || '',
                    bridge:  item.querySelector('select[name="portBridge"]')?.value,
                    mtu:     item.querySelector('input[name="portMtu"]')?.value,
                    l2mtu:   item.querySelector('input[name="portL2Mtu"]')?.value
                  }))
                  .filter(pc => pc.port);

                portConfigs.forEach(pc => {
                  const prev = ethMap.get(pc.port) || {};
                  ethMap.set(pc.port, {
                    comment: pc.comment || prev.comment || '',
                    speed:   (pc.speed && pc.speed !== '') ? pc.speed : (prev.speed || ''),
                    mtu:     (pc.mtu   != null && pc.mtu   !== '') ? pc.mtu     : (prev.mtu   || ''),
                    l2mtu:   (pc.l2mtu != null && pc.l2mtu !== '') ? pc.l2mtu   : (prev.l2mtu || '')
                  });
                });

                // Ordering: ether1, sfp-sfpplusN, sfp28-N, then the rest alpha
                function portRank(p) {
                  if (p === 'ether1') return [0, 1];
                  let m = /^sfp-sfpplus(\d+)$/.exec(p);
                  if (m) return [1, Number(m[1]) || 0];
                  m = /^sfp28-(\d+)$/.exec(p);
                  if (m) return [2, Number(m[1]) || 0];
                  return [3, p];
                }

                const entries = Array.from(ethMap.entries()).sort((a, b) => {
                  const ra = portRank(a[0]);
                  const rb = portRank(b[0]);
                  if (ra[0] !== rb[0]) return ra[0] - rb[0];
                  if (typeof ra[1] === 'number' && typeof rb[1] === 'number') return ra[1] - rb[1];
                  return String(ra[1]).localeCompare(String(rb[1]));
                });

                // Emit section once, in order
                config += `/interface ethernet\n`;
                // Only configure ether1 if the device has ether1 port
                if (deviceConfig.ports.includes('ether1')) {
                    config += `set [ find default-name=ether1 ] auto-negotiation=yes comment="Management"\n`;
                }

                entries.forEach(([port, pc]) => {
                  const autoNegPart =
                    pc.speed ? (pc.speed === 'auto' ? ' auto-negotiation=yes' : ' auto-negotiation=no') : '';
                  const speedPart   = pc.speed && pc.speed !== 'auto' ? ` speed=${pc.speed}` : '';
                  const mtuPart     = (pc.mtu   != null && pc.mtu   !== '') ? ` mtu=${pc.mtu}`     : '';
                  const l2mtuPart   = (pc.l2mtu != null && pc.l2mtu !== '') ? ` l2mtu=${pc.l2mtu}` : '';
                const commentPart = pc.comment ? ` comment="${pc.comment}"` : '';
                  config += `set [ find default-name=${port} ]${autoNegPart}${commentPart}${speedPart}${mtuPart}${l2mtuPart}\n`;
                  configuredPorts.add(port);
                });

                // Automatically disable unused ports for security and power savings
                // Use device-specific port lists from DEVICE_CONFIGS
                // EXCEPT ether1 which should remain available as management port
                const allDevicePorts = [...deviceConfig.ports, ...deviceConfig.sfpPorts];
                
                allDevicePorts.forEach(port => {
                    if (!configuredPorts.has(port) && port !== 'ether1') {
                        config += `set [ find default-name=${port} ] disabled=yes\n`;
                    }
                });
                }

                // 3. Interface VLAN (in-state only)
                if (!isSimpleMode && uniqueVlans.length) {
                    config += `/interface vlan\n`;
                    uniqueVlans.forEach(v => {
                        const vlanName = `vlan${v.vid}-${v.parent}`;
                        const commentStr = v.comment ? ` comment="${v.comment}"` : '';
                        config += `add interface=${v.parent} name=${vlanName} vlan-id=${v.vid}${commentStr}\n`;
                    });
                }

                // 4. Interface VPLS (in-state only)
                if (!isSimpleMode && enableVPLS) {
                    const vplsRows = Array.from(document.querySelectorAll('#vplsInstances .vpls-item:not(#vplsTemplate)'))
                        .map(item => ({
                            name: item.querySelector('input[name="vplsName"]')?.value,
                            peer: item.querySelector('input[name="vplsPeer"]')?.value,
                            staticId: item.querySelector('input[name="vplsStaticId"]')?.value
                        }))
                        .filter(v => v.name && v.peer && v.staticId);
                        
                    if (vplsRows.length) {
                        config += `/interface vpls\n`;
                        vplsRows.forEach(v => {
                            config += `add arp=enabled cisco-static-id=${v.staticId} disabled=no mtu=1500 name=${v.name} peer=${v.peer} pw-control-word=disabled pw-l2mtu=1580 pw-type=raw-ethernet\n`;
                        });
                    
                        // If Tarana is enabled, reapply defaults for the new device (after tarana selects populated)
                        if (document.getElementById('enableTarana')?.checked) {
                            applyTaranaDefaults();
                        }
                    }
                }

                // 5. DHCP Configuration (consolidated function call)
                config = addDHCPConfiguration(config, enableDHCP, routerId, dnsServers, dhcpSecret);

                // 6. Routing Configuration  
                // Only emit BGP when MPLS is not enabled
                if (!enableMPLS) {
                    if (deviceConfig.bgpSyntax === 'v7') {
                        config += `/routing bgp template\nset default as=${bgpAS} disabled=no output.network=bgp-networks router-id=${routerId} routing-table=main\n`;
                    } else {
                        config += `/routing bgp instance\nset default as=${bgpAS} router-id=${routerId}\n`;
                    }
                }

                if (deviceConfig.ospfSyntax === 'v7') {
                    config += `/routing ospf instance\nadd disabled=no name=default-v2 router-id=${routerId}\n`;
                    config += `/routing ospf area\nadd area-id=${ospfAreaId} disabled=no instance=default-v2 name=${ospfArea}\n`;
                } else {
                    config += `/routing ospf instance\nset [ find default=yes ] router-id=${routerId}\n`;
                }

                // 7. SNMP Community
                config += `/snmp community\nset [ find default=yes ] read-access=no\nadd addresses=::/0 name=${snmpCommunity}\n`;

                // 8. System Logging Action
                config += `/system logging action\nset 0 memory-lines=1000\nset 1 disk-lines-per-file=10000 disk-file-count=3\nadd name=syslog remote=142.147.116.215 src-address=${routerId} target=remote\n`;

                // Collect direct port‚Üíbridge assignments from the Port Configuration section
                const portBridgeAssignments = Array.from(
                  document.querySelectorAll('#portConfigs .uplink-item:not(#portTemplate)')
                ).map(item => {
                  const port   = item.querySelector('select[name="portName"]')?.value?.trim();
                  const bridge = item.querySelector('select[name="portBridge"]')?.value?.trim();
                  return { port, bridge };
                }).filter(x => x.port && x.bridge && x.bridge !== '');

                // 9. Interface Bridge Port
                if (uniqueVlans.length || portBridgeAssignments.length) {
                    config += `/interface bridge port\n`;
                    
                    // Add VLAN interface bridge assignments
                    uniqueVlans.forEach(v => {
                        const vlanName = `vlan${v.vid}-${v.parent}`;
                        config += `add bridge=${v.bridge} interface=${vlanName}\n`;
                    });
                    
                    // Add direct port bridge assignments from port configuration
                    portBridgeAssignments.forEach(({ port, bridge }) => {
                        config += `add bridge=${bridge} interface=${port}\n`;
                    });
                }

                // 10. IP Settings
                config += `/ip firewall connection tracking\nset udp-timeout=30s\n`;
                config += `/ip settings\nset max-neighbor-entries=8192\n`;
                config += `/ipv6 settings\nset disable-ipv6=yes max-neighbor-entries=8192\n`;

                // 11. IP Addresses
                config += `/ip address\n`;
                config += `add address=${routerId} interface=loop0 network=${routerId}\n`;
                // LAN address only if LAN IP provided and lan-bridge exists
                if (lanBridgeIP && bridgesNeeded.has('lan-bridge')) {
                  const _lanNet = calculateNetwork(lanBridgeIP);
                  config += `add address=${lanBridgeIP} interface=lan-bridge network=${_lanNet}\n`;
                }
                // NAT public address only if provided and nat-public-bridge exists
                if (natPublicIPRaw && bridgesNeeded.has('nat-public-bridge')) {
                  const natPublicIP = natPublicIPRaw.includes('/') ? natPublicIPRaw : `${natPublicIPRaw}/32`;
                  const _natNet = calculateNetwork(natPublicIP);
                  config += `add address=${natPublicIP} interface=nat-public-bridge network=${_natNet}\n`;
                }

                // If Tarana optional feature is enabled, append Tarana sector configuration
                if (enableTarana) {
                    try {
                        const tAlpha = document.getElementById('tower_tarana_alpha')?.value;
                        const tBeta = document.getElementById('tower_tarana_beta')?.value;
                        const tGamma = document.getElementById('tower_tarana_gamma')?.value;
                        const tDelta = document.getElementById('tower_tarana_delta')?.value;
                        const unicornSubnet = document.getElementById('tower_unicornmgmt_subnet')?.value.trim();

                        const taranaBlock = generateTowerTaranaBlock({
                            alpha: tAlpha,
                            beta: tBeta,
                            gamma: tGamma,
                            delta: tDelta,
                            unicornSubnet
                        }, deviceConfig);

                        config += `\n################################\n###       TARANA SECTORS     ###\n################################\n\n`;
                        config += taranaBlock;
                    } catch (err) {
                        console.error('Tarana generation error', err);
                    }
                }

                // Uplink addresses - process all uplinks dynamically
                const allUplinkElementsAddr = document.querySelectorAll('#uplinks .uplink-item:not(#uplinkTemplate)');
                allUplinkElementsAddr.forEach((element, index) => {
                    // Try multiple selectors to find the IP input
                    const ip = element.querySelector('input[placeholder*="IP/Net"]')?.value || 
                              element.querySelector('input[id*="Ip"]')?.value ||
                              element.querySelector('input[placeholder*="Backhaul IP"]')?.value;
                    const port = element.querySelector('select[id*="NewPort"]')?.value;
                    const comment = element.querySelector('input[id*="Comment"]')?.value || `Uplink-${index + 1}`;
                    
                    if (ip && port) {
                        const network = calculateNetwork(ip);
                        config += `add address=${ip} comment="${comment}" interface=${port} network=${network}\n`;
                    }
                });

                // Additional IP addresses for DHCP pools
                if (enableDHCP) {
                    const cgnatRange = document.getElementById('cgnatRange').value.trim();
                    const unauthRange = document.getElementById('unauthRange').value.trim();
                    const vlan4000Range = document.getElementById('vlan4000Range').value.trim();
                    
                    if (cgnatRange && cgnatRange.includes('/')) {
                        const [cgnatNet, cgnatCidr] = cgnatRange.split('/');
                        const cgnatGateway = cgnatNet.split('.').map((octet, i) => i === 3 ? '1' : octet).join('.');
                        const cgnatNetwork = calculateNetwork(cgnatRange);
                        config += `add address=${cgnatGateway}/${cgnatCidr} interface=lan-bridge network=${cgnatNetwork}\n`;
                    }
                    if (unauthRange && unauthRange.includes('/')) {
                        const [unauthNet, unauthCidr] = unauthRange.split('/');
                        const unauthGateway = unauthNet.split('.').map((octet, i) => i === 3 ? '1' : octet).join('.');
                        const unauthNetwork = calculateNetwork(unauthRange);
                        config += `add address=${unauthGateway}/${unauthCidr} interface=lan-bridge network=${unauthNetwork}\n`;
                    }
                    if (document.getElementById('enableSWT').checked && vlan4000Range && vlan4000Range.includes('/')) {
                        const [vlan4000Net, vlan4000Cidr] = vlan4000Range.split('/');
                        const vlan4000Gateway = vlan4000Net.split('.').map((octet, i) => i === 3 ? '1' : octet).join('.');
                        const vlan4000Network = calculateNetwork(vlan4000Range);
                        config += `add address=${vlan4000Gateway}/${vlan4000Cidr} interface=bridge4000 network=${vlan4000Network}\n`;
                    }
                }

                // 12. IP DNS
                config += `/ip dns\nset max-udp-packet-size=512 servers=${dnsServers}\n`;

                // 13. Firewall Configuration (consolidated function call)
                config = addFirewallConfiguration(config, enableDHCP, enableMPLS);
                // 14. IP Service
                config += `/ip service\n`;
                config += `set telnet disabled=yes port=5023\n`;
                config += `set ftp disabled=yes port=5021\n`;
                config += `set www disabled=yes port=1234\n`;
                config += `set ssh port=22\n`;
                config += `set api disabled=yes\n`;
                config += `set api-ssl disabled=yes\n`;
                config += `set www-ssl disabled=yes port=443\n`;
                config += `set winbox port=8291 disabled=no\n`;
                // 15. MPLS Configuration (consolidated function call)
                config = addMPLSConfiguration(config, enableMPLS, uplinkCount, deviceConfig);
                // 16. Routing BGP Connection (only when MPLS is OFF)
                if (!enableMPLS) {
                    if (deviceConfig.bgpSyntax === 'v7') {
                        config += `/routing bgp connection\n`;
                        try {
                            const peers = JSON.parse(bgpPeersJson);
                            peers.forEach(peer => {
                                config += `add cisco-vpls-nlri-len-fmt=auto-bits connect=yes disabled=no listen=yes local.address=${routerId} .role=ibgp multihop=yes name=${peer.name} remote.address=${peer.remote} .as=${bgpAS} .port=179 tcp-md5-key=${sharedKey} templates=default\n`;
                            });
                        } catch (e) {
                            config += `# Error parsing BGP peers JSON; add manually\n`;
                        }
                    } else {
                        config += `/routing bgp peer\n`;
                        try {
                            const peers = JSON.parse(bgpPeersJson);
                            peers.forEach(peer => {
                                config += `add in-filter=bgr-a-bgp-in-filter multihop=yes name=${peer.name} remote-address=${peer.remote} remote-as=${bgpAS} tcp-md5-key=${sharedKey} ttl=default update-source=loop0\n`;
                            });
                        } catch (e) {
                            config += `# Error parsing BGP peers JSON; add manually\n`;
                        }
                    }
                } else {
                    config += `# BGP omitted (MPLS selected)\n`;
                }

                // 17. Routing OSPF Interface Configuration
                if (deviceConfig.ospfSyntax === 'v7') {
                    config += `/routing ospf interface-template\n`;
                    config += `add area=${ospfArea} disabled=no interfaces=loop0 networks=${routerId}/32 passive priority=1\n`;
                    
                    // OSPF LAN template only if we actually have a LAN Bridge IP + lan-bridge
                    if (lanBridgeIP && bridgesNeeded.has('lan-bridge')) {
                      const lanNetwork = calculateNetwork(lanBridgeIP);
                      const lanCidr = lanBridgeIP.split('/')[1];
                      config += `add area=${ospfArea} disabled=no interfaces=lan-bridge networks=${lanNetwork}/${lanCidr} priority=1\n`;
                    }
                    
                    // Process all uplinks dynamically (including those added via "Add Uplink" button)
                    const allUplinkElementsOSPF = document.querySelectorAll('#uplinks .uplink-item:not(#uplinkTemplate)');
                    allUplinkElementsOSPF.forEach((element, index) => {
                        const ip = element.querySelector('input[placeholder*="IP/Net"], input[id*="Ip"]')?.value;
                        const port = element.querySelector('select[id*="NewPort"]')?.value;
                        const comment = element.querySelector('input[id*="Comment"]')?.value || `Uplink-${index + 1}`;
                        const cost = element.querySelector('input[id*="Cost"]')?.value || 10;
                        
                        if (ip && port) {
                            const network = calculateNetwork(ip);
                            const cidr = ip.split('/')[1];
                            config += `add area=${ospfArea} auth=md5 auth-id=1 auth-key=${sharedKey} comment="${comment}" cost=${cost} disabled=no interfaces=${port} networks=${network}/${cidr} priority=1 type=ptp\n`;
                        }
                    });
                } else {
                    // RouterOS v6 syntax
                    config += `/routing ospf interface\n`;
                    config += `add authentication=md5 authentication-key=${sharedKey} comment=loop0 interface=loop0 network-type=point-to-point\n`;
                    
                    // Process all uplinks dynamically (including those added via "Add Uplink" button)
                    const allUplinkElementsOSPF = document.querySelectorAll('#uplinks .uplink-item:not(#uplinkTemplate)');
                    allUplinkElementsOSPF.forEach((element, index) => {
                        const ip = element.querySelector('input[placeholder*="IP/Net"], input[id*="Ip"]')?.value;
                        const port = element.querySelector('select[id*="NewPort"]')?.value;
                        const comment = element.querySelector('input[id*="Comment"]')?.value || `Uplink-${index + 1}`;
                        
                        if (ip && port) {
                            config += `add authentication=md5 authentication-key=${sharedKey} comment="${comment}" interface=${port} network-type=point-to-point\n`;
                        }
                    });
                    
                    config += `/routing ospf network\n`;
                    config += `add area=backbone comment=loop0 network=${routerId}/32\n`;
                    
                    // OSPF LAN network only if we actually have a LAN Bridge IP + lan-bridge
                    if (lanBridgeIP && bridgesNeeded.has('lan-bridge')) {
                      const lanNetwork = calculateNetwork(lanBridgeIP);
                      const lanCidr = lanBridgeIP.split('/')[1];
                      config += `add area=backbone comment=LAN network=${lanNetwork}/${lanCidr}\n`;
                    }
                    
                    // Process all uplinks for network configuration
                    allUplinkElementsOSPF.forEach((element, index) => {
                        const ip = element.querySelector('input[placeholder*="IP/Net"], input[id*="Ip"]')?.value;
                        const port = element.querySelector('select[id*="NewPort"]')?.value;
                        const comment = element.querySelector('input[id*="Comment"]')?.value || `Uplink-${index + 1}`;
                        
                        if (ip && port) {
                            const network = calculateNetwork(ip);
                            const cidr = ip.split('/')[1];
                            config += `add area=backbone comment="${comment}" network=${network}/${cidr}\n`;
                        }
                    });
                }

                // 18. SNMP
                config += `/snmp\nset enabled=yes src-address=${routerId} trap-community=${snmpCommunity}\n`;

                // 19. System Configuration
                config += `/system clock\nset time-zone-name=America/Chicago\n`;
                config += `/system identity\nset name=${systemName}\n`;
                // 20. System Logging
                config += `/system logging\n`;
                config += `add action=syslog topics=critical\n`;
                config += `add action=syslog topics=error\n`;
                config += `add action=syslog topics=warning\n`;
                config += `add action=disk topics=critical\n`;
                config += `add action=disk topics=error\n`;
                config += `add action=disk topics=warning\n`;
                config += `add action=memory topics=critical\n`;
                config += `add action=memory topics=error\n`;
                config += `add action=memory topics=warning\n`;
                config += `set 0 action=echo\n`;

                // 21. System NTP Client
                config += `/system ntp client\nset enabled=yes\n`;
                config += `/system ntp client servers\n`;
                config += `add address=52.128.59.240\n`;
                config += `add address=52.128.59.241\n`;
                config += `add address=ntp-pool.nxlink.com\n`;

                // 22. System RouterBoard Settings
                config += `/system routerboard settings\nset auto-upgrade=yes\n`;

                // 23. System Watchdog
                config += `/system watchdog\nset watchdog-timer=yes\n`;

                // 24. User AAA
                config += `/user aaa\nset use-radius=no\n`;

                // Add dynamic configurations for user-selected features (in-state only)
                if (!isSimpleMode) {
                    config = addDynamicConfigurations(config, enableTarana, enableSWT, enableVPLS, enableMPLS, enableDHCP, lanBridgeIP, cgnatRange, unauthRange, vlan4000Range, routerId, sharedKey);
                }
                
                // Add device-specific optimizations
                config = generateDeviceSpecificConfig(config, deviceConfig, targetDevice);
                
                // Add System Scripts (Backup and Monitoring) - in-state only
                if (!isSimpleMode) {
                    config += `# SYSTEM SCRIPTS\n`;
                    config += `/system scheduler\n`;
                    config += `add interval=1d name=nightly on-event="/system script run \\"backup\\"\\r\\n    \\n/system script run \\"dhcp-count\\"\\r\\n    \\n" policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive start-date=2013-06-21 start-time=00:00:00\n\n`;
                
                config += `/system script\n`;
                config += `add dont-require-permissions=no name=backups owner=root policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive source="# automated backup 2 External ftp\\r\\n    \\n\\r\\n    \\n# ftp configuration\\r\\n    \\n:local ftphost \\"backup.nxlink.com\\"\\r\\n    \\n:local ftpuser \\"mtbackups\\"\\r\\n    \\n:local ftppassword \\"Mt55054321\\"\\r\\n    \\n:local ftppath \\"mtbackups\\"\\r\\n    \\n\\r\\n    \\n# months array\\r\\n    \\n:local months (\\"jan\\",\\"feb\\",\\"mar\\",\\"apr\\",\\"may\\",\\"jun\\",\\"jul\\",\\"aug\\",\\"sep\\",\\"oct\\",\\"nov\\",\\"dec\\");\\r\\n    \\n\\r\\n    \\n# get time\\r\\n    \\n:local ts [/system clock get time]\\r\\n    \\n:set ts ([:pick \\$ts 0 2].[:pick \\$ts 3 5].[:pick \\$ts 6 8])\\r\\n    \\n\\r\\n    \\n# get Date\\r\\n    \\n:local ds [/system clock get date]\\r\\n    \\n# convert name of month to number\\r\\n    \\n:local month [ :pick \\$ds 0 3 ];\\r\\n    \\n:local mm ([ :find \\$months \\$month -1 ] + 1);\\r\\n    \\n:if (\\$mm < 10) do={ :set mm (\\"0\\" . \\$mm); }\\r\\n    \\n# set \\$ds to format YYYY-MM-DD\\r\\n    \\n:set ds ([:pick \\$ds 7 11] . \\$mm . [:pick \\$ds 4 6])\\r\\n    \\n\\r\\n    \\n\\r\\n    \\n# file name for system backup - file name will be UMDB-servername-date-time.backup\\r\\n    \\n:local fname1 ([/system identity get name].\\"-\\".\\$ds.\\"-\\".\\$ts.\\".backup\\")\\r\\n    \\n# file name for config export - file name will be UMDB-servername-date-time.rsc\\r\\n    \\n:local fname2 ([/system identity get name].\\"-\\".\\$ds.\\"-\\".\\$ts.\\".rsc\\")\\r\\n    \\n\\r\\n    \\n# backup the data\\r\\n    \\n\\r\\n    \\n/system backup save name=\\$fname1\\r\\n    \\n:log info message=\\"System backup finished (1/2).\\";\\r\\n    \\n/export compact file=\\$fname2\\r\\n    \\n:log info message=\\"Config export finished (2/2).\\"\\r\\n    \\n\\r\\n    \\n\\r\\n    \\n# upload the system backup\\r\\n    \\n:log info message=\\"Uploading system backup (1/2).\\"\\r\\n    \\n/tool fetch address=\\"\\$ftphost\\" src-path=\\$fname1 user=\\"\\$ftpuser\\" mode=ftp password=\\"\\$ftppassword\\" dst-path=\\"\\$ftppath/\\$fname1\\" upload=yes\\r\\n    \\n# upload the config export\\r\\n    \\n:log info message=\\"Uploading config export (2/2).\\"\\r\\n    \\n/tool fetch address=\\"\\$ftphost\\" src-path=\\$fname2 user=\\"\\$ftpuser\\" mode=ftp password=\\"\\$ftppassword\\" dst-path=\\"\\$ftppath/\\$fname2\\" upload=yes\\r\\n    \\n\\r\\n    \\n# delay time to finish the upload - increase it if your backup file is big\\r\\n    \\n:delay 60s;\\r\\n    \\n# find file name start with UMDB- then remove\\r\\n    \\n:foreach i in=[/file find] do={ :if ([:typeof [:find [/file get \\$i name] \\"RTR-\\"]]!=\\"nil\\") do={/file remove \\$i}; }\\r\\n    \\n:log info message=\\"Configuration backup finished.\\";"\n`;
                config += `add dont-require-permissions=no name=dhcp-count owner=root policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon source="# List stats for IP -> Pool\\r\\n    \\n#\\r\\n    \\n# criticalthreshold = output pool display in red if pool used is above this %\\r\\n    \\n# warnthreshold = output pool display in gold if pool used is above this %\\r\\n    \\n\\r\\n    \\n:local criticalthreshold 85\\r\\n    \\n:local warnthreshold 70\\r\\n    \\n\\r\\n    \\n# Internal processing below...\\r\\n    \\n# ----------------------------------\\r\\n    \\n/ip pool {\\r\\n    \\n   :local poolname\\r\\n    \\n   :local pooladdresses\\r\\n    \\n   :local poolused\\r\\n    \\n   :local poolpercent\\r\\n    \\n   :local minaddress\\r\\n    \\n   :local maxaddress\\r\\n    \\n   :local findindex\\r\\n    \\n   :local tmpint\\r\\n    \\n   :local maxindex\\r\\n    \\n   :local line\\r\\n    \\n\\r\\n    \\n   :put (\\"IP Pool Statistics\\")\\r\\n    \\n   :put (\\"------------------\\")\\r\\n    \\n\\r\\n    \\n# Iterate through IP Pools\\r\\n    \\n   :foreach p in=[find] do={\\r\\n    \\n\\r\\n    \\n      :set poolname [get \\$p name]\\r\\n    \\n      :set pooladdresses 0\\r\\n    \\n      :set poolused 0\\r\\n    \\n      :set line \\"\\"\\r\\n    \\n\\r\\n    \\n      :set line (\\"     \\" . \\$poolname)\\r\\n    \\n\\r\\n    \\n#   Iterate through current pool's IP ranges\\r\\n    \\n      :foreach r in=[:toarray [get \\$p range]] do={\\r\\n    \\n\\r\\n    \\n#      Get min and max addresses\\r\\n    \\n         :set findindex [:find [:tostr \\$r] \\"-\\"]\\r\\n    \\n         :if ([:len \\$findindex] > 0) do={\\r\\n    \\n            :set minaddress [:pick [:tostr \\$r] 0 \\$findindex]\\r\\n    \\n            :set maxaddress [:pick [:tostr \\$r] (\\$findindex + 1) [:len [:tostr \\$r]]]\\r\\n    \\n         } else={\\r\\n    \\n            :set minaddress [:tostr \\$r]\\r\\n    \\n            :set maxaddress [:tostr \\$r]\\r\\n    \\n         }\\r\\n    \\n\\r\\n    \\n#       Convert to array of octets (replace '.' with ',')\\r\\n    \\n         :for x from=0 to=([:len [:tostr \\$minaddress]] - 1) do={\\r\\n    \\n            :if ([:pick [:tostr \\$minaddress] \\$x (\\$x + 1)] = \\".\\") do={\\r\\n    \\n               :set minaddress ([:pick [:tostr \\$minaddress] 0 \\$x] . \\",\\" . \\\\\\r\\n    \\n                                       [:pick [:tostr \\$minaddress] (\\$x + 1) [:len [:tostr \\$minaddress]]]) }\\r\\n    \\n         }\\r\\n    \\n         :for x from=0 to=([:len [:tostr \\$maxaddress]] - 1) do={\\r\\n    \\n            :if ([:pick [:tostr \\$maxaddress] \\$x (\\$x + 1)] = \\".\\") do={\\r\\n    \\n               :set maxaddress ([:pick [:tostr \\$maxaddress] 0 \\$x] . \\",\\" . \\\\\\r\\n    \\n                                       [:pick [:tostr \\$maxaddress] (\\$x + 1) [:len [:tostr \\$maxaddress]]]) }\\r\\n    \\n         }\\r\\n    \\n\\r\\n    \\n#      Calculate available addresses for current range\\r\\n    \\n         :if ([:len [:toarray \\$minaddress]] = [:len [:toarray \\$maxaddress]]) do={\\r\\n    \\n            :set maxindex ([:len [:toarray \\$minaddress]] - 1)\\r\\n    \\n            :for x from=\\$maxindex to=0 step=-1 do={\\r\\n    \\n#             Calculate 256^(\\$maxindex - \\$x)\\r\\n    \\n               :set tmpint 1\\r\\n    \\n               :if ((\\$maxindex - \\$x) > 0) do={\\r\\n    \\n                  :for y from=1 to=(\\$maxindex - \\$x) do={ :set tmpint (256 * \\$tmpint) }\\r\\n    \\n               }\\r\\n    \\n               :set tmpint (\\$tmpint * ([:tonum [:pick [:toarray \\$maxaddress] \\$x]] - \\\\\\r\\n    \\n                                                    [:tonum [:pick [:toarray \\$minaddress] \\$x]]) )\\r\\n    \\n               :set pooladdresses (\\$pooladdresses + \\$tmpint)\\r\\n    \\n#         for x\\r\\n    \\n            }\\r\\n    \\n\\r\\n    \\n#      if len array \\$minaddress = \\$maxaddress\\r\\n    \\n         }\\r\\n    \\n\\r\\n    \\n#      Add current range to total pool's available addresses\\r\\n    \\n         :set pooladdresses (\\$pooladdresses + 1)\\r\\n    \\n\\r\\n    \\n#   foreach r\\r\\n    \\n      }\\r\\n    \\n\\r\\n    \\n#   Now, we have the available address for all ranges in this pool\\r\\n    \\n#   Get the number of used addresses for this pool\\r\\n    \\n      :set poolused [:len [used find pool=[:tostr \\$poolname]]]\\r\\n    \\n      :set poolpercent ((\\$poolused * 100) / \\$pooladdresses)\\r\\n    \\n\\r\\n    \\n#   Output information\\r\\n    \\n      :set line ([:tostr \\$line] . \\"  [\\" . \\$poolused . \\"/\\" . \\$pooladdresses . \\"]\\")\\r\\n    \\n      :set line ([:tostr \\$line] . \\"  \\" . \\$poolpercent . \\" % used\\")\\r\\n    \\n\\r\\n    \\n#   Set colored display for used thresholds\\r\\n    \\n      :if ( [:tonum \\$poolpercent] > \\$criticalthreshold ) do={\\r\\n    \\n         :log error (\\"IP Pool \\" . \\$poolname . \\" is \\" . \\$poolpercent . \\"% full\\")\\r\\n    \\n         :put ([:terminal style varname] . \\$line)\\r\\n    \\n         :local Subject ([/system identity get name] . \\" DHCP pool \\$poolname is at \\$poolpercent % Full\\")\\r\\n    \\n         :local Body (\\"\\$poolused of \\$pooladdresses used\\")\\r\\n    \\n          /tool e-mail send to=\\"brad@team.nxlink.com\\" subject=\\$Subject body=\\$Body from=\\"DHCP-ALERT@nxlink.com\\"\\r\\n    \\n      } else={\\r\\n    \\n         :if ( [:tonum \\$poolpercent] > \\$warnthreshold ) do={\\r\\n    \\n            :log warning (\\"IP Pool \\" . \\$poolname . \\" is \\" . \\$poolpercent . \\"% full\\")\\r\\n    \\n            :put ([:terminal style syntax-meta] . \\$line)\\r\\n    \\n            :local Subject ([/system identity get name] . \\" DHCP pool \\$poolname is at \\$poolpercent % Full\\")\\r\\n    \\n            :local Body (\\"\\$poolused of \\$pooladdresses used\\")\\r\\n    \\n             /tool e-mail send to=\\"brad@team.nxlink.com\\" subject=\\$Subject body=\\$Body from=\\"DHCP-ALERT@nxlink.com\\"\\r\\n    \\n         } else={\\r\\n    \\n            :put ([:terminal style none] . \\$line)\\r\\n    \\n         }\\r\\n    \\n      }\\r\\n    \\n\\r\\n    \\n# foreach p\\r\\n    \\n   }\\r\\n    \\n# /ip pool\\r\\n    \\n}"\n\n`;
                }
                
                // Add NextLink compliance footer
                config += `\n# ========================================\n`;
                config += `# NextLink RFC Compliance Footer\n`;
                config += `# ========================================\n`;
                config += `# Configuration follows RFC compliance standards\n`;
                config += `# Baseline hardening applied\n`;
                config += `# Dynamic features configured based on selections\n`;
                config += `# Ready for deployment\n`;
                config += `# Backup recommended before import\n`;
                config += `# ========================================\n`;

                // Normalize the config order to match RouterOS standard
                const normalizedConfig = normalizeConfigOrder(config);
                
                // Separate metadata from router commands
                const metadataOutput = document.getElementById('metadataOutput');
                const configOutput = document.getElementById('output');
                // Split config into metadata (comments) and router commands
                const lines = normalizedConfig.split('\n');
                let metadata = [];
                let routerCommands = [];
                
                for (const line of lines) {
                    if (line.trim().startsWith('#') || line.trim().startsWith(':global') || line.trim() === '') {
                        metadata.push(line);
                    } else {
                        routerCommands.push(line);
                    }
                }
                
                metadataOutput.value = metadata.join('\n');
                configOutput.value = routerCommands.join('\n');
                downloadBtn.disabled = false;
                
                // Auto-update compliance status
                updateComplianceStatus();
                } catch (error) {
                    console.error('Error in generateConfig:', error);
                    alert('Error generating configuration: ' + error.message);
                }
            }

            // Initialize all event handlers and main functionality
            console.log('NextLink MikroTik Configuration Generator v2.0 Loaded');
            console.log('Device Support: RB1009, RB2011, CCR1036, RB5009, CCR2004, CCR2216');
            console.log('RouterOS Support: 6.45.2, 6.49.2, 7.11.2, 7.16.2, 7.19.4');
            console.log('Features: Dynamic device selection, compliance validation, auto-configuration');
            
            // Initialize all event handlers
            initializeEventHandlers();
            
            // Auto-validate on page load
            setTimeout(() => {
                updateComplianceStatus();
            }, 1000);
            
            // Tab switching functionality
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.content-pane').forEach(p => p.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById(tabName + '-pane').classList.add('active');
                });
            });
        });
        </script>
        
        <script>
        // Enterprise Config Functions
        function updateEnterpriseDeviceName() {
            const deviceType = document.getElementById('ent_deviceType').value;
            const customerCode = document.getElementById('ent_customerCode').value;
            if (deviceType && customerCode) {
                let prefix = 'RTR-MT';
                if (deviceType === 'CCR2004') prefix += 'CCR2004';
                else if (deviceType === 'CCR1036') prefix += 'CCR1036';
                else if (deviceType === 'RB5009') prefix += 'RB-5009';
                else if (deviceType === 'CCR2216') prefix += 'CCR2216';
                document.getElementById('ent_deviceName').value = `${prefix}.${customerCode}`;
            }
        }
        
        function updateMPLSEnterpriseDeviceName() {
            const deviceType = document.getElementById('ent_mpls_deviceType').value;
            const customerCode = document.getElementById('ent_mpls_customerCode').value;
            if (deviceType && customerCode) {
                let prefix = 'RTR-MT';
                if (deviceType === 'CCR2004') prefix += 'CCR2004';
                else if (deviceType === 'CCR1036') prefix += 'CCR1036';
                else if (deviceType === 'RB5009') prefix += 'RB-5009';
                else if (deviceType === 'CCR2216') prefix += 'CCR2216';
                else if (deviceType === 'CCR1072') prefix += 'CCR1072';
                document.getElementById('ent_mpls_deviceName').value = `${prefix}.${customerCode}`;
            }
        }
        
        // ===== Enterprise (Non‚ÄëMPLS) smart auto-fill helpers =====
        function ipToInt(ip) {
            const p = ip.split('.').map(Number);
            return ((p[0] << 24) >>> 0) + (p[1] << 16) + (p[2] << 8) + p[3];
        }
        function intToIp(n) {
            return [n >>> 24 & 255, n >>> 16 & 255, n >>> 8 & 255, n & 255].join('.');
        }
        function parseCidr(cidrStr) {
            if (!cidrStr || cidrStr.indexOf('/') === -1) return null;
            const [ip, maskStr] = cidrStr.trim().split('/');
            const mask = parseInt(maskStr, 10);
            if (isNaN(mask)) return null;
            const ipInt = ipToInt(ip);
            const netMask = mask === 0 ? 0 : (~0 << (32 - mask)) >>> 0;
            const network = ipInt & netMask;
            const broadcast = network + (~netMask >>> 0);
            const firstHost = mask >= 31 ? network : network + 1;
            const lastHost = mask >= 31 ? broadcast : broadcast - 1;
            return { ip, mask, network: intToIp(network >>> 0), broadcast: intToIp(broadcast >>> 0), firstHost: intToIp(firstHost >>> 0), lastHost: intToIp(lastHost >>> 0) };
        }
        function calcPoolExcluding(interfaceIpCidr) {
            const info = parseCidr(interfaceIpCidr);
            if (!info) return '';
            // If only one usable host, pool equals that host if different from interface IP
            const ifaceIp = interfaceIpCidr.split('/')[0];
            const first = ipToInt(info.firstHost);
            const last = ipToInt(info.lastHost);
            const iface = ipToInt(ifaceIp);
            if (first === last) {
                return iface !== first ? `${info.firstHost}-${info.lastHost}` : '';
            }
            // Exclude interface IP; choose continuous range(s)
            if (iface <= first) return `${intToIp(first + 1)}-${info.lastHost}`;
            if (iface >= last) return `${info.firstHost}-${intToIp(last - 1)}`;
            // Interface sits in the middle; prefer the upper slice by default
            const start = iface + 1;
            return `${intToIp(start)}-${info.lastHost}`;
        }
        function updatePublicPoolFromPublicIp() {
            const pub = document.getElementById('ent_publicIP')?.value?.trim();
            const out = document.getElementById('ent_publicPool');
            if (!pub || !out) return;
            const pool = calcPoolExcluding(pub);
            if (pool) out.value = pool;
        }
        function updatePrivatePoolFromPrivateIp() {
            const priv = document.getElementById('ent_privateIP')?.value?.trim();
            const out = document.getElementById('ent_privatePool');
            if (!priv || !out) return;
            const [ip, maskStr] = priv.split('/');
            const mask = parseInt(maskStr, 10);
            if (mask === 24) {
                const a = ip.split('.'); a[3] = '10'; const start = a.join('.');
                const b = ip.split('.'); b[3] = '254'; const end = b.join('.');
                out.value = `${start}-${end}`;
            } else {
                const pool = calcPoolExcluding(priv);
                if (pool) out.value = pool;
            }
        }
        function updateGatewayFromUplink() {
            const uplinkIp = document.querySelector('.ent_uplinkIP')?.value?.trim();
            const gw = document.getElementById('ent_gateway');
            if (!uplinkIp || !gw) return;
            const info = parseCidr(uplinkIp);
            if (!info) return;
            gw.value = info.firstHost; // first usable by default
        }
        function getDevicePortOptions(device) {
            const defaults = ['ether7','ether8','sfp-sfpplus1','sfp-sfpplus2'];
            if (!device) return defaults;
            if (device === 'ccr2004') return ['sfp-sfpplus7','sfp-sfpplus8','sfp-sfpplus1','sfp-sfpplus2','ether7','ether8'];
            if (device === 'ccr2216') return ['sfp28-1','sfp28-2','sfp28-3','sfp28-4','sfp28-5','sfp28-6','sfp28-7','sfp28-8','sfp28-9','sfp28-10','sfp28-11','sfp28-12','ether1'];
            if (device === 'rb5009') return ['ether2','ether3','ether4','ether5','ether6','ether7','ether8','sfp-sfpplus1'];
            return defaults;
        }
        function repopulateInterfaceSelect(sel, options, prefer) {
            if (!sel) return;
            const current = sel.value;
            sel.innerHTML = '<option value="">Select Interface</option>';
            options.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o; opt.textContent = o; sel.appendChild(opt);
            });
            if (prefer && options.includes(prefer)) sel.value = prefer; else if (options.length) sel.value = options[0];
        }
        function updateEnterpriseInterfaces() {
            const dev = document.getElementById('ent_routerboard_device')?.value;
            const ports = getDevicePortOptions(dev);
            const pubSel = document.getElementById('ent_publicInterface');
            const natSel = document.getElementById('ent_natInterface');
            const bhSel = document.getElementById('ent_backhaulInterface');
            repopulateInterfaceSelect(pubSel, ports, dev === 'ccr2004' ? 'ether7' : undefined);
            repopulateInterfaceSelect(natSel, ports, dev === 'ccr2004' ? 'ether8' : undefined);
            repopulateInterfaceSelect(bhSel, ports, ports.find(p => p.startsWith('sfp')) || ports[0]);
        }

        function handleEntDeviceChange() {
            const dev = document.getElementById('ent_routerboard_device')?.value || '';
            // Map routerboard device to legacy deviceType for naming
            const map = { ccr2004: 'CCR2004', ccr2216: 'CCR2216', ccr1036: 'CCR1036', rb5009: 'RB5009', ccr1072: 'CCR1072', rb2011: 'RB2011', rb1009: 'RB1009' };
            const legacy = map[dev] || '';
            const typeSel = document.getElementById('ent_deviceType');
            if (typeSel && legacy) { typeSel.value = legacy; updateEnterpriseDeviceName(); }
            updateEnterpriseInterfaces();
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('ent_deviceType').addEventListener('change', updateEnterpriseDeviceName);
            document.getElementById('ent_customerCode').addEventListener('input', updateEnterpriseDeviceName);
            // Auto-fill bindings for Enterprise (Non‚ÄëMPLS)
            const entDev = document.getElementById('ent_routerboard_device');
            if (entDev) entDev.addEventListener('change', handleEntDeviceChange);
            const pubIp = document.getElementById('ent_publicIP');
            if (pubIp) pubIp.addEventListener('input', updatePublicPoolFromPublicIp);
            const privIp = document.getElementById('ent_privateIP');
            if (privIp) privIp.addEventListener('input', updatePrivatePoolFromPrivateIp);
            const uplink = document.querySelector('.ent_uplinkIP');
            if (uplink) uplink.addEventListener('input', updateGatewayFromUplink);
            // Initial population
            handleEntDeviceChange();
            updatePublicPoolFromPublicIp();
            updatePrivatePoolFromPrivateIp();
            updateGatewayFromUplink();
            // Mark computed fields read-only for clarity
            const pubPool = document.getElementById('ent_publicPool');
            const priPool = document.getElementById('ent_privatePool');
            const gw = document.getElementById('ent_gateway');
            [pubPool, priPool, gw].forEach(el => { if (el) { el.readOnly = true; el.style.background = 'var(--output-bg)'; } });
            
            // Optional OSPF/BGP features event handlers
            const enableOSPF = document.getElementById('ent_enableOSPF');
            const enableBGP = document.getElementById('ent_enableBGP');
            const ospfBgpConfig = document.getElementById('ent_ospfBgpConfig');
            const ospfArea = document.getElementById('ent_ospfArea');
            const customOspfArea = document.getElementById('ent_customOspfArea');
            
            function toggleOspfBgpConfig() {
                if (enableOSPF.checked || enableBGP.checked) {
                    ospfBgpConfig.style.display = 'block';
                } else {
                    ospfBgpConfig.style.display = 'none';
                }
            }
            
            function toggleCustomOspfArea() {
                if (ospfArea.value === 'custom') {
                    customOspfArea.style.display = 'block';
                } else {
                    customOspfArea.style.display = 'none';
                }
            }
            
            if (enableOSPF) enableOSPF.addEventListener('change', toggleOspfBgpConfig);
            if (enableBGP) enableBGP.addEventListener('change', toggleOspfBgpConfig);
            if (ospfArea) ospfArea.addEventListener('change', toggleCustomOspfArea);
            
            // MPLS Enterprise event handlers
            document.getElementById('ent_mpls_deviceType').addEventListener('change', updateMPLSEnterpriseDeviceName);
            document.getElementById('ent_mpls_customerCode').addEventListener('input', updateMPLSEnterpriseDeviceName);
            const applyMplsBtn = document.getElementById('applyMplsPresetBtn');
            if (applyMplsBtn) applyMplsBtn.addEventListener('click', (e) => { e.preventDefault(); applyMplsPreset(); });
        });

        function applyMplsPreset() {
            // Apply a minimal preset: set device type only so UI shows proper interfaces.
            // Do NOT fill customer-specific fields (customerCode/deviceName/IPs/snmp) ‚Äî this tool is used dynamically per customer.
            document.getElementById('ent_mpls_deviceType').value = 'CCR2004';
            // Do not auto-fill customerCode, deviceName, loopback, public/private IPs, gateway, or SNMP.
            updateMPLSEnterpriseDeviceName();
        }
        
        function addEnterpriseUplink() {
            const container = document.getElementById('ent_uplinksContainer');
            const newUplink = document.createElement('div');
            newUplink.className = 'interface-item';
            newUplink.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div><label>Uplink Interface:</label>
                        <select class="ent_uplinkInterface">
                            <option value="">Select Interface</option>
                            <option value="sfp-sfpplus1">sfp-sfpplus1</option>
                            <option value="ether1">ether1</option>
                            <option value="ether2">ether2</option>
                            <option value="ether3">ether3</option>
                        </select>
                    </div>
                    <div><label>Uplink IP/Net:</label>
                        <input type="text" class="ent_uplinkIP" placeholder="10.1.241.92/29">
                    </div>
                </div>
                <div style="margin-top: 10px;"><label>Uplink Comment/Location:</label>
                    <input type="text" class="ent_uplinkComment" placeholder="TX-LOCATION-1">
                </div>
                <button class="remove-btn" onclick="this.parentElement.remove()">Remove Uplink</button>
            `;
            container.appendChild(newUplink);
        }
        
        function calculateNetworkAddress(ipCidr) {
            if (!ipCidr || !ipCidr.includes('/')) return '';
            const parts = ipCidr.split('/');
            const ip = parts[0];
            const cidr = parseInt(parts[1]);
            const ipParts = ip.split('.').map(Number);
            const mask = -1 << (32 - cidr);
            const network = [
                ipParts[0] & (mask >> 24 & 255),
                ipParts[1] & (mask >> 16 & 255),
                ipParts[2] & (mask >> 8 & 255),
                ipParts[3] & (mask & 255)
            ];
            return network.join('.');
        }
        function generateEnterpriseConfig() {
            try {
                const device = (document.getElementById('ent_routerboard_device') || {}).value || '';
                const version = (document.getElementById('ent_routeros_version') || {}).value || '';
                const loopback = (document.getElementById('ent_loopbackIP') || {}).value || '';
                const publicCidr = (document.getElementById('ent_publicIP') || {}).value || '';
                // Use simple BH field in AI mode if present
                const simpleBh = (document.getElementById('ent_bh_cidr_simple') || {}).value || '';
                const uplinkField = document.querySelector('#ent_uplinksContainer .ent_uplinkIP');
                const bhCidr = uplinkField ? uplinkField.value : '';
                const publicPort = (document.getElementById('ent_publicInterface') || {}).value || '';
                const natPort = (document.getElementById('ent_natInterface') || {}).value || '';
                const uplinkIf = (document.getElementById('ent_backhaulInterface') || {}).value || '';
                const identity = (document.getElementById('ent_deviceName') || {}).value || '';
                const lat = (document.getElementById('ent_latitude') || {}).value || '';
                const lon = (document.getElementById('ent_longitude') || {}).value || '';
                const coords = (lat && lon) ? (lat + ', ' + lon) : undefined;

                const effectiveBh = simpleBh || bhCidr;
                if (!loopback || !publicCidr || !effectiveBh) {
                    alert('Please provide Loopback /32, Public /29|/30, and Backhaul /29|/30.');
                return;
            }
            
                const payload = {
                    device,
                    target_version: version,
                    loopback_ip: loopback,
                    public_cidr: publicCidr,
                    bh_cidr: effectiveBh,
                    public_port: publicPort,
                    nat_port: natPort,
                    uplink_interface: uplinkIf,
                    identity,
                    coords
                };

                const btn = document.getElementById('generateEnterpriseBtn');
                if (btn) { btn.disabled = true; btn.textContent = 'Generating...'; }
                // Stage 1: Ask AI for suggestions to fill any missing/derived values
                const suggestPayload = {
                    device: device, target_version: version, loopback_ip: loopback, public_cidr: publicCidr, bh_cidr: effectiveBh
                };

                fetch('http://localhost:5000/api/suggest-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(suggestPayload)
                }).then(function(r){ return r.json(); }).then(function(sres){
                    if (sres && sres.success) {
                        // Merge helpful suggestions into payload (non-destructive)
                        if (sres.public_port && !publicPort) payload.public_port = sres.public_port;
                        if (sres.nat_port && !natPort) payload.nat_port = sres.nat_port;
                        if (sres.uplink_interface && !uplinkIf) payload.uplink_interface = sres.uplink_interface;
                        if (sres.public_pool && !document.getElementById('ent_publicPool')?.value) {
                            const f = document.getElementById('ent_publicPool'); if (f) f.value = sres.public_pool;
                        }
                        if (sres.gateway && !document.getElementById('ent_gateway')?.value) {
                            const f = document.getElementById('ent_gateway'); if (f) f.value = sres.gateway;
                        }
                    }
                    // Stage 2: Generate final config
                    return fetch('http://localhost:5000/api/gen-enterprise-non-mpls', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                    });
                })
                .then(function(r){ return r.json(); })
                .then(function(res){
                    if (!res || res.success !== true || !res.config) { throw new Error((res && res.error) || 'Generation failed'); }
                    window.enterpriseConfigOriginal = res.config;
                    window.enterprisePasswordsVisible = false;
                    displayEnterpriseConfig(false);
                })
                .catch(function(err){
                    console.error(err);
                    alert('Failed to generate enterprise config: ' + (err && err.message ? err.message : err));
                })
                .finally(function(){ if (btn) { btn.disabled = false; btn.textContent = 'üöÄ Generate Enterprise Configuration'; } });
            } catch (e) {
                console.error(e);
                alert('Unexpected error while generating config.');
            }
        }

        // === Non‚ÄëMPLS AI helpers ===
        function entAutofillFromExport() {
            const raw = (document.getElementById('ent_exportInput')||{}).value || '';
            if (!raw.trim()) { alert('Paste a RouterOS export first.'); return; }
            const btn = document.getElementById('entAutofillBtn'); if (btn) { btn.disabled = true; btn.textContent = 'Autofilling...'; }
            fetch('http://localhost:5000/api/autofill-from-export', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ config: raw })
            }).then(r=>r.json()).then(res=>{
                if (!res.success) throw new Error(res.error||'Autofill failed');
                // Map suggestions into fields if present
                if (res.device) { const map = { 'CCR2004':'ccr2004','CCR2216':'ccr2216','RB5009':'rb5009','CCR1036':'ccr1036','CCR2116':'ccr2116','CCR1072':'ccr1072' }; const devSel = document.getElementById('ent_routerboard_device'); if (devSel && map[res.device]) devSel.value = map[res.device]; }
                if (res.loopback_ip) { const f = document.getElementById('ent_loopbackIP'); if (f) f.value = res.loopback_ip.replace('/32','/32'); }
                if (res.public_cidr) { const f = document.getElementById('ent_publicIP'); if (f) f.value = res.public_cidr; }
                if (res.uplink_cidr) { const f = document.querySelector('.ent_uplinkIP'); if (f) f.value = res.uplink_cidr; }
                if (res.identity) { const f = document.getElementById('ent_deviceName'); if (f) f.value = res.identity; }
                handleEntDeviceChange(); updatePublicPoolFromPublicIp(); updatePrivatePoolFromPrivateIp(); updateGatewayFromUplink();
            }).catch(e=>{ alert('Autofill failed: '+e.message); }).finally(()=>{ if (btn) { btn.disabled=false; btn.textContent='üîÑ Autofill from Export'; } });
        }

        function entAISuggest() {
            const btn = document.getElementById('entSuggestBtn'); if (btn) { btn.disabled = true; btn.textContent = 'Suggesting...'; }
            const payload = {
                device: (document.getElementById('ent_routerboard_device')||{}).value,
                target_version: (document.getElementById('ent_routeros_version')||{}).value,
                loopback_ip: (document.getElementById('ent_loopbackIP')||{}).value,
                public_cidr: (document.getElementById('ent_publicIP')||{}).value,
                bh_cidr: (document.querySelector('.ent_uplinkIP')||{}).value
            };
            fetch('http://localhost:5000/api/suggest-config', {
                method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
            }).then(r=>r.json()).then(res=>{
                if (!res.success) throw new Error(res.error||'Suggest failed');
                // Apply non-destructive suggestions
                if (res.public_port) { const s = document.getElementById('ent_publicInterface'); if (s) s.value = res.public_port; }
                if (res.nat_port) { const s = document.getElementById('ent_natInterface'); if (s) s.value = res.nat_port; }
                if (res.uplink_interface) { const s = document.getElementById('ent_backhaulInterface'); if (s) s.value = res.uplink_interface; }
                if (res.public_pool) { const f = document.getElementById('ent_publicPool'); if (f) f.value = res.public_pool; }
                if (res.gateway) { const f = document.getElementById('ent_gateway'); if (f) f.value = res.gateway; }
            }).catch(e=>{ alert('Suggest failed: '+e.message); }).finally(()=>{ if (btn) { btn.disabled=false; btn.textContent='‚ú® AI Suggest'; } });
        }

        function entValidateDryRun() {
            const btn = document.getElementById('entValidateBtn'); if (btn) { btn.disabled = true; btn.textContent = 'Validating...'; }
            const config = (window.enterpriseConfigOriginal || document.getElementById('enterpriseOutput')?.textContent || '').trim();
            if (!config) { alert('Generate config first.'); if (btn) { btn.disabled=false; btn.textContent='üß™ Validate / Dry‚Äërun'; } return; }
            fetch('http://localhost:5000/api/validate-config', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ config }) })
            .then(r=>r.json()).then(res=>{
                const rep = document.getElementById('entValidateReport'); if (!rep) return;
                if (!res.success) { rep.textContent = 'Validation failed: '+(res.error||'Unknown'); return; }
                const issues = res.issues||[]; const errors = issues.filter(i=>i.severity==='error'); const warnings = issues.filter(i=>i.severity==='warning');
                rep.textContent = `Validation: ${errors.length} errors, ${warnings.length} warnings` + (issues.length? '\n- '+issues.map(i=>`[${i.severity}] ${i.message}`).join('\n- '):'\n(no issues)');
            }).catch(e=>{ alert('Validate failed: '+e.message); }).finally(()=>{ if (btn) { btn.disabled=false; btn.textContent='üß™ Validate / Dry‚Äërun'; } });
        }
        
        function maskPasswords(config) {
            // Replace all password values with asterisks
            return config.replace(/password=[^\s]+/g, 'password=**********');
        }
        
        function displayEnterpriseConfig(showPasswords) {
            const config = window.enterpriseConfigOriginal || '';
            const displayConfig = showPasswords ? config : maskPasswords(config);
            document.getElementById('enterpriseOutput').textContent = displayConfig;
            
            // Update button text
            const btn = document.getElementById('toggleEntPasswordBtn');
            if (btn) {
                btn.textContent = showPasswords ? 'üîí Hide Passwords' : 'üëÅÔ∏è Show Passwords';
                btn.style.background = showPasswords ? '#dc3545' : '#FF9800';
            }
        }
        
        function toggleEnterprisePasswords() {
            if (!window.enterpriseConfigOriginal) {
                alert('Please generate a configuration first!');
                return;
            }
            window.enterprisePasswordsVisible = !window.enterprisePasswordsVisible;
            displayEnterpriseConfig(window.enterprisePasswordsVisible);
        }
        
        function copyEnterpriseConfig() {
            // Always copy the REAL config with passwords
            const config = window.enterpriseConfigOriginal || document.getElementById('enterpriseOutput').textContent;
            if (!config) { alert('No configuration to copy!'); return; }
            navigator.clipboard.writeText(config).then(() => alert('‚úÖ Configuration copied to clipboard (with real passwords)!')).catch(err => alert('Failed to copy: ' + err));
        }
        function downloadEnterpriseConfig() {
            // Always download the REAL config with passwords
            const config = window.enterpriseConfigOriginal || document.getElementById('enterpriseOutput').textContent;
            if (!config) { alert('No configuration to download!'); return; }
            const deviceName = document.getElementById('ent_deviceName').value || 'enterprise-config';
            const date = new Date().toISOString().split('T')[0];
            const filename = `${date}_${deviceName}.rsc`;
            const blob = new Blob([config], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function clearEnterpriseOutput() {
            document.getElementById('enterpriseOutput').textContent = '';
            window.enterpriseConfigOriginal = '';
            window.enterprisePasswordsVisible = false;
            const btn = document.getElementById('toggleEntPasswordBtn');
            if (btn) {
                btn.textContent = 'üëÅÔ∏è Show Passwords';
                btn.style.background = '#FF9800';
            }
        }
        // ===== MPLS ENTERPRISE CONFIG FUNCTIONS =====
        
        function generateMPLSEnterpriseConfig() {
            let config = '';
            const deviceType = document.getElementById('ent_mpls_deviceType').value;
            const customerCode = document.getElementById('ent_mpls_customerCode').value;
            const deviceName = document.getElementById('ent_mpls_deviceName').value;
            const loopbackIPRaw = document.getElementById('ent_mpls_loopbackIP').value;
            const latitude = document.getElementById('ent_mpls_latitude').value;
            const longitude = document.getElementById('ent_mpls_longitude').value;
            const publicIP = (document.getElementById('ent_mpls_publicIP') ? document.getElementById('ent_mpls_publicIP').value : '');
            const publicPool = (document.getElementById('ent_mpls_publicPool') ? document.getElementById('ent_mpls_publicPool').value : '');
            const privateIP = (document.getElementById('ent_mpls_privateIP') ? document.getElementById('ent_mpls_privateIP').value : '');
            const privatePool = (document.getElementById('ent_mpls_privatePool') ? document.getElementById('ent_mpls_privatePool').value : '');
            const gateway = (document.getElementById('ent_mpls_gateway') ? document.getElementById('ent_mpls_gateway').value : '');
            const publicInterface = (document.getElementById('ent_mpls_publicInterface') ? document.getElementById('ent_mpls_publicInterface').value : '');
            const natInterface = (document.getElementById('ent_mpls_natInterface') ? document.getElementById('ent_mpls_natInterface').value : '');
            const snmpCommunity = (document.getElementById('ent_mpls_snmpCommunity') ? document.getElementById('ent_mpls_snmpCommunity').value : '');
            
            // Normalize device type and derive device config
            // Map UI values like "CCR2004" -> "ccr2004" which match DEVICE_CONFIGS keys
            let deviceKey = (deviceType || '').toLowerCase();
            // reasonable assumption: CCR1072 similar to CCR1036 if not present
            if (deviceKey === 'ccr1072') deviceKey = 'ccr1036';
            const deviceConfig = (window.DEVICE_CONFIGS && window.DEVICE_CONFIGS[deviceKey]) ? window.DEVICE_CONFIGS[deviceKey] : DEVICE_CONFIGS.ccr2004;

            // Extract loopback IP without /32
            const loopbackIP = loopbackIPRaw.replace('/32', '');
            
            // Require only device type, customer code, and loopback - public/private/gateway are BNG-managed and optional
            if (!deviceType || !customerCode || !loopbackIPRaw) {
                alert('Please fill in all required fields (device type, customer code, loopback)!');
                return;
            }
            
            // Collect all uplink data for MPLS
            const uplinks = document.querySelectorAll('#ent_mpls_uplinksContainer .interface-item');
            const uplinkData = [];
            uplinks.forEach((uplink, index) => {
                const uplinkInterface = uplink.querySelector('.ent_mpls_uplinkInterface').value;
                const uplinkIP = uplink.querySelector('.ent_mpls_uplinkIP').value;
                const uplinkComment = uplink.querySelector('.ent_mpls_uplinkComment').value;
                if (uplinkInterface && uplinkIP) {
                    uplinkData.push({
                        interface: uplinkInterface,
                        ip: uplinkIP,
                        comment: uplinkComment || `Uplink-${index + 1}`
                    });
                }
            });

            // Parse BGP ASN and peers only if BGP is explicitly enabled
            const enableBGP = (document.getElementById('ent_mpls_enableBGP') && document.getElementById('ent_mpls_enableBGP').checked);
            const bgpAsRaw = enableBGP && document.getElementById('ent_mpls_bgpAs') ? document.getElementById('ent_mpls_bgpAs').value.trim() : '';
            const bgpPeersRaw = enableBGP && document.getElementById('ent_mpls_bgpPeers') ? document.getElementById('ent_mpls_bgpPeers').value.trim() : '';
            const bgpAs = bgpAsRaw ? parseInt(bgpAsRaw, 10) : null;
            const bgpPeers = [];
            if (bgpPeersRaw) {
                bgpPeersRaw.split(',').forEach(p => {
                    const parts = p.trim().split(':');
                    if (parts[0]) {
                        bgpPeers.push({ ip: parts[0].trim(), as: parts[1] ? parseInt(parts[1].trim(), 10) : null });
                    }
                });
            }
            const dns1 = '142.147.112.3';
            const dns2 = '142.147.112.19';
            const syslogServer = '142.147.116.215';
            
            // Pick a sensible public interface if user didn't choose one based on device defaults
            let effectivePublicIf = publicInterface;
            if (!effectivePublicIf) {
                effectivePublicIf = (deviceConfig.sfpPorts && deviceConfig.sfpPorts.length > 0) ? deviceConfig.sfpPorts[0] : (deviceConfig.ports && deviceConfig.ports.length > 0 ? deviceConfig.ports[0] : 'ether1');
            }

            // MPLS Configuration Structure
            config += `\n\n# MPLS Enterprise Configuration for ${deviceName}\n\n`;
            
            // Interface Bridges (MPLS Structure)
            config += `/interface bridge\n`;
            config += `add comment=DYNAMIC name=bridge1000 protocol-mode=none\n`;
            config += `add comment=STATIC name=bridge2000 protocol-mode=none\n`;
            config += `add comment=INFRA name=bridge3000 protocol-mode=none\n`;
            config += `add comment=CPE name=bridge4000 protocol-mode=none\n`;
            config += `add comment=LOOPBACK name=loop0\n\n`;
            
            // Interface Ethernet Configuration
            // Apply ethernet settings to actual uplink interfaces (if provided) to avoid static/incorrect ports
            if (uplinkData.length > 0) {
                config += `/interface ethernet\n`;
                uplinkData.forEach(u => {
                    const commentSafe = u.comment && String(u.comment).trim() ? `"${String(u.comment).replace(/\"/g,'') }"` : `"${customerCode}-${deviceType}"`;
                    config += `set [ find default-name=${u.interface} ] auto-negotiation=no comment=${commentSafe} l2mtu=9212 mtu=9198 speed=1G-baseT-full\n`;
                });
                config += `\n`;
            } else if (effectivePublicIf) {
                // fallback if user selected a public interface but no uplink entries provided
                const commentSafe = `"${customerCode}-${deviceType}"`;
                config += `/interface ethernet\n`;
                config += `set [ find default-name=${effectivePublicIf} ] auto-negotiation=no comment=${commentSafe} l2mtu=9212 mtu=9198 speed=1G-baseT-full\n\n`;
            }
            
            // VPLS Configuration
            config += `/interface vpls\n`;
            config += `add arp=enabled bridge=bridge2000 bridge-horizon=1 cisco-static-id=2247 disabled=no mac-address=02:F0:0E:EC:A9:31 mtu=1500 name=vpls2000-bng1 peer=10.254.247.3 pw-control-word=disabled pw-l2mtu=1580 pw-type=raw-ethernet\n\n`;
            
            // OSPF Configuration - handle v6 vs v7 syntax
            if (deviceConfig.ospfSyntax === 'v7') {
                config += `/routing ospf instance\n`;
                config += `add disabled=no name=default-v2 router-id=${loopbackIP}\n`;
                config += `/routing ospf area\n`;
                config += `add disabled=no instance=default-v2 name=area0\n\n`;
                // v7 uses interface-template for ptp definitions later
            } else {
                // v6-style minimal instance + area
                config += `/routing ospf instance\n`;
                config += `add disabled=no name=default-v2 router-id=${loopbackIP}\n`;
                config += `/routing ospf area\n`;
                config += `add disabled=no instance=default-v2 name=area0\n\n`;
            }
            
            // SNMP Community Configuration
            config += `/snmp community\n`;
            config += `set [ find default=yes ] read-access=no\n`;
            config += `add addresses=::/0 name=${snmpCommunity}\n\n`;
            
            // System Logging Action
            config += `/system logging action\n`;
            config += `set 0 memory-lines=100\n`;
            config += `set 1 disk-lines-per-file=10000\n`;
            config += `add name=syslog remote=${syslogServer} src-address=${loopbackIP} target=remote\n\n`;
            
            // User Groups (MPLS Structure)
            config += `/user group\n`;
            config += `set read policy=local,telnet,ssh,read,test,winbox,sniff,!ftp,!reboot,!write,!policy,!password,!web,!sensitive,!api,!romon,!rest-api\n`;
            config += `add name=ENG policy=local,telnet,ssh,ftp,reboot,read,write,policy,test,winbox,password,web,sniff,sensitive,api,romon,rest-api\n`;
            config += `add name=NOC policy=local,telnet,ssh,ftp,reboot,read,write,test,winbox,password,sniff,sensitive,!policy,!web,!api,!romon,!rest-api\n`;
            config += `add name=LTE policy=local,telnet,ssh,reboot,read,write,test,winbox,password,sniff,sensitive,!ftp,!policy,!web,!api,!romon,!rest-api\n`;
            config += `add name=DEVOPS policy=local,telnet,ssh,ftp,reboot,read,write,policy,test,winbox,password,web,sniff,sensitive,api,romon,rest-api\n`;
            config += `add name=VOIP policy=local,telnet,ssh,read,test,winbox,sniff,!ftp,!reboot,!write,!policy,!password,!web,!sensitive,!api,!romon,!rest-api\n`;
            config += `add name=STS policy=local,telnet,ssh,read,test,winbox,sniff,!ftp,!reboot,!write,!policy,!password,!web,!sensitive,!api,!romon,!rest-api\n`;
            config += `add name=TECHSUPPORT policy=local,telnet,read,test,winbox,sniff,!ssh,!ftp,!reboot,!write,!policy,!password,!web,!sensitive,!api,!romon,!rest-api\n`;
            config += `add name=INFRA policy=local,telnet,reboot,read,write,test,winbox,!ssh,!ftp,!policy,!password,!web,!sniff,!sensitive,!api,!romon,!rest-api\n`;
            config += `add name=INSTALL policy=local,telnet,reboot,read,write,test,winbox,!ssh,!ftp,!policy,!password,!web,!sniff,!sensitive,!api,!romon,!rest-api\n`;
            config += `add name=COMENG policy=local,telnet,ssh,reboot,read,write,test,winbox,sniff,!ftp,!policy,!password,!web,!sensitive,!api,!romon,!rest-api\n`;
            config += `add name=INTEGRATIONS policy=local,telnet,ssh,ftp,reboot,read,write,policy,test,winbox,password,web,sniff,sensitive,api,romon,rest-api\n`;
            config += `add name=IDO policy=local,telnet,ssh,reboot,read,write,test,winbox,password,sniff,sensitive,!ftp,!policy,!web,!api,!romon,!rest-api\n`;
            config += `add name=CALLCENTER-WRITE policy=local,telnet,ssh,read,write,test,winbox,sniff,!ftp,!reboot,!policy,!password,!web,!sensitive,!api,!romon,!rest-api\n`;
            config += `add name=CONTRACTOR policy=local,telnet,ssh,ftp,reboot,read,write,test,winbox,password,sniff,sensitive,!policy,!web,!api,!romon,!rest-api\n\n`;
            
            // Bridge Port Configuration
            // ...existing code...
            // REPLACED: Assign customer handoff and NAT interfaces to their bridges and add uplinks to backhaul bridge
            config += `/interface bridge port\n`;
            // Customer handoff interface -> bridge2000
            if (publicInterface) config += `add bridge=bridge2000 interface=${publicInterface}\n`;
            // NAT/CPE interface -> bridge4000
            if (natInterface) config += `add bridge=bridge4000 interface=${natInterface}\n`;
            // fallback: attach effectivePublicIf to handoff bridge when publicInterface not set
            if (!publicInterface && effectivePublicIf) {
                config += `add bridge=bridge2000 interface=${effectivePublicIf}\n`;
            }
            config += `\n`;
            
            // IP Address Configuration - only loopback and uplink IPs are added here
            config += `/ip address\n`;
            // ensure loopback is added as /32 network explicitly
            const loopbackWithMask = loopbackIPRaw.includes('/') ? loopbackIPRaw : (loopbackIP + '/32');
            config += `add address=${loopbackWithMask} interface=loop0 network=${loopbackIP}/32\n`;
            // Add any uplink IPs (these are the actual interfaces used for backhaul)
            if (uplinkData.length > 0) {
                uplinkData.forEach(u => {
                    if (u.ip) {
                        // compute network base with CIDR for ptp/ospf usage
                        let network = u.ip;
                        if (u.ip.includes('/')) {
                            const cidr = u.ip.split('/')[1];
                            network = calculateNetwork(u.ip) + '/' + cidr;
                        }
                        const commentSafe = u.comment && String(u.comment).trim() ? `"${String(u.comment).replace(/\"/g,'') }"` : `"uplink"`;
                        config += `add address=${u.ip} interface=${u.interface} comment=${commentSafe} network=${network}\n`;
                    }
                });
            }
            config += `\n`;
            
            // DNS Configuration
            config += `/ip dns\n`;
            config += `set servers=${dns1},${dns2}\n\n`;
            
            // Firewall Address Lists (MPLS Structure)
            config += `/ip firewall address-list\n`;
            config += `add address=10.0.0.0/8 list=EOIP-ALLOW\n`;
            config += `add address=192.168.128.0/21 list=managerIP\n`;
            config += `add address=107.178.5.97 list=managerIP\n`;
            config += `add address=198.100.53.0/25 list=managerIP\n`;
            config += `add address=143.55.62.143 list=managerIP\n`;
            config += `add address=142.147.127.2 list=managerIP\n`;
            config += `add address=132.147.132.6 list=managerIP\n`;
            config += `add address=67.219.122.201 list=managerIP\n`;
            config += `add address=10.0.0.0/8 list=BGP-ALLOW\n`;
            config += `add address=143.55.35.47 list=SNMP\n`;
            config += `add address=107.178.15.15 list=SNMP\n`;
            config += `add address=107.178.15.162 list=SNMP\n`;
            config += `add address=142.147.112.4 list=SNMP\n`;
            config += `add address=142.147.124.26 list=SNMP\n`;
            config += `add address=107.178.5.97 list=SNMP\n`;
            config += `add address=67.219.126.240/28 list=SNMP\n`;
            config += `add address=198.100.53.120 list=SNMP\n`;
            config += `add address=143.55.62.143 list=SNMP\n`;
            config += `add address=132.147.138.2 list=SNMP\n`;
            config += `add address=132.147.138.0 list=SNMP\n`;
            config += `add address=132.147.138.6 list=SNMP\n`;
            config += `add address=132.147.138.23 list=SNMP\n`;
            config += `add address=132.147.138.29 list=SNMP\n`;
            config += `add address=132.147.138.30 list=SNMP\n`;
            config += `add address=132.147.138.31 list=SNMP\n`;
            config += `add address=143.55.37.40 list=SNMP\n`;
            config += `add address=143.55.37.41 list=SNMP\n`;
            config += `add address=132.147.132.24 list=SNMP\n`;
            config += `add address=198.100.49.99 list=SNMP\n`;
            config += `add address=132.147.132.26 list=SNMP\n`;
            config += `add address=204.11.183.126 list=SNMP\n`;
            config += `add address=173.215.67.124 list=SNMP\n`;
            config += `add address=132.147.138.3 list=SNMP\n`;
            config += `add address=132.147.138.7 list=SNMP\n`;
            config += `add address=132.147.138.21 list=SNMP\n`;
            config += `add address=132.147.138.26 list=SNMP\n\n`;
            
            // Firewall Filter Rules (MPLS Structure)
            config += `/ip firewall filter\n`;
            config += `add action=accept chain=input comment="ALLOW EST REL" connection-state=established,related,untracked\n`;
            config += `add action=accept chain=input comment="ALLOW MT NEIGHBOR" dst-port=5678 protocol=udp\n`;
            config += `add action=accept chain=input comment="ALLOW MAC TELNET" dst-port=20561 protocol=udp\n`;
            config += `add action=accept chain=input comment="ALLOW IGMP" protocol=igmp\n`;
            config += `add action=accept chain=input comment="ALLOW ICMP" protocol=icmp\n`;
            config += `add action=accept chain=input comment="ALLOW DHCPv4" dst-port=67 protocol=udp\n`;
            config += `add action=accept chain=input comment="ALLOW DHCPv6" dst-port=547 protocol=udp\n`;
            config += `add action=accept chain=input comment="ALLOW OSPF" protocol=ospf\n`;
            config += `add action=accept chain=input comment="ALLOW LDP" dst-port=646 protocol=tcp\n`;
            config += `add action=accept chain=input comment="ALLOW LDP" dst-port=646 protocol=udp\n`;
            config += `add action=accept chain=input comment="ALLOW MANAGER IP" src-address-list=managerIP\n`;
            config += `add action=accept chain=input comment="ALLOW BGP" dst-port=179 protocol=tcp src-address-list=BGP-ALLOW\n`;
            config += `add action=accept chain=input comment="ALLOW EOIP" protocol=gre src-address-list=EOIP-ALLOW\n`;
            config += `add action=accept chain=input comment="ALLOW SNMP" dst-port=161 protocol=tcp src-address-list=SNMP\n`;
            config += `add action=drop chain=input comment="DROP INPUT"\n\n`;
            
            // Firewall Raw Rules
            config += `/ip firewall raw\n`;
            config += `add action=drop chain=prerouting comment="DROP BAD UDP" port=0 protocol=udp\n\n`;
            
            // Service Ports Configuration
            config += `/ip service\n`;
            config += `set telnet disabled=yes port=5023\n`;
            config += `set ftp disabled=yes port=5021\n`;
            config += `set www disabled=yes port=1234\n`;
            config += `set ssh port=5022\n`;
            config += `set www-ssl disabled=no\n`;
            config += `set api disabled=yes\n`;
            config += `set api-ssl disabled=yes\n\n`;
            
            // MPLS Configuration
            config += `/mpls interface\n`;
            config += `add disabled=no interface=all mpls-mtu=1600\n\n`;
            
            // MPLS LDP Configuration
            config += `/mpls ldp\n`;
            config += `add afi=ip disabled=no distribute-for-default=no hop-limit=255 loop-detect=no lsr-id=${loopbackIP} path-vector-limit=255 transport-addresses=${loopbackIP} use-explicit-null=no vrf=main\n\n`;
            
            // MPLS LDP Interface
            config += `/mpls ldp interface\n`;
            // add per-uplink entries (preferred) otherwise add effectivePublicIf
            if (uplinkData.length > 0) {
                uplinkData.forEach(u => {
                    config += `add comment=${u.comment} interface=${u.interface}\n`;
                });
                config += `\n`;
            } else if (effectivePublicIf) {
                config += `add comment=${customerCode}-${deviceType} interface=${effectivePublicIf}\n\n`;
            }
            // Radius Configuration
            config += `/radius\n`;
            config += `add address=10.30.10.70 comment="userRAD 1" require-message-auth=no secret=qmG%Q5k^C06%uLe* service=login src-address=${loopbackIP}\n`;
            config += `add address=10.2.10.74 comment="userRAD 2" require-message-auth=no secret=qmG%Q5k^C06%uLe* service=login src-address=${loopbackIP}\n\n`;
            
            // OSPF Interface Template
            config += `/routing ospf interface-template\n`;
            config += `add area=area0 cost=10 disabled=no interfaces=loop0 networks=${loopbackIP}/32 passive priority=1\n`;
            // Add a ptp OSPF interface-template based on first uplink interface/network (explicit from user)
            let ptpNetwork = null;
            let ptpInterface = null;
            if (uplinkData.length > 0) {
                // use first uplink's network (keep CIDR) and its interface
                const first = uplinkData[0].ip;
                ptpInterface = uplinkData[0].interface;
                if (first && first.includes('/')) {
                    const cidr = first.split('/')[1];
                    ptpNetwork = calculateNetwork(first) + '/' + cidr;
                } else {
                    ptpNetwork = first;
                }
            } else if (publicIP) {
                if (publicIP.includes('/')) {
                    const cidr = publicIP.split('/')[1];
                    ptpNetwork = calculateNetwork(publicIP) + '/' + cidr;
                } else {
                    ptpNetwork = publicIP;
                }
                ptpInterface = effectivePublicIf;
            }
            if (ptpInterface && ptpNetwork) {
                const commentSafe = `"${customerCode}-${deviceType}"`;
                config += `add area=area0 auth=md5 auth-id=1 auth-key=m8M5JwvdYM comment=${commentSafe} cost=10 disabled=no interfaces=${ptpInterface} networks=${ptpNetwork} priority=1 type=ptp\n\n`;
            }

            // NOTE: For MPLS enterprise devices we do NOT provision BGP here by default.
            // BGP is expected to be managed by upstream/core or added only when explicitly requested.
            // If you need BGP generated for a specific site, enable it via the BGP ASN field in the UI and we can toggle it.
            
            // SNMP Configuration
            config += `/snmp\n`;
            config += `set contact=noc@team.nxlink.com enabled=yes location=${latitude},${longitude} src-address=${loopbackIP} trap-community=${snmpCommunity}\n\n`;
            
            // System Clock
            config += `/system clock\n`;
            config += `set time-zone-name=America/Chicago\n\n`;
            
            // System Identity
            config += `/system identity\n`;
            config += `set name=${deviceName}\n\n`;
            
            // System Logging
            config += `/system logging\n`;
            config += `add action=syslog topics=critical\n`;
            config += `add action=syslog topics=error\n`;
            config += `add action=syslog topics=info\n`;
            config += `add action=syslog topics=warning\n`;
            config += `add disabled=yes topics=debug\n`;
            config += `add action=disk topics=critical\n`;
            config += `add action=disk topics=error\n`;
            config += `add action=disk topics=info\n`;
            config += `add topics=warning\n\n`;
            
            // System Note
            config += `/system note\n`;
            config += `set show-at-login=no\n\n`;
            
            // NTP Client
            config += `/system ntp client\n`;
            config += `set enabled=yes\n`;
            config += `/system ntp client servers\n`;
            config += `add address=ntp-pool.nxlink.com\n\n`;
            
            // Routerboard Settings
            config += `/system routerboard settings\n`;
            config += `set auto-upgrade=yes\n\n`;
            
            // User AAA
            config += `/user aaa\n`;
            config += `set use-radius=yes\n\n`;
            
            // BNG Configuration Section
            config += `\n\n################################\n`;
            config += `###       BNG CONFIGS        ###\n`;
            config += `################################\n\n`;
            config += `# Copy and Paste these lines into the BNGs removing the leading # sign\n\n`;
            config += `# MT BNG\n\n`;
            config += `#/interface vpls add name=vpls2000-${deviceName} disabled=no advertised-l2mtu=1580 cisco-style=yes cisco-style-id= comment="VPLS2000-${deviceName}"  remote-peer=${loopbackIP}\n\n`;
            config += `#/interface bridge port add bridge=bridge2000 interface=vpls2000-${deviceName} horizon=1\n\n`;
            config += `# Nokia BNG\n\n`;
            config += `#show service sdp     ###Shows used SDP IDs###\n\n`;
            config += `#/configure service sdp <Next available SdpId> mpls create\n`;
            config += `#/configure service sdp <Next available SdpId> mpls description ${deviceName}     ###Adds tower description###\n`;
            config += `#/configure service sdp <Next available SdpId> mpls far-end ${loopbackIP}           ###Tower Loop###\n`;
            config += `#/configure service sdp <Next available SdpId> mpls ldp                          ###ldp for OMAHA, bgp-tunnel for CHICAGO\n`;
            config += `#/configure service sdp <Next available SdpId> mpls keep-alive shutdown\n`;
            config += `#/configure service sdp <Next available SdpId> mpls no shutdown\n\n`;
            config += `#/configure service vpls  mesh-sdp <next available>: create restrict-protected-src discard-frame\n`;
            config += `#/configure service vpls  mesh-sdp <next available>: no shutdown\n\n`;
            
            // Store original config globally for password toggling
            window.mplsEnterpriseConfigOriginal = config;
            window.mplsEnterprisePasswordsVisible = false;
            
            // Display with passwords hidden by default
            displayMPLSEnterpriseConfig(false);
        }

        function displayMPLSEnterpriseConfig(showPasswords) {
            const config = window.mplsEnterpriseConfigOriginal || '';
            const displayConfig = showPasswords ? config : maskPasswords(config);
            document.getElementById('mplsEnterpriseOutput').textContent = displayConfig;
        }

        function toggleMPLSEnterprisePasswords() {
            if (!window.mplsEnterpriseConfigOriginal) {
                alert('Please generate a configuration first!');
                return;
            }
            window.mplsEnterprisePasswordsVisible = !window.mplsEnterprisePasswordsVisible;
            displayMPLSEnterpriseConfig(window.mplsEnterprisePasswordsVisible);
        }

        function copyMPLSEnterpriseConfig() {
            const config = window.mplsEnterpriseConfigOriginal || document.getElementById('mplsEnterpriseOutput').textContent;
            if (!config) { alert('No configuration to copy!'); return; }
            navigator.clipboard.writeText(config).then(() => alert('‚úÖ Configuration copied to clipboard (with real passwords)!')).catch(err => alert('Failed to copy: ' + err));
        }
        function downloadMPLSEnterpriseConfig() {
            const config = window.mplsEnterpriseConfigOriginal || document.getElementById('mplsEnterpriseOutput').textContent;
            if (!config) { alert('No configuration to download!'); return; }
            const deviceName = document.getElementById('ent_mpls_deviceName').value || 'mpls-enterprise-config';
            const blob = new Blob([config], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${deviceName}.rsc`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function clearMPLSEnterpriseOutput() {
            document.getElementById('mplsEnterpriseOutput').textContent = '';
            window.mplsEnterpriseConfigOriginal = '';
            window.mplsEnterprisePasswordsVisible = false;
            const btn = document.getElementById('toggleMPLSEntPasswordBtn');
            if (btn) btn.textContent = 'üëÅÔ∏è Show Passwords';
        }
        function addMPLSUplink() {
            const container = document.getElementById('ent_mpls_uplinksContainer');
            const newUplink = document.createElement('div');
            newUplink.className = 'interface-item';
            newUplink.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label>Uplink Interface:</label>
                        <select class="ent_mpls_uplinkInterface">
                            <option value="">Select Interface</option>
                            <!-- CCR2004 Interfaces -->
                            <option value="ether1">ether1 (CCR2004)</option>
                            <option value="sfp-sfpplus1">sfp-sfpplus1 (CCR2004)</option>
                            <option value="sfp-sfpplus2">sfp-sfpplus2 (CCR2004)</option>
                            <option value="sfp-sfpplus3">sfp-sfpplus3 (CCR2004)</option>
                            <option value="sfp-sfpplus4">sfp-sfpplus4 (CCR2004)</option>
                            <option value="sfp-sfpplus5">sfp-sfpplus5 (CCR2004)</option>
                            <option value="sfp-sfpplus6">sfp-sfpplus6 (CCR2004)</option>
                            <option value="sfp-sfpplus7">sfp-sfpplus7 (CCR2004)</option>
                            <option value="sfp-sfpplus8">sfp-sfpplus8 (CCR2004)</option>
                            <option value="sfp-sfpplus9">sfp-sfpplus9 (CCR2004)</option>
                            <option value="sfp-sfpplus10">sfp-sfpplus10 (CCR2004)</option>
                            <option value="sfp-sfpplus11">sfp-sfpplus11 (CCR2004)</option>
                            <option value="sfp-sfpplus12">sfp-sfpplus12 (CCR2004)</option>
                            <option value="sfp28-1">sfp28-1 (CCR2004)</option>
                            <option value="sfp28-2">sfp28-2 (CCR2004)</option>
                            <!-- CCR1036 Interfaces -->
                            <option value="ether1">ether1 (CCR1036)</option>
                            <option value="ether2">ether2 (CCR1036)</option>
                            <option value="ether3">ether3 (CCR1036)</option>
                            <option value="ether4">ether4 (CCR1036)</option>
                            <option value="ether5">ether5 (CCR1036)</option>
                            <option value="ether6">ether6 (CCR1036)</option>
                            <option value="ether7">ether7 (CCR1036)</option>
                            <option value="ether8">ether8 (CCR1036)</option>
                            <option value="ether9">ether9 (CCR1036)</option>
                            <option value="ether10">ether10 (CCR1036)</option>
                            <option value="ether11">ether11 (CCR1036)</option>
                            <option value="ether12">ether12 (CCR1036)</option>
                            <option value="sfp1">sfp1 (CCR1036)</option>
                            <option value="sfp2">sfp2 (CCR1036)</option>
                            <option value="sfp3">sfp3 (CCR1036)</option>
                            <option value="sfp4">sfp4 (CCR1036)</option>
                            <!-- RB5009 Interfaces -->
                            <option value="ether1">ether1 (RB5009)</option>
                            <option value="ether2">ether2 (RB5009)</option>
                            <option value="ether3">ether3 (RB5009)</option>
                            <option value="ether4">ether4 (RB5009)</option>
                            <option value="ether5">ether5 (RB5009)</option>
                            <option value="ether6">ether6 (RB5009)</option>
                            <option value="ether7">ether7 (RB5009)</option>
                            <option value="ether8">ether8 (RB5009)</option>
                            <option value="sfp-sfpplus1">sfp-sfpplus1 (RB5009)</option>
                            <!-- CCR2216 Interfaces -->
                            <option value="qsfp1">qsfp1 (CCR2216)</option>
                            <option value="qsfp2">qsfp2 (CCR2216)</option>
                            <option value="qsfp3">qsfp3 (CCR2216)</option>
                            <option value="qsfp4">qsfp4 (CCR2216)</option>
                            <option value="sfp28-1">sfp28-1 (CCR2216)</option>
                            <option value="sfp28-2">sfp28-2 (CCR2216)</option>
                            <option value="sfp28-3">sfp28-3 (CCR2216)</option>
                            <option value="sfp28-4">sfp28-4 (CCR2216)</option>
                            <option value="sfp28-5">sfp28-5 (CCR2216)</option>
                            <option value="sfp28-6">sfp28-6 (CCR2216)</option>
                            <option value="sfp28-7">sfp28-7 (CCR2216)</option>
                            <option value="sfp28-8">sfp28-8 (CCR2216)</option>
                            <option value="sfp28-9">sfp28-9 (CCR2216)</option>
                            <option value="sfp28-10">sfp28-10 (CCR2216)</option>
                            <option value="sfp28-11">sfp28-11 (CCR2216)</option>
                            <option value="sfp28-12">sfp28-12 (CCR2216)</option>
                            <option value="sfp28-13">sfp28-13 (CCR2216)</option>
                            <option value="sfp28-14">sfp28-14 (CCR2216)</option>
                            <option value="sfp28-15">sfp28-15 (CCR2216)</option>
                            <option value="sfp28-16">sfp28-16 (CCR2216)</option>
                            <!-- CCR1072 Interfaces -->
                            <option value="ether1">ether1 (CCR1072)</option>
                            <option value="ether2">ether2 (CCR1072)</option>
                            <option value="ether3">ether3 (CCR1072)</option>
                            <option value="ether4">ether4 (CCR1072)</option>
                            <option value="ether5">ether5 (CCR1072)</option>
                            <option value="ether6">ether6 (CCR1072)</option>
                            <option value="ether7">ether7 (CCR1072)</option>
                            <option value="ether8">ether8 (CCR1072)</option>
                            <option value="ether9">ether9 (CCR1072)</option>
                            <option value="ether10">ether10 (CCR1072)</option>
                            <option value="ether11">ether11 (CCR1072)</option>
                            <option value="ether12">ether12 (CCR1072)</option>
                            <option value="sfp1">sfp1 (CCR1072)</option>
                            <option value="sfp2">sfp2 (CCR1072)</option>
                            <option value="sfp3">sfp3 (CCR1072)</option>
                            <option value="sfp4">sfp4 (CCR1072)</option>
                        </select>
                    </div>
                    <div>
                        <label>Uplink IP/Net:</label>
                        <input type="text" class="ent_mpls_uplinkIP" placeholder="10.24.251.84/29">
                    </div>
                </div>
                <div style="margin-top: 10px;">
                    <label>Uplink Comment/Location:</label>
                    <input type="text" class="ent_mpls_uplinkComment" placeholder="UPLINK-LOCATION-1">
                </div>
                <button type="button" onclick="this.parentElement.remove()" style="background: #f44336; color: white; border: none; padding: 8px 12px; border-radius: 3px; cursor: pointer; margin-top: 10px;">Remove Uplink</button>
            `;
            container.appendChild(newUplink);
        }

        // ===== NEW TABS JAVASCRIPT FUNCTIONS =====

        // IP helpers for new tabs
        function ipToInt(ip) {
            const p = ip.split('.');
            return (((((+p[0])<<24)>>>0) + ((+p[1])<<16) + ((+p[2])<<8) + (+p[3]))>>>0);
        }

        function intToIp(int) {
            return [(int>>>24)&255,(int>>>16)&255,(int>>>8)&255,int&255].join('.');
        }

        function maskFromPrefix(prefix) {
            return prefix===0?0:(~0 << (32-prefix))>>>0;
        }

        function parseCidr(cidr) {
            const s = String(cidr||'');
            const ix = s.indexOf('/');
            if (ix < 0) throw new Error('Invalid CIDR: ' + s);
            const ip = s.substring(0, ix);
            const prefix = parseInt(s.substring(ix+1), 10);
            if (isNaN(prefix) || prefix < 0 || prefix > 32) throw new Error('Invalid prefix: ' + s);
            const o = ip.split('.').map(function(n){return parseInt(n,10);});
            if(o.length!==4||o.some(function(n){return isNaN(n)||n<0||n>255;})) throw new Error('Invalid IP ' + ip);
            return {ip: ip, prefix: prefix, mask: maskFromPrefix(prefix)};
        }

        function derivePoolAfterGateway(c, gatewayInt, offset) {
            const start = gatewayInt+1+Math.max(0,offset|0);
            if(start<c.firstHost) start = c.firstHost;
            if(start>c.lastHost) return null;
            return {start: intToIp(start), end: intToIp(c.lastHost)};
        }

        function setWarning(containerId, type, text) {
            const box = document.getElementById(containerId);
            if(!box) return;
            box.innerHTML = '<div class="warning" style="color: red; font-weight: bold;">' + text + '</div>';
        }

        function setFacts(containerId, c, gwInt) {
            const box = document.getElementById(containerId);
            if(!box) return;
            const html = [];
            function add(k,v) {
                if(v!==null&&v!==undefined) html.push('<div><strong>' + k + ':</strong> ' + v + '</div>');
            }
            add('Network', c.ip + '/' + c.prefix);
            add('Gateway', intToIp(gwInt));
            add('First Host', intToIp(c.firstHost));
            add('Last Host', intToIp(c.lastHost));
            add('Broadcast', intToIp(c.broadcast));
            add('Usable IPs', c.lastHost - c.firstHost + 1);
            box.innerHTML = html.join('');
        }

        // Tarana Sector Generator
        function genTarana() {
            try {
                const alpha = (document.getElementById('tarana_alphaPort')||document.getElementById('tower_tarana_alpha'))?.value || '';
                const beta  = (document.getElementById('tarana_betaPort')||document.getElementById('tower_tarana_beta'))?.value || '';
                const gamma = (document.getElementById('tarana_gammaPort')||document.getElementById('tower_tarana_gamma'))?.value || '';
                const delta = (document.getElementById('tarana_deltaPort')||document.getElementById('tower_tarana_delta'))?.value || '';
                const unicornCidr = (document.getElementById('tarana_unicornmgmt_subnet')||document.getElementById('tower_unicornmgmt_subnet'))?.value?.trim() || '';
                const deviceSel = (document.getElementById('tarana_device')||document.getElementById('upgradeTargetDevice'));
                const device = deviceSel ? deviceSel.value.toLowerCase() : 'ccr2004';

                // Restrict to CCR2004/CCR2216 when selector exists
                if (deviceSel && !(device === 'ccr2004' || device === 'ccr2216')) {
                    alert('Tarana sectors are only supported on CCR2004 and CCR2216.');
                    return;
                }
                
                if (!alpha || !beta || !gamma) {
                    alert('Select ALPHA, BETA and GAMMA ports (DELTA optional).');
                    return;
                }
                
                const sectorPorts = [alpha, beta, gamma].concat(delta ? [delta] : []);
                let config = '';

                // Ethernet speed/comments (force 10GBASE)
                const comments = ['ALPHA','BETA','GAMMA','DELTA'];
                config += `/interface ethernet\n`;
                sectorPorts.forEach((p, i) => {
                    config += `set [ find default-name=${p} ] auto-negotiation=no comment=${comments[i]||'SECTOR'} speed=10G-baseCR\n`;
                });
                config += `\n`;

                // VLANs for each sector port
                    config += `/interface vlan\n`;
                sectorPorts.forEach(p => {
                    config += `add interface=${p} name=vlan1000-${p} vlan-id=1000\n`;
                    config += `add interface=${p} name=vlan2000-${p} vlan-id=2000\n`;
                    config += `add interface=${p} name=vlan3000-${p} vlan-id=3000\n`;
                });
                config += `\n`;

                // Bridge port assignments
                config += `/interface bridge port\n`;
                sectorPorts.forEach(p => {
                    config += `add bridge=lan-bridge interface=vlan1000-${p}\n`;
                    config += `add bridge=bridge2000 interface=vlan2000-${p}\n`;
                    config += `add bridge=bridge3000 interface=vlan3000-${p}\n`;
                });
                config += `\n`;

                // UNICORNMGMT IP/OSPF on bridge3000
                if (unicornCidr) {
                    let network = '';
                    let firstUsable = '';
                    try {
                        const parsed = parseCidr(unicornCidr);
                        const netInt = ipToInt(parsed.ip) & parsed.mask;
                        network = intToIp(netInt) + '/' + parsed.prefix;
                        firstUsable = intToIp(netInt + 1) + '/' + parsed.prefix;
                    } catch (_) {
                        network = unicornCidr;
                        firstUsable = unicornCidr;
                    }
                    config += `/ip address\n`;
                    config += `add address=${firstUsable} interface=bridge3000 comment=UNICORN network=${network}\n\n`;
                    config += `/routing ospf interface-template\n`;
                    config += `add area=backbone-v2 comment=UNICORN cost=10 disabled=no interfaces=bridge3000 networks=${network} priority=1\n\n`;
                }

                const out = document.getElementById('tarana_output');
                if (out) out.textContent = config; else alert('Generated Tarana config:\n\n' + config);
            } catch (error) {
                alert('Error generating configuration: ' + error.message);
            }
        }

        // Enterprise Feeding Generator
        function genEntFeeding() {
            try {
                const device = document.getElementById('ent_feeding_device').value;
                const routerOS = document.getElementById('ent_feeding_routeros').value;
                const label = document.getElementById('ent_feeding_label').value.trim() || 'Customer';
                const port = document.getElementById('ent_feeding_port').value.trim();
                const loop = document.getElementById('ent_feeding_loop').value.trim();
                const uplink = document.getElementById('ent_feeding_uplink').value.trim();
                const backhaul = document.getElementById('ent_feeding_backhaul').value.trim();
                const publicIP = document.getElementById('ent_feeding_public').value.trim();
                
                if (!device || !routerOS || !port) {
                    alert('Please select device, RouterOS version, and port!');
                    return;
                }
                
                const deviceConfig = DEVICE_CONFIGS[device];
                const versionType = getRouterOSVersionType(routerOS);
                const speedSyntax = getSpeedSyntax(routerOS, port);
                
                let config = `# Enterprise Feeding Configuration
# Generated on ${new Date().toISOString()}
# Device: ${deviceConfig.name}
# RouterOS: ${routerOS} (${versionType} syntax)
# Customer: ${label}

`;

                // Interface configuration with proper speed syntax
                config += `/interface ethernet
set [find name="${port}"] auto-negotiation=no comment="${label}" speed=${speedSyntax}

`;

                // IP addresses if provided
                if (loop) {
                    config += `/ip address
add address=${loop} interface=loop0 comment="${label} Loopback"

`;
                }

                if (uplink) {
                    config += `add address=${uplink} interface=${port} comment="${label} Uplink"

`;
                }

                if (backhaul) {
                    config += `add address=${backhaul} interface=${port} comment="${label} Backhaul"

`;
                }

                if (publicIP) {
                    config += `add address=${publicIP} interface=${port} comment="${label} Public"

`;
                }

                config += `# Configuration complete for ${label}
# Device: ${deviceConfig.name}
# Port: ${port}
# RouterOS: ${routerOS}
# Speed Syntax: ${versionType}
`;

                const out = document.getElementById('ent_feeding_output');
                if (out) out.value = config; else console.log(config);
            } catch (error) {
                alert('Error generating configuration: ' + error.message);
            }
        }

        // Copy functions for new tabs
        function copyCCR() {
            try {
                const config = document.getElementById('ccr_output').textContent;
                if (!config) {
                    alert('No configuration to copy!');
                    return;
                }
                navigator.clipboard.writeText(config).then(() => alert('‚úÖ Configuration copied to clipboard!')).catch(err => alert('Failed to copy: ' + err));
            } catch (error) {
                alert('Error copying configuration: ' + error.message);
            }
        }

        function copyTarana() {
            try {
                navigator.clipboard.writeText(document.getElementById('tarana_output').value);
                alert('‚úÖ Configuration copied to clipboard!');
            } catch (error) {
                alert('Error copying configuration: ' + error.message);
            }
        }

        function copyEntFeeding() {
            try {
                navigator.clipboard.writeText(document.getElementById('ent_feeding_output').value);
                alert('‚úÖ Configuration copied to clipboard!');
            } catch (error) {
                alert('Error copying configuration: ' + error.message);
            }
        }

        // Small helper to produce the Tarana block used in Tower generator
        function generateTowerTaranaBlock(opts, deviceConfig) {
            const alpha = opts.alpha || '';
            const beta = opts.beta || '';
            const gamma = opts.gamma || '';
            const delta = opts.delta || '';
            const unicornSubnet = opts.unicornSubnet || '';

            let out = '';

            // Bridges (UNICORNMGMT maps to bridge3000)
            out += `/interface bridge\n`;
            out += `add comment=STATIC name=bridge2000\n`;

            // Ethernet sets (force 10G-baseCR)
            function emitEthSet(port, comment, speedInputId, mtuInputId) {
                if (!port) return '';
                const speedVal = '10G-baseCR';
                const mtuVal = '';
                const autoNeg = ' auto-negotiation=no';
                const speedPart = ` speed=${speedVal}`;
                return `/interface ethernet\nset [ find default-name=${port} ]${autoNeg} comment=${comment}${speedPart}${mtuVal}\n`;
            }

            if (alpha) out += emitEthSet(alpha, 'ALPHA', 'tower_tarana_alpha_speed', 'tower_tarana_alpha_mtu');
            if (beta) out += emitEthSet(beta, 'BETA', 'tower_tarana_beta_speed', 'tower_tarana_beta_mtu');
            if (gamma) out += emitEthSet(gamma, 'GAMMA', 'tower_tarana_gamma_speed', 'tower_tarana_gamma_mtu');
            if (delta) out += emitEthSet(delta, 'DELTA', 'tower_tarana_delta_speed', 'tower_tarana_delta_mtu');

            // VLANs on each sector port
            const sectorPorts = [alpha, beta, gamma].concat(delta ? [delta] : []);
            if (sectorPorts.length) {
                out += `/interface vlan\n`;
                sectorPorts.forEach(p => {
                    out += `add interface=${p} name=vlan1000-${p} vlan-id=1000\n`;
                    out += `add interface=${p} name=vlan2000-${p} vlan-id=2000\n`;
                    out += `add interface=${p} name=vlan3000-${p} vlan-id=3000\n`;
                });
            }

            // Bridge port assignments
            out += `/interface bridge port\n`;
            sectorPorts.forEach(p => {
                out += `add bridge=lan-bridge interface=vlan1000-${p}\n`;
                out += `add bridge=bridge2000 interface=vlan2000-${p}\n`;
                out += `add bridge=bridge3000 interface=vlan3000-${p}\n`;
            });

            // UNICORN management
            if (unicornSubnet) {
                let network = unicornSubnet;
                try {
                    if (typeof calculateNetworkAddress === 'function') {
                        network = calculateNetworkAddress(unicornSubnet);
                    } else if (typeof calculateNetwork === 'function') {
                        const base = calculateNetwork(unicornSubnet);
                        network = base + '/' + (unicornSubnet.split('/')[1] || '32');
                    }
                } catch (e) {}

                let firstUsable = unicornSubnet;
                try {
                    const parsed = parseCidr(unicornSubnet);
                    const netInt = ipToInt(parsed.ip) & parsed.mask;
                    const usableInt = netInt + 1;
                    firstUsable = intToIp(usableInt) + '/' + parsed.prefix;
                } catch (e) {}

                out += `/ip address\n`;
                out += `add address=${firstUsable} interface=bridge3000 comment=UNICORN network=${calculateNetwork(unicornSubnet)}\n`;
                out += `/routing ospf interface-template\n`;
                out += `add area=backbone-v2 disabled=no interfaces=bridge3000 networks=${calculateNetwork(unicornSubnet)} priority=1\n`;
            }

            return out;
        }

        // ========================================
        // ========================================
        // MODE SWITCHING & FILE HANDLING
        // ========================================
        
        const AI_API_BASE = 'http://localhost:5000/api';
        let uploadedConfigContent = '';
        
        // Switch between NEW and UPGRADE modes
        function switchMode(mode) {
            const mainForm = document.getElementById('mainForm');
            const upgradeMode = document.getElementById('upgradeMode');
            const newModeHint = document.getElementById('newModeHint');
            const generateBtn = document.getElementById('generateBtn');
            
            if (mode === 'new') {
                mainForm.style.display = 'block';
                upgradeMode.style.display = 'none';
                newModeHint.style.display = 'block';
                if (generateBtn) generateBtn.textContent = 'Generate Configuration';
            } else {
                mainForm.style.display = 'none';
                upgradeMode.style.display = 'block';
                newModeHint.style.display = 'none';
                uploadedConfigContent = '';
                document.getElementById('uploadedFileName').style.display = 'none';
                document.getElementById('upgradeTargetSelection').style.display = 'none';
                if (generateBtn) generateBtn.textContent = 'Upgrade Configuration';
            }
        }
        
        // Drag & Drop File Handling
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        
        if (dropZone) {
            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            // Highlight drop zone when item is dragged over it
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.style.borderColor = '#FF9800';
                    dropZone.style.background = '#fff3e0';
                }, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.style.borderColor = '#ccc';
                    dropZone.style.background = 'white';
                }, false);
            });
            
            // Handle dropped files
            dropZone.addEventListener('drop', handleDrop, false);
            dropZone.addEventListener('click', () => fileInput.click());
        }
        
        if (fileInput) {
            fileInput.addEventListener('change', handleFileSelect, false);
        }
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }
        
        function handleFileSelect(e) {
            const files = e.target.files;
            handleFiles(files);
        }
        
        function handleFiles(files) {
            if (files.length === 0) return;
            
            const file = files[0];
            const fileName = file.name;
            
            // Check file extension
            if (!fileName.endsWith('.rsc') && !fileName.endsWith('.txt')) {
                showUpgradeStatus('Invalid file type. Please upload .rsc or .txt file.', 'error');
                return;
            }
            
            // Read file content
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedConfigContent = e.target.result;
                
                // Show file name
                document.getElementById('fileName').textContent = fileName;
                document.getElementById('uploadedFileName').style.display = 'block';
                
                // Show target selection
                document.getElementById('upgradeTargetSelection').style.display = 'block';
                
                // Show ready message
                showUpgradeStatus('‚úÖ Config loaded. Select target device/version and click "Start Upgrade" button.', 'success');
            };
            reader.readAsText(file);
        }
        
        // Perform upgrade using AI backend
        async function performUpgrade() {
            if (!uploadedConfigContent) {
                showUpgradeStatus('No config file loaded.', 'error');
                return;
            }
            
            // Disable button during processing
            const upgradeBtn = document.getElementById('upgradeBtn');
            upgradeBtn.disabled = true;
            upgradeBtn.style.opacity = '0.6';
            upgradeBtn.style.cursor = 'not-allowed';
            upgradeBtn.innerHTML = '‚è≥ Upgrading...';
            
            showUpgradeStatus('Detecting source version and translating...', 'info');
            
            try {
                // Detect source version - multiple patterns
                let sourceVersion = 'unknown';
                const patterns = [
                    /by RouterOS\s+([\d.]+)/,
                    /RouterOS\s+([\d.]+)/,
                    /version\s+([\d.]+)/,
                    /ros7/i,
                    /interface-template/,
                    /default-v2/
                ];
                
                for (const pattern of patterns) {
                    const match = uploadedConfigContent.match(pattern);
                    if (match) {
                        if (pattern.source.includes('ros7') || pattern.source.includes('interface-template') || pattern.source.includes('default-v2')) {
                            sourceVersion = '7.x';
                        } else {
                            sourceVersion = match[1] || '7.x';
                        }
                        break;
                    }
                }
                
                // Get target selections
                const targetDevice = document.getElementById('upgradeTargetDevice').value;
                const targetVersion = document.getElementById('upgradeTargetVersion').value;
                
                showUpgradeStatus(`Upgrading from RouterOS ${sourceVersion} to ${targetVersion} (${targetDevice})... This may take 1-3 minutes for large configs.`, 'info');
                
                // Check backend
                const backendRunning = await checkAIBackend();
                if (!backendRunning) {
                    showUpgradeStatus('‚ùå Backend offline. Double-click: start_ollama_server.bat', 'error');
                    
                    // Re-enable button
                    upgradeBtn.disabled = false;
                    upgradeBtn.style.opacity = '1';
                    upgradeBtn.style.cursor = 'pointer';
                    upgradeBtn.innerHTML = 'üöÄ Start Upgrade';
                    upgradeBtn.style.background = '#FF9800';
                    return;
                }
                
                // Create timeout controller for large configs (15 minutes max)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 900000); // 15 minutes
                
                try {
                    // Call backend
                    const response = await fetch(`${AI_API_BASE}/translate-config`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            source_config: uploadedConfigContent,
                            target_device: targetDevice,
                            target_version: targetVersion
                        }),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Backend returned error');
                }
                const data = await response.json();
                
                if (data.success) {
                    // Check validation FIRST - missing IPs = FAILURE
                    const validation = data.validation || {};
                    const missingIPs = validation.missing_ips || [];
                    
                    if (missingIPs.length > 10) {
                        // Too many missing IPs = translation failed catastrophically
                        throw new Error(`CRITICAL FAILURE: ${missingIPs.length} IP addresses lost in translation. AI failed to preserve network config. This is unusable.`);
                    } else if (missingIPs.length > 0) {
                        // Some missing IPs = partial failure
                        showUpgradeStatus(`‚ö†Ô∏è WARNING: ${missingIPs.length} IPs missing. Review carefully before deploying!`, 'warning');
                    } else {
                        // Perfect translation
                        showUpgradeStatus(`‚úÖ Translation successful! All IPs preserved.`, 'success');
                    }
                    
                    // Display upgraded config in NEW dedicated section
                    document.getElementById('upgradeOutput').value = data.translated_config;
                    document.getElementById('upgradeOutputSection').style.display = 'block';
                    
                    // Also put in main output for compatibility
                    document.getElementById('output').value = data.translated_config;
                    
                    // Bind copy/download buttons (once)
                    const copyBtn = document.getElementById('upgradeCopyBtn');
                    const dlBtn = document.getElementById('upgradeDownloadBtn');
                    // Safe bindings: fall back to inline implementations if globals are not yet defined
                    if (copyBtn && !copyBtn.dataset.bound) {
                        const copyHandler = (window.copyUpgradeOutput) ? window.copyUpgradeOutput : function () {
                            const ta = document.getElementById('upgradeOutput');
                            const text = ta ? ta.value : '';
                            if (!text) { alert('No configuration to copy!'); return; }
                            if (navigator.clipboard && window.isSecureContext) {
                                navigator.clipboard.writeText(text).then(() => alert('‚úÖ Configuration copied to clipboard')).catch(() => {
                                    ta.select(); document.execCommand('copy'); alert('Copied to clipboard.');
                                });
                            } else {
                                ta.select(); document.execCommand('copy'); alert('Copied to clipboard.');
                            }
                        };
                        copyBtn.addEventListener('click', copyHandler);
                        copyBtn.dataset.bound = '1';
                    }
                    if (dlBtn && !dlBtn.dataset.bound) {
                        const dlHandler = (window.downloadUpgradeOutput) ? window.downloadUpgradeOutput : function () {
                            const ta = document.getElementById('upgradeOutput');
                            const config = ta ? ta.value : '';
                            if (!config) { alert('No configuration to download!'); return; }
                            const targetDevice = (document.getElementById('upgradeTargetDevice')||{}).value || 'device';
                            const targetVersion = (document.getElementById('upgradeTargetVersion')||{}).value || '7.x';
                            const ts = new Date().toISOString().split('T')[0];
                            const blob = new Blob([config.replace(/\r?\n/g, '\n')], { type: 'text/plain;charset=utf-8' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `upgraded-${targetDevice}-v${targetVersion}-${ts}.rsc`;
                            document.body.appendChild(a);
                            a.click();
                            setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 0);
                        };
                        dlBtn.addEventListener('click', dlHandler);
                        dlBtn.dataset.bound = '1';
                    }

                    // Re-enable button
                    upgradeBtn.disabled = false;
                    upgradeBtn.style.opacity = '1';
                    upgradeBtn.style.cursor = 'pointer';
                    upgradeBtn.innerHTML = '‚úì Upgrade Complete - Run Again?';
                    upgradeBtn.style.background = '#4CAF50';
                    
                    // Scroll to output
                    document.getElementById('upgradeOutputSection').scrollIntoView({ behavior: 'smooth' });
                } else {
                    throw new Error(data.error || 'Translation failed');
                }
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    if (fetchError.name === 'AbortError') {
                        throw new Error('Request took too long (>5 minutes). Config may be too large or system is slow.');
                    }
                    throw fetchError;
                }
                
            } catch (error) {
                showUpgradeStatus(`‚ùå Upgrade failed: ${error.message}. Check that backend is running with enough resources.`, 'error');
                
                // Re-enable button (error)
                upgradeBtn.disabled = false;
                upgradeBtn.style.opacity = '1';
                upgradeBtn.style.cursor = 'pointer';
                upgradeBtn.innerHTML = 'üöÄ Start Upgrade';
                upgradeBtn.style.background = '#FF9800';
            }
        }
        
        function showUpgradeStatus(message, type) {
            const statusDiv = document.getElementById('upgradeStatus');
            statusDiv.style.display = 'block';
            statusDiv.textContent = message;
            
            const colors = {
                success: '#d4edda',
                error: '#f8d7da',
                warning: '#fff3cd',
                info: '#d1ecf1'
            };
            
            const textColors = {
                success: '#155724',
                error: '#721c24',
                warning: '#856404',
                info: '#0c5460'
            };
            
            statusDiv.style.background = colors[type] || colors.info;
            statusDiv.style.color = textColors[type] || textColors.info;
            statusDiv.style.border = `1px solid ${textColors[type]}`;
        }
        
        
        // Check if AI backend is running
        async function checkAIBackend() {
            try {
                const response = await fetch(`${AI_API_BASE}/health`, { timeout: 5000 });
                const data = await response.json();
                
                // Check based on provider type
                if (data.ai_provider === 'ollama') {
                    return data.status === 'online' && data.ollama_available === true;
                } else {
                    return data.status === 'online' && data.api_key_configured === true;
                }
            } catch (error) {
                console.warn('AI Backend not running:', error.message);
                return false;
            }
        }
        
        // Simple backend API wrapper (no key handling in browser)
        async function callAI(endpoint, body) {
            const response = await fetch(`${AI_API_BASE}/${endpoint}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'AI Backend error');
            }
            
            // Copy translated config from Upgrade section with file://-safe fallback
            function copyUpgradeOutput() {
                const ta = document.getElementById('upgradeOutput');
                const text = ta ? ta.value : '';
                if (!text) { alert('No configuration to copy!'); return; }
                // Try modern clipboard first
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(text).then(() => {
                        alert('‚úÖ Configuration copied to clipboard');
                    }).catch(() => {
                        // Fallback below
                        legacyCopy(text);
                    });
                } else {
                    legacyCopy(text);
                }
            }

            // --- Enterprise tab mode toggle (AI vs Advanced manual) ---
            (function initEnterpriseModeToggle(){
                const adv = document.getElementById('ent_advanced_toggle');
                const hideable = [
                    document.getElementById('ent_manual_interfaces'),
                    document.getElementById('ent_manual_uplinks'),
                    document.getElementById('ent_manual_optional'),
                    document.getElementById('ent_row_public_pool'),
                    document.getElementById('ent_row_private_pair'),
                    document.getElementById('ent_row_gateway')
                ];
                const groups = hideable;
                const simpleBh = document.getElementById('ent_bh_cidr_simple');

                function setMode(manual){
                    // Show/hide big manual sections
                    groups.forEach(el=>{ if(!el) return; el.style.display = manual ? '' : 'none'; });
                    // Simple BH row toggled inverse
                    const bhRow = document.getElementById('ent_bh_simple_row');
                    if (bhRow) bhRow.style.display = manual ? 'none' : '';
                }

                if (adv) {
                    adv.addEventListener('change', function(){ setMode(adv.checked); });
                }
                // Default: AI mode (manual=false)
                setMode(false);

                // Keep simple BH in sync with first uplink field when switching
                window.entSyncBhCidr = function(){
                    const ta = document.querySelector('#ent_uplinksContainer .ent_uplinkIP');
                    if (!ta || !simpleBh) return;
                    if (simpleBh.value && ta.value !== simpleBh.value) ta.value = simpleBh.value;
                }
            })();

            function legacyCopy(text) {
                const hidden = document.createElement('textarea');
                hidden.value = text;
                hidden.setAttribute('readonly', '');
                hidden.style.position = 'absolute';
                hidden.style.left = '-9999px';
                document.body.appendChild(hidden);
                hidden.select();
                try {
                    document.execCommand('copy');
                    alert('‚úÖ Configuration copied to clipboard');
                } catch (e) {
                    alert('Failed to copy. You can manually select and copy the text.');
                }
                document.body.removeChild(hidden);
            }

            // Download translated config from Upgrade section
            function downloadUpgradeOutput() {
                const ta = document.getElementById('upgradeOutput');
                const text = ta ? ta.value : '';
                if (!text) { alert('No configuration to download!'); return; }
                const targetDevice = (document.getElementById('upgradeTargetDevice') || {}).value || 'ccr2004';
                const targetVersion = (document.getElementById('upgradeTargetVersion') || {}).value || '7.x';
                const ts = new Date().toISOString().split('T')[0];
                const blob = new Blob([text.replace(/\r?\n/g, '\n')], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `upgraded-${targetDevice}-v${targetVersion}-${ts}.rsc`;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 0);
            }

            return await response.json();
        }
        
        // AI Config Validation (can be called from any tab)
        async function validateConfigWithAI(config, configType = 'tower') {
            const keyInput = document.getElementById('llm_api_key');
            const key = keyInput.value.trim();
            
            if (!key) {
                updateApiKeyStatus('‚ùå Please enter an API key', 'error');
                return;
            }
            
            if (!key.startsWith('sk-')) {
                updateApiKeyStatus('‚ö†Ô∏è Warning: API key should start with "sk-"', 'warning');
            }
            
            // Store in localStorage ONLY (client-side)
            localStorage.setItem('openai_api_key', key);
            updateApiKeyStatus('‚úÖ API Key saved securely (local storage only)', 'success');
        }

        function clearApiKey() {
            localStorage.removeItem('openai_api_key');
            document.getElementById('llm_api_key').value = '';
            updateApiKeyStatus('üóëÔ∏è API Key cleared', 'info');
        }

        function toggleApiKeyVisibility() {
            const input = document.getElementById('llm_api_key');
            const btn = document.getElementById('toggleApiKeyBtn');
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'üôà Hide';
            } else {
                input.type = 'password';
                btn.textContent = 'üëÅÔ∏è Show';
            }
        }

        function updateApiKeyStatus(message, type) {
            const status = document.getElementById('apiKeyStatus');
            const colors = {
                success: '#4CAF50',
                error: '#f44336',
                warning: '#ff9800',
                info: '#2196F3'
            };
            status.textContent = message;
            status.style.color = colors[type] || '#666';
            status.style.fontWeight = 'bold';
        }
        // Call OpenAI API (Secure - No Hardcoded Keys)
        async function callOpenAI(messages, options = {}) {
            const apiKey = localStorage.getItem('openai_api_key');
            
            if (!apiKey) {
                throw new Error('API key not found. Please save your OpenAI API key first.');
            }

            const endpoint = 'https://api.openai.com/v1/chat/completions';
            
            const requestBody = {
                model: options.model || 'gpt-4o', // Using GPT-4o for best quality
                messages: messages,
                temperature: options.temperature || 0.1, // Low temp for deterministic output
                max_tokens: options.maxTokens || 4000
            };

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}` // API key from localStorage
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`OpenAI API Error: ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                console.error('OpenAI API call failed:', error);
                throw error;
            }
        }

        // Parse RouterOS Config
        function parseRouterOSConfig(configText) {
            const sections = {
                system: [],
                interfaces: [],
                ip: [],
                routing: [],
                mpls: [],
                security: [],
                other: []
            };

            const lines = configText.split('\n');
            let currentSection = 'other';
            let currentBlock = [];

            lines.forEach(line => {
                const trimmed = line.trim();
                
                // Detect section headers
                if (trimmed.startsWith('/system')) currentSection = 'system';
                else if (trimmed.startsWith('/interface')) currentSection = 'interfaces';
                else if (trimmed.startsWith('/ip')) currentSection = 'ip';
                else if (trimmed.startsWith('/routing')) currentSection = 'routing';
                else if (trimmed.startsWith('/mpls')) currentSection = 'mpls';
                else if (trimmed.startsWith('/snmp') || trimmed.startsWith('/user')) currentSection = 'security';
                
                // Add line to current section
                if (trimmed.startsWith('/') && currentBlock.length > 0) {
                    sections[currentSection].push(currentBlock.join('\n'));
                    currentBlock = [];
                }
                
                if (trimmed) {
                    currentBlock.push(line);
                }
            });

            if (currentBlock.length > 0) {
                sections[currentSection].push(currentBlock.join('\n'));
            }

            // Extract critical data that MUST be preserved
            const preserveData = {
                ips: extractIPs(configText),
                vlans: extractVLANs(configText),
                firewallRules: countFirewallRules(configText)
            };

            return { sections, preserveData, rawConfig: configText };
        }

        // Extract IPs from config
        function extractIPs(configText) {
            const ipRegex = /\b(?:\d{1,3}\.){3}\d{1,3}(?:\/\d{1,2})?\b/g;
            const matches = configText.match(ipRegex) || [];
            return [...new Set(matches)]; // Unique IPs
        }

        // Extract VLANs from config
        function extractVLANs(configText) {
            const vlanRegex = /vlan-id=(\d+)|vlan(\d+)|VLAN[\s_]?(\d+)/gi;
            const matches = [];
            let match;
            while ((match = vlanRegex.exec(configText)) !== null) {
                matches.push(match[1] || match[2] || match[3]);
            }
            return [...new Set(matches)];
        }

        // Count firewall rules
        function countFirewallRules(configText) {
            const firewallLines = configText.split('\n').filter(line => 
                line.includes('/ip firewall') || line.includes('add action=')
            );
            return firewallLines.length;
        }

        // Detect RouterOS version from config
        function detectRouterOSVersion(configText) {
            const versionMatch = configText.match(/by RouterOS\s+([\d.]+)/);
            return versionMatch ? versionMatch[1] : null;
        }

        // Build LLM Translation Prompt
        function buildTranslationPrompt(configSection, context) {
            const systemPrompt = `You are an expert RouterOS configuration translator. Your task is to translate MikroTik RouterOS configurations from one firmware version to another while strictly preserving all critical data.

CRITICAL RULES:
1. PRESERVE ALL IP addresses, subnets, and CIDR notations EXACTLY as provided
2. PRESERVE ALL firewall rules, NAT rules, and security settings
3. PRESERVE ALL VLANs, bridges, and interface names
4. TRANSLATE ONLY syntax changes (speed formats, routing protocol commands)
5. Follow RFC standards: OSPF (RFC 2328), BGP (RFC 4271), MPLS (RFC 3031), IPv4 (RFC 791)
6. Flag any features unsupported in target firmware
7. Output ONLY valid RouterOS commands (no explanations)
8. Maintain command order and structure
9. Preserve comments when present`;

            const userPrompt = `TRANSLATION REQUEST:
Source: RouterOS ${context.sourceVersion || 'Unknown'}
Target: RouterOS ${context.targetVersion} on ${context.targetDevice}

TARGET DEVICE PORTS AVAILABLE: ${context.targetPorts.join(', ')}

CRITICAL DATA TO PRESERVE (DO NOT MODIFY):
- IP Addresses: ${context.preserveData.ips.slice(0, 10).join(', ')}${context.preserveData.ips.length > 10 ? '...' : ''}
- VLANs: ${context.preserveData.vlans.join(', ') || 'None detected'}
- Firewall Rules Count: ${context.preserveData.firewallRules}

SYNTAX CHANGES FOR TARGET VERSION ${context.targetVersion}:
${getSyntaxChangeRules(context.targetVersion)}

SOURCE CONFIGURATION TO TRANSLATE:
\`\`\`
${configSection}
\`\`\`

Translate this configuration section to RouterOS ${context.targetVersion} syntax for ${context.targetDevice}. Output ONLY the translated RouterOS commands.`;

            return { systemPrompt, userPrompt };
        }

        // Get syntax change rules
        function getSyntaxChangeRules(targetVersion) {
            if (targetVersion.startsWith('7.16') || targetVersion.startsWith('7.19')) {
                return `RouterOS 7.16+ uses NEW SYNTAX:
- Ethernet speed: Use "speed=1G-baseT-full" instead of "speed=1Gbps duplex=full"
  Examples: 10G-baseCR, 10G-baseSR-LR, 1G-baseT-full, 100M-baseT-full
- OSPF: Use "/routing ospf interface-template" instead of "/routing ospf interface"
  Use "interfaces=" and "area=" parameters
- BGP: Use "/routing bgp connection" instead of "/routing bgp peer"
  Use "/routing bgp template" for common settings
- SFP ports: Use "sfp-sfpplus#" format (e.g., sfp-sfpplus1, sfp-sfpplus2)`;
            } else if (targetVersion.startsWith('7.')) {
                return `RouterOS 7.x (Legacy Syntax):
- Ethernet speed: Use "speed=1Gbps duplex=full" format
- OSPF: Use "/routing ospf interface" (v6 syntax)
- BGP: Use "/routing bgp peer" (v6 syntax)`;
            }
            return 'RouterOS 6.x: Use legacy syntax for all commands';
        }

        // Validate Translated Config
        function validateTranslatedConfig(translatedConfig, context) {
            const issues = [];

            // 1. Verify all source IPs are preserved
            const sourceIPs = context.preserveData.ips;
            const translatedIPs = extractIPs(translatedConfig);
            const missingIPs = sourceIPs.filter(ip => !translatedIPs.includes(ip));
            
            if (missingIPs.length > 0) {
                issues.push({ 
                    severity: 'error', 
                    message: `Missing IP addresses: ${missingIPs.slice(0, 5).join(', ')}${missingIPs.length > 5 ? '...' : ''}` 
                });
            }

            // 2. Verify firewall rules count
            const translatedFirewallRules = countFirewallRules(translatedConfig);
            if (translatedFirewallRules < context.preserveData.firewallRules) {
                issues.push({ 
                    severity: 'warning', 
                    message: `Firewall rule count decreased: ${context.preserveData.firewallRules} ‚Üí ${translatedFirewallRules}` 
                });
            }

            // 3. Verify VLANs preserved
            const translatedVLANs = extractVLANs(translatedConfig);
            const missingVLANs = context.preserveData.vlans.filter(vlan => !translatedVLANs.includes(vlan));
            if (missingVLANs.length > 0) {
                issues.push({ 
                    severity: 'warning', 
                    message: `Missing VLANs: ${missingVLANs.join(', ')}` 
                });
            }

            // 4. Check for invalid ports on target device
            const usedPorts = extractUsedPorts(translatedConfig);
            const invalidPorts = usedPorts.filter(port => !context.targetPorts.includes(port));
            if (invalidPorts.length > 0) {
                issues.push({ 
                    severity: 'error', 
                    message: `Invalid ports for ${context.targetDevice}: ${invalidPorts.join(', ')}. Available: ${context.targetPorts.slice(0, 5).join(', ')}...` 
                });
            }

            // 5. RFC 1918 validation (private IP ranges)
            const publicIPs = sourceIPs.filter(ip => !isPrivateIP(ip));
            if (publicIPs.length > 0 && context.validateRFC) {
                issues.push({ 
                    severity: 'info', 
                    message: `Public IPs detected (RFC 791): ${publicIPs.slice(0, 3).join(', ')}${publicIPs.length > 3 ? '...' : ''}` 
                });
            }

            return { valid: issues.filter(i => i.severity === 'error').length === 0, issues };
        }

        // Extract used ports from config
        function extractUsedPorts(configText) {
            const portRegex = /interface[=\s]+([\w\-]+\d+)/g;
            const matches = [];
            let match;
            while ((match = portRegex.exec(configText)) !== null) {
                matches.push(match[1]);
            }
            return [...new Set(matches)];
        }

        // Check if IP is private (RFC 1918)
        function isPrivateIP(ip) {
            const ipOnly = ip.split('/')[0];
            const parts = ipOnly.split('.').map(Number);
            if (parts.length !== 4) return false;
            
            // 10.0.0.0/8
            if (parts[0] === 10) return true;
            // 172.16.0.0/12
            if (parts[0] === 172 && parts[1] >= 16 && parts[1] <= 31) return true;
            // 192.168.0.0/16
            if (parts[0] === 192 && parts[1] === 168) return true;
            
            return false;
        }

        // Generate Diff View
        function generateDiff(beforeConfig, afterConfig) {
            const beforeLines = beforeConfig.split('\n').map(l => l.trim()).filter(l => l && !l.startsWith('#'));
            const afterLines = afterConfig.split('\n').map(l => l.trim()).filter(l => l && !l.startsWith('#'));
            
            // Find syntax changes (simplified diff)
            const removed = beforeLines.filter(line => {
                // Look for lines that changed syntax
                if (line.includes('speed=') && line.includes('Gbps')) return true;
                if (line.includes('/routing ospf interface') && !line.includes('template')) return true;
                if (line.includes('/routing bgp peer')) return true;
                return false;
            });
            
            const added = afterLines.filter(line => {
                // Look for new syntax lines
                if (line.includes('speed=') && line.includes('baseT')) return true;
                if (line.includes('/routing ospf interface-template')) return true;
                if (line.includes('/routing bgp connection')) return true;
                return false;
            });
            
            document.getElementById('diff_before').value = removed.join('\n') || '(No major syntax removals)';
            document.getElementById('diff_after').value = added.join('\n') || '(No major syntax additions)';
            document.getElementById('diff_viewer').style.display = 'block';
        }

        // Update Progress Bar
        function updateProgress(percent, message) {
            const bar = document.getElementById('progress_bar');
            const text = document.getElementById('progress_text');
            bar.style.width = percent + '%';
            bar.textContent = percent + '%';
            text.textContent = message;
        }

        // Display Validation Issues
        function displayValidationIssues(issues) {
            const issuesList = document.getElementById('issues_list');
            issuesList.innerHTML = '';
            
            if (issues.length === 0) {
                issuesList.innerHTML = '<li style="color: #4CAF50;">‚úÖ No issues detected!</li>';
            } else {
                issues.forEach(issue => {
                    const li = document.createElement('li');
                    const icon = issue.severity === 'error' ? '‚ùå' : issue.severity === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
                    li.textContent = `${icon} [${issue.severity.toUpperCase()}] ${issue.message}`;
                    li.style.color = issue.severity === 'error' ? '#f44336' : issue.severity === 'warning' ? '#ff9800' : '#2196F3';
                    li.style.marginBottom = '8px';
                    issuesList.appendChild(li);
                });
            }
            
            document.getElementById('validation_issues').style.display = 'block';
        }

        // Main Translation Function
        async function translateConfig() {
            const sourceConfig = document.getElementById('source_config').value;
            const targetDevice = document.getElementById('target_device_llm').value;
            const targetRouterOS = document.getElementById('target_routeros_llm').value;
            const preserveComments = document.getElementById('translate_preserve_comments').checked;
            const validateRFC = document.getElementById('translate_validate_rfc').checked;

            // Validation
            if (!sourceConfig || !targetDevice || !targetRouterOS) {
                alert('‚ùå Please fill in all required fields:\n- Source configuration\n- Target device\n- Target RouterOS version');
                return;
            }

            if (!localStorage.getItem('openai_api_key')) {
                alert('‚ùå Please save your OpenAI API key first!');
                return;
            }

            // Reset UI
            document.getElementById('translation_progress').style.display = 'block';
            document.getElementById('validation_issues').style.display = 'none';
            document.getElementById('diff_viewer').style.display = 'none';
            document.getElementById('translation_output_section').style.display = 'none';

            try {
                updateProgress(5, 'Parsing source configuration...');
                
                // 1. Parse config
                const parsedConfig = parseRouterOSConfig(sourceConfig);
                const detectedVersion = detectRouterOSVersion(sourceConfig);
                
                updateProgress(15, `Detected RouterOS ${detectedVersion || 'Unknown'}. Preparing translation...`);

                // 2. Get device context
                const targetDeviceConfig = DEVICE_CONFIGS[targetDevice];
                const context = {
                    sourceConfig: sourceConfig,
                    sourceVersion: detectedVersion,
                    targetDevice: targetDeviceConfig.name,
                    targetVersion: targetRouterOS,
                    targetPorts: [...targetDeviceConfig.ports, ...targetDeviceConfig.sfpPorts],
                    preserveData: parsedConfig.preserveData,
                    validateRFC: validateRFC
                };

                updateProgress(25, 'Translating configuration via AI...');

                // 3. Build prompt and call LLM
                const prompt = buildTranslationPrompt(sourceConfig, context);
                
                const messages = [
                    { role: 'system', content: prompt.systemPrompt },
                    { role: 'user', content: prompt.userPrompt }
                ];

                updateProgress(35, 'Calling OpenAI API (this may take 30-60 seconds)...');
                
                const translatedConfig = await callOpenAI(messages, { 
                    model: 'gpt-4o',
                    maxTokens: 6000,
                    temperature: 0.1
                });

                updateProgress(75, 'Translation complete. Validating...');

                // 4. Validate
                const validation = validateTranslatedConfig(translatedConfig, context);
                displayValidationIssues(validation.issues);

                updateProgress(90, 'Generating diff view...');

                // 5. Generate diff
                generateDiff(sourceConfig, translatedConfig);

                updateProgress(100, '‚úÖ Translation complete!');

                // 6. Display results
                document.getElementById('translated_output').value = translatedConfig;
                document.getElementById('translation_output_section').style.display = 'block';

                // Auto-hide progress after 2 seconds
                setTimeout(() => {
                    document.getElementById('translation_progress').style.display = 'none';
                }, 2000);

            } catch (error) {
                updateProgress(0, '');
                document.getElementById('translation_progress').style.display = 'none';
                alert(`‚ùå Translation Error:\n\n${error.message}\n\nPlease check:\n1. API key is valid\n2. You have OpenAI API credits\n3. Source config is valid RouterOS format`);
                console.error('Translation error:', error);
            }
        }

        // Validate Only (No Translation)
        async function validateOnly() {
            const sourceConfig = document.getElementById('source_config').value;
            const targetDevice = document.getElementById('target_device_llm').value;
            
            if (!sourceConfig) {
                alert('‚ùå Please paste a source configuration first!');
                return;
            }

            const parsedConfig = parseRouterOSConfig(sourceConfig);
            const detectedVersion = detectRouterOSVersion(sourceConfig);

            alert(`‚úÖ Configuration Analysis:

Detected RouterOS: ${detectedVersion || 'Unknown'}
IP Addresses: ${parsedConfig.preserveData.ips.length}
VLANs: ${parsedConfig.preserveData.vlans.length}
Firewall Rules: ${parsedConfig.preserveData.firewallRules}
Sections Detected:
- System: ${parsedConfig.sections.system.length} blocks
- Interfaces: ${parsedConfig.sections.interfaces.length} blocks
- IP: ${parsedConfig.sections.ip.length} blocks
- Routing: ${parsedConfig.sections.routing.length} blocks
- MPLS: ${parsedConfig.sections.mpls.length} blocks
Ready for translation!`);
}

// Target Device Info Display
function updateTargetDeviceInfo() {
    const targetDevice = document.getElementById('target_device_llm').value;
    const infoDiv = document.getElementById('targetDeviceInfo');
    const detailsDiv = document.getElementById('targetDeviceDetails');

    if (!targetDevice) {
        infoDiv.style.display = 'none';
        return;
    }

    const deviceConfig = DEVICE_CONFIGS[targetDevice];
    detailsDiv.innerHTML = `
        <div style="margin-top: 8px;">
            <strong>${deviceConfig.name}</strong><br>
            Ethernet Ports: ${deviceConfig.ports.join(', ')}<br>
            SFP Ports: ${deviceConfig.sfpPorts.join(', ') || 'None'}<br>
            Features: ${deviceConfig.features.join(', ')}<br>
            RouterOS: ${deviceConfig.routerOS.join(', ')}
        </div>
    `;
    infoDiv.style.display = 'block';
}

// Copy/Download Functions
function copyTranslatedConfig() {
    const config = document.getElementById('translated_output').value;
    if (!config) {
        alert('‚ùå No configuration to copy!');
        return;
    }
    navigator.clipboard.writeText(config).then(() => {
        alert('‚úÖ Translated configuration copied to clipboard!');
    }).catch(err => {
        alert('‚ùå Failed to copy: ' + err);
    });
}

function downloadTranslatedConfig() {
    const config = document.getElementById('translated_output').value;
    if (!config) {
        alert('‚ùå No configuration to download!');
        return;
    }

    const targetDevice = document.getElementById('target_device_llm').value;
    const targetVersion = document.getElementById('target_routeros_llm').value;
    const filename = `translated_${targetDevice}_${targetVersion}_${Date.now()}.rsc`;

    const blob = new Blob([config], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
}

function resetTranslator() {
    document.getElementById('source_config').value = '';
    document.getElementById('translated_output').value = '';
    document.getElementById('translation_output_section').style.display = 'none';
    document.getElementById('validation_issues').style.display = 'none';
    document.getElementById('diff_viewer').style.display = 'none';
    document.getElementById('source_device_llm').value = '';
    document.getElementById('source_routeros_llm').value = '';
    document.getElementById('target_device_llm').value = '';
    document.getElementById('target_routeros_llm').value = '';
    updateTargetDeviceInfo();
}
</script>
</body>
</html>