# ILLINOIS OUT-OF-STATE MPLS CONFIG POLICY

## Purpose
Provides the RouterOS baseline for Illinois MPLS/VPLS aggregation routers. The policy generalizes the IL-HUMBOLDT example so configs generated by the LLM follow standard port roles, bonding, VPLS domains, MPLS/LDP behaviour, compliance, and optional BGP while remaining fully parameterized.

## Required Input Schema

| Key | Type | Required | Description | Example |
| --- | --- | --- | --- | --- |
| `device_name` | string | Yes | `/system identity set name=` (format `RTR-<MODEL>-<SITE>`). | `RTR-MT2004-AR1.IL-HUMBOLDT-NE-1` |
| `routeros_version` | string | Yes | Target RouterOS release (prefer 7.x). | `7.19.4` |
| `loopback.ip` | string | Yes | Loopback IPv4; treated as /32. | `10.247.13.232` |
| `syslog.ip` | string | Yes | Remote syslog collector. | `142.147.116.215` |
| `switch_uplinks` | array<object> | Yes | Ordered list `{ "port": "sfp-sfpplus1", "comment": "Switch Uplink #1" }`. | `[ {"port":"sfp-sfpplus1","comment":"Switch Uplink #1"}, {"port":"sfp-sfpplus2","comment":"Switch Uplink #2"} ]` |
| `backhaul_links` | array<object> | Yes | Backhaul definitions `{ "port": "sfp-sfpplus4", "cidr": "x.x.x.x/yy", "comment": "REMOTE-SITE" }`. | `[ {"port":"sfp-sfpplus4","cidr":"10.247.93.76/29","comment":"IL-MATTOON-NO-1"} ]` |
| `bonding` | object | No | LACP bundle `{ "name": "bonding1", "slaves": ["sfp-sfpplus8","sfp-sfpplus9"], "lacp_user_key": 1, "policy": "layer-2-and-3" }`. | see example |
| `bonding_vlan_ids` | array<int> | No | VLAN IDs created on bonding (default `[1000,2000,3000,4000]`). | `[1000,2000,3000,4000]` |
| `vpls.domains` | array<object> | Yes | Domain VPLS entries `{ "name": "vpls1000-bng-ks", "bridge": "bridge1000", "peer": "10.254.247.3", "static_id": 1247 }`. | `[ {"name":"vpls1000-bng-ks","bridge":"bridge1000","peer":"10.254.247.3","static_id":1247} ]` |
| `vpls.mesh_links` | array<object> | No | Additional mesh peers `{ "name": "vpls-bng1", "bridge": "bridge9990", "peer": "10.254.247.3", "static_id": 3 }`. | `[ {"name":"vpls-bng1","bridge":"bridge9990","peer":"10.254.247.3","static_id":3} ]` |
| `mpls.ldp` | object | Yes | `{ "lsr_id": "loopback.ip", "transport_addresses": ["loopback.ip"], "mpls_mtu": 9000, "accept_filters": { "deny": [ ... ], "permit": [ ... ] } }`. | see example |
| `dns.servers` | array<string> | Yes | Compliance DNS pair. | `["142.147.112.3","142.147.112.19"]` |
| `snmp.community` | string | Yes | Compliance SNMP community. | `FBZ1yYdphf` |
| `dhcp.option43_hex` | string | No | Option 43 hex blob (omit if unused). | `0x011768747470733a2f2f7573732e6e786c696e6b2e636f6d2f` |
| `bgp` | object | No | `{ "asn": 26077, "router_id": "loopback.ip", "peers": [ {"name":"BNG-IL","remote_as":26077,"remote_address":"10.254.247.3","md5":"secret"} ] }`. | see example |
| `firewall.overrides` | object | No | Extra address-lists/filters appended after compliance. | `{ "address_lists": [ {"list":"mgmt-allow","address":"192.0.2.0/24"} ] }` |

## Baseline Components

## Port Role Standards
- Follow 
extlink-internet-policy.md for port assignments:
  - ether1 is always management/out-of-band.
  - sfp-sfpplus1 and sfp-sfpplus2 provide switch uplinks and integrate with ridge9990 MSTP.
  - sfp-sfpplus4+ support backhaul links in ascending order.
  - Reserve sfp-sfpplus6 for LTE and sfp-sfpplus6-8 for Tarana when deployed.
  - Keep comment= annotations aligned with role expectations for audit visibility.
- Confirm bridge membership matches IL MSTP design (ridge9990 vs domain bridges 1000/2000/3000/4000).

## Critical Parameter Usage Map

### Loopback (`loopback.ip`)
- `/ip address add address={loopback.ip}/32 interface=loop0 network={loopback.ip}`
- `/routing ospf instance add name=default-v2 router-id={loopback.ip}`
- Optional BGP template/peers set router ID and local address to `{loopback.ip}`
- `/system logging action add name=syslog remote={syslog.ip} src-address={loopback.ip}`
- `/mpls ldp add lsr-id={loopback.ip} transport-addresses={loopback.ip}`

### Switch Uplinks (`switch_uplinks`)
- Configure comments and MTUs, then attach to `bridge9990` or other mesh bridges if required.

### Backhaul Links (`backhaul_links`)
- Set interface comments and MTUs, then assign addressing with correct `network=` values.

### Bonding (`bonding`, `bonding_vlan_ids`)
- When enabled, create bonding interface and VLAN subinterfaces for each domain.
- Attach VLAN interfaces to corresponding bridges with `ingress-filtering=no edge=yes horizon=1`.

### VPLS (`vpls.domains`, `vpls.mesh_links`)
- Create VPLS interfaces using provided names, peers, static IDs, and optional comments.
- Attach to target bridges using `/interface bridge port` with split-horizon enabled.

### MPLS / LDP (`mpls.ldp`)
- Add global MPLS interface and LDP instance.
- Iterate deny prefixes first, then permit prefixes when building accept-filters.

### DNS & Syslog (`dns.servers`, `syslog.ip`)
- `/ip dns set servers={dns.servers[0]},{dns.servers[1]}`
- Syslog action uses loopback source and remote IP input.

### SNMP (`snmp.community`)
- Remove default community and add new compliance community with global scope unless specified otherwise.


### Firewall Overrides (`firewall.overrides`)
- Append extra address-lists/filters after compliance sections, ensuring no duplication of standard entries.

## Firewall Baseline
- Adopt the statewide firewall posture in concert with RFC-09-10-25 compliance:
  - Input chain permits established/related/untracked flows, MikroTik discovery (UDP 5678), MAC Telnet (UDP 20561), IGMP, ICMP, DHCPv4/v6, OSPF, LDP, manager IP list, BGP (TCP 179), and SNMP prior to dropping remaining packets.
  - Forward chain allows BGP and GRE between 10.0.0.0/8 networks, fasttracks valid sessions, then drops `unauth` traffic outside the walled garden list.
  - NAT rules must include SSH redirect (TCP 5022 to 22) and unauth proxy redirection (TCP 80 to 107.178.15.27:3128) alongside site-specific NAT entries.
  - Raw table drops UDP port 0 to mitigate malformed traffic.
- Any entries supplied via `firewall.overrides` should append after these baseline rules without duplication.

## Compliance Requirements
- Apply RFC-09-10-25 services, firewall address-lists/filter/nat/raw rules, SNMP cleanup, NTP client, and system watchdog/routerboard configurations.
- Ensure compliance DNS servers (142.147.112.3 and 142.147.112.19) are set exactly once.
- Avoid duplicate compliance blocks; rely on backend normalization to deduplicate.

## Output Assembly Order
1. `/interface bridge` definitions and `/interface ethernet` role assignments
2. Optional `/interface bonding` and `/interface vlan` sections
3. `/interface vpls` definitions and comments
4. `/interface bridge port` mappings for uplinks, VPLS interfaces, and VLANs
5. `/ip address` entries (loopback, backhauls, VLANs)
6. DHCP option/pool/network configuration (if provided)
7. `/ip dns`, `/system logging action`, `/ip service`
8. `/routing ospf` and optional `/routing bgp`
9. `/mpls interface`, `/mpls ldp`, `/mpls ldp accept-filter`
10. `/ip firewall address-list`, `/ip firewall filter`, `/ip firewall nat`, `/ip firewall raw`
11. `/snmp community`, `/system logging`, `/system watchdog`, `/system routerboard settings`

## Validation Checklist
- Loopback IP used in address, OSPF router ID, syslog action, LDP configuration, and optional BGP peers.
- Switch uplinks carry provided comments and join the correct bridge when required.
- Backhaul networks use correct `network=` values derived from input CIDRs.
- Bonding (if enabled) contains all VLAN interfaces and bridge assignments for each domain.
- VPLS entries exist with correct bridges, peers, and static IDs.
- MPLS LDP accept-filters list deny prefixes before permit prefixes according to input.
- DNS servers match the compliance pair.
- Compliance components appear once (services, firewall, SNMP, NTP).
- Optional BGP peers match provided remote AS, address, and security settings.

## Generation Instructions (LLM)
1. Read inputs that match the schema above.
2. Produce the RouterOS configuration following the Output Assembly Order.
3. Prefer RouterOS 7.x syntax; fall back to legacy commands only if `routeros_version` requires it.
4. Enforce compliance, port roles, and avoid duplicate commands (normalization runs afterwards).
5. Output plain RouterOS CLI with one command per line, preserving important `comment=` annotations.