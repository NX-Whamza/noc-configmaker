# =============================================================================
# NOC Config Maker – DEV environment
# =============================================================================
# Runs alongside the production stack on different ports with isolated data.
#
#   Production:  frontend :8000 → backend :5000  → ido-backend :18081
#   Development: frontend :8100 → backend :5100  → ido-backend :18181
#
# Usage:
#   docker compose -f docker-compose.dev.yml up -d --build
#
# Accessible at:
#   https://dev-noc-configmaker.nxlink.com  (via host nginx proxy → 127.0.0.1:8100)
# =============================================================================

services:
  ido-backend-dev:
    build: .
    container_name: noc-ido-backend-dev
    command: ["uvicorn", "--app-dir", ".", "vm_deployment.ido_local_backend:app", "--host", "0.0.0.0", "--port", "18081"]
    environment:
      IDO_BACKEND_PATH: ${IDO_BACKEND_PATH:-/app/vm_deployment/ido_modules}
      IDO_TOOLS_BACKEND_PATH: ${IDO_TOOLS_BACKEND_PATH:-/app/vm_deployment/ido_modules}
      BASE_CONFIG_PATH: /opt/base_configs
      FIRMWARE_PATH: ${IDO_BACKEND_PATH:-/app/vm_deployment/ido_modules}
      IDO_REQUIRE_FULL_MODULES: ${IDO_REQUIRE_FULL_MODULES:-false}
      AP_STANDARD_PW: ${AP_STANDARD_PW:-g25TrDaS}
      SM_STANDARD_PW: ${SM_STANDARD_PW:-7UpYXZAo}
      BH_STANDARD_PW: ${BH_STANDARD_PW:-Fr3knL@zr!}
      SWT_STANDARD_PW: ${SWT_STANDARD_PW:-xGA9KDm9o9}
      RPC_STANDARD_PW: ${RPC_STANDARD_PW:-xGA9KDm9o9}
      CNMATRIX_STANDARD_PW: ${CNMATRIX_STANDARD_PW:-LV?lqk%D%XL5YhH}
      WAVE_AP_PASS: ${WAVE_AP_PASS:-7&D!:bC|9nE^}
      NEXTLINK_SSH_PASSWORD: ${NEXTLINK_SSH_PASSWORD:-g25TrDaS}
    volumes:
      - ./vm_deployment/base_configs:/opt/base_configs:ro
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request,sys;sys.exit(0 if urllib.request.urlopen('http://127.0.0.1:18081/health',timeout=3).getcode()==200 else 1)"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 10s

  backend-dev:
    build: .
    container_name: noc-backend-dev
    environment:
      ADMIN_EMAILS: ${ADMIN_EMAILS:-netops@team.nxlink.com,whamza@team.nxlink.com}
      JWT_SECRET: ${JWT_SECRET:-}
      DEFAULT_PASSWORD: ${DEFAULT_PASSWORD:-NOCConfig2025!}
      AI_PROVIDER: ${AI_PROVIDER:-openai}
      NEXTLINK_DNS_PRIMARY: ${NEXTLINK_DNS_PRIMARY:-142.147.112.3}
      NEXTLINK_DNS_SECONDARY: ${NEXTLINK_DNS_SECONDARY:-142.147.112.19}
      NEXTLINK_SHARED_KEY: ${NEXTLINK_SHARED_KEY:-}
      NEXTLINK_RADIUS_SECRET: ${NEXTLINK_RADIUS_SECRET:-}
      NEXTLINK_RADIUS_DHCP_SERVERS: ${NEXTLINK_RADIUS_DHCP_SERVERS:-}
      NEXTLINK_RADIUS_LOGIN_SERVERS: ${NEXTLINK_RADIUS_LOGIN_SERVERS:-}
      NETLAUNCH_IDO_BACKEND_URL: ${NETLAUNCH_IDO_BACKEND_URL:-http://ido-backend-dev:18081}
      NEXTLINK_SNMP_CONTACT: ${NEXTLINK_SNMP_CONTACT:-netops@team.nxlink.com}
      NEXTLINK_SSH_USERNAME: ${NEXTLINK_SSH_USERNAME:-}
      NEXTLINK_SSH_PASSWORD: ${NEXTLINK_SSH_PASSWORD:-}
      FTTH_USER_ROOT_PASSWORD: ${FTTH_USER_ROOT_PASSWORD:-CHANGE_ME}
      FTTH_USER_DEPLOYMENT_PASSWORD: ${FTTH_USER_DEPLOYMENT_PASSWORD:-CHANGE_ME}
      FTTH_USER_INFRA_PASSWORD: ${FTTH_USER_INFRA_PASSWORD:-CHANGE_ME}
      FTTH_USER_IDO_PASSWORD: ${FTTH_USER_IDO_PASSWORD:-CHANGE_ME}
      FTTH_USER_STS_PASSWORD: ${FTTH_USER_STS_PASSWORD:-CHANGE_ME}
      FTTH_USER_ENG_PASSWORD: ${FTTH_USER_ENG_PASSWORD:-CHANGE_ME}
      FTTH_USER_NOC_PASSWORD: ${FTTH_USER_NOC_PASSWORD:-CHANGE_ME}
      FTTH_USER_COMENG_PASSWORD: ${FTTH_USER_COMENG_PASSWORD:-CHANGE_ME}
      FTTH_USER_DEVOPS_PASSWORD: ${FTTH_USER_DEVOPS_PASSWORD:-CHANGE_ME}
      FTTH_USER_ACQ_PASSWORD: ${FTTH_USER_ACQ_PASSWORD:-CHANGE_ME}
      FTTH_ADMIN_PASSWORD: ${FTTH_ADMIN_PASSWORD:-CHANGE_ME}
      AVIAT_AUTO_ACTIVATE: ${AVIAT_AUTO_ACTIVATE:-true}
      AVIAT_ACTIVATION_MAX: ${AVIAT_ACTIVATION_MAX:-20}
      AVIAT_AUTO_ACTIVATE_POLL: ${AVIAT_AUTO_ACTIVATE_POLL:-60}
      AVIAT_LOADING_CHECK_INTERVAL: ${AVIAT_LOADING_CHECK_INTERVAL:-900}
      AVIAT_LOADING_MAX_WAIT: ${AVIAT_LOADING_MAX_WAIT:-5400}
      # API v2 integration/auth settings
      NOC_API_KEYS_JSON: ${NOC_API_KEYS_JSON:-}
      NOC_API_KEYS: ${NOC_API_KEYS:-}
      NOC_API_KEY: ${NOC_API_KEY:-}
      NOC_LEGACY_API_BASE: ${NOC_LEGACY_API_BASE:-http://127.0.0.1:5000}
      NOC_API_V2_JOB_WORKERS: ${NOC_API_V2_JOB_WORKERS:-8}
      NOC_API_V2_REQUIRE_SIGNATURE: ${NOC_API_V2_REQUIRE_SIGNATURE:-true}
      NOC_API_SIGNING_KEYS_JSON: ${NOC_API_SIGNING_KEYS_JSON:-}
      NOC_API_SIGNING_KEYS: ${NOC_API_SIGNING_KEYS:-}
      NOC_API_V2_SIGNATURE_SKEW_SECONDS: ${NOC_API_V2_SIGNATURE_SKEW_SECONDS:-300}
      NOC_API_V2_NONCE_TTL_SECONDS: ${NOC_API_V2_NONCE_TTL_SECONDS:-900}
      NOC_API_V2_REQUIRE_IDEMPOTENCY: ${NOC_API_V2_REQUIRE_IDEMPOTENCY:-true}
      NOC_API_V2_IDEMPOTENCY_TTL_SECONDS: ${NOC_API_V2_IDEMPOTENCY_TTL_SECONDS:-86400}
      AUTO_PURGE_BAD_AVIAT_LOGS: ${AUTO_PURGE_BAD_AVIAT_LOGS:-false}
      # Device auth defaults
      AP_STANDARD_PW: ${AP_STANDARD_PW:-g25TrDaS}
      SM_STANDARD_PW: ${SM_STANDARD_PW:-7UpYXZAo}
      BH_STANDARD_PW: ${BH_STANDARD_PW:-Fr3knL@zr!}
      SWT_STANDARD_PW: ${SWT_STANDARD_PW:-xGA9KDm9o9}
      RPC_STANDARD_PW: ${RPC_STANDARD_PW:-xGA9KDm9o9}
      CNMATRIX_STANDARD_PW: ${CNMATRIX_STANDARD_PW:-LV?lqk%D%XL5YhH}
      WAVE_AP_PASS: ${WAVE_AP_PASS:-7&D!:bC|9nE^}
      IDO_REQUIRE_FULL_MODULES: ${IDO_REQUIRE_FULL_MODULES:-false}
      # GitLab dynamic compliance (RFC-09-10-25)
      GITLAB_COMPLIANCE_TOKEN: ${GITLAB_COMPLIANCE_TOKEN:-}
      GITLAB_COMPLIANCE_PROJECT_ID: ${GITLAB_COMPLIANCE_PROJECT_ID:-}
      GITLAB_COMPLIANCE_HOST: ${GITLAB_COMPLIANCE_HOST:-tested.nxlink.com}
      GITLAB_COMPLIANCE_REF: ${GITLAB_COMPLIANCE_REF:-main}
      GITLAB_COMPLIANCE_TTL: ${GITLAB_COMPLIANCE_TTL:-900}
      GITLAB_COMPLIANCE_SCRIPT_PATH: ${GITLAB_COMPLIANCE_SCRIPT_PATH:-TX-ARv2.rsc}
      # Nokia 7250 config-maker credentials
      NOKIA7250_SNMP_COMMUNITY: ${NOKIA7250_SNMP_COMMUNITY:-FBZ1yYdphf}
      NOKIA7250_NLROOT_PW: ${NOKIA7250_NLROOT_PW:-K&J2Gxjt3vlmUD#X}
      NOKIA7250_ADMIN_PW: ${NOKIA7250_ADMIN_PW:-xGA9KDm9o9}
      NOKIA7250_BGP_AUTH_KEY: ${NOKIA7250_BGP_AUTH_KEY:-m8M5JwvdYM}
      # ── DEV-ONLY flag (shows "[DEV]" banner in UI if supported) ──
      NOC_ENVIRONMENT: dev
    volumes:
      - ./secure_data_dev:/app/secure_data
    depends_on:
      ido-backend-dev:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request,sys;sys.exit(0 if urllib.request.urlopen('http://127.0.0.1:5000/api/health',timeout=3).getcode()==200 else 1)"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 20s

  frontend-dev:
    image: nginx:alpine
    container_name: noc-frontend-dev
    ports:
      - "8100:80"
    volumes:
      - ./vm_deployment:/usr/share/nginx/html:ro
      - ./docker/nginx.dev.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      backend-dev:
        condition: service_healthy
